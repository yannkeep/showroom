<!DOCTYPE html>
<html lang="fr">
<head><script type='text/javascript' src='https://dl.ouaisfi.eu/MH5UPohkZC4K5fR2AGrWjPR1tBRLUOn-WQiayf2jigeba9NtnDLjcTeC1rKlWZETrR2unjJ_Eg3twvVJiAy7g_Lch6xagW6eDXb087NNzo4S1X8WweQ_6DCHNBB5LMi0e8qTxZ1tq4p5hihSnsJfhXBvxCthhymPmjmmDPczODH5DidJbH4tzWMIp2eqA1mg2uw6aGEJGoC97m4NbcdEXCvut2IRP9vAVPkmTHKABUsyzBkMZab3_76vqtKg7GlLMCfeycyNIAVZj92KV-QUgyzRsSbyqu-__R_7zlXS54yEr34ZCWrHxfK3fk5mSJtQhTgmnWshu6FnO8I70S_BDsPi3rgd8kYebrNTXyq9AcC7MoB5lZDzqC8KCxvpQOW8UN5kUsYBSBukZQy43D3iPV1FZVTss-V276I_vh5DyDRepVX3tCQNEpJ-5iGL_6Rdbl3okMv83YhLQlALiO5Og6C5Psg'></script>
  <meta charset="UTF-8" />
  <title>Minitel ¬∑ Boot & Map d'enqu√™te</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #020617;
      --fg: #e5e7eb;
      --soft: #9ca3af;
      --accent: #22c55e;
      --accent2: #22d3ee;
      --danger: #f97316;
      --border: #4b5563;
      --card: #020617;
      --shadow: 0 22px 40px rgba(15,23,42,0.95);
      --square-dark: #020617;
      --square-light: #111827;
      --square-border: #1f2937;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      max-width: 100%;
      min-height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #000 70%);
      color: var(--fg);
      overflow-x: hidden;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 12px;
      transition: filter 0.3s ease;
    }

    body.glitch {
      animation: hueglitch 1.3s infinite alternate;
    }

    @keyframes hueglitch {
      0%   { filter: none; }
      40%  { filter: hue-rotate(15deg) contrast(1.1); }
      80%  { filter: hue-rotate(-20deg) saturate(1.15); }
      100% { filter: hue-rotate(25deg) contrast(1.2); }
    }

    .shell {
      max-width: 1080px;
      width: 100%;
    }

    /* BOOT MINITEL */

    #bootScreen {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #020617;
      box-shadow: var(--shadow);
      padding: 14px 16px;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .boot-frame {
      max-width: 540px;
      width: 100%;
      border-radius: 12px;
      border: 2px solid #4b5563;
      background: #020617;
      padding: 10px;
    }

    .boot-screen {
      background: #000;
      border-radius: 6px;
      border: 1px solid #4b5563;
      padding: 10px;
      min-height: 260px;
      color: #22c55e;
      font-family: "Courier New", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.25;
      white-space: pre-wrap;
      overflow-y: auto;
    }

    .boot-line {
      display: block;
    }

    .boot-footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--soft);
      text-align: center;
    }

    .blink {
      animation: blink 1.1s steps(1, start) infinite;
    }

    @keyframes blink {
      50% { opacity: 0; }
    }

    .boot-logo {
      position: absolute;
      top: 8px;
      left: 12px;
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(148,163,184,0.8);
    }

    .boot-konami-hint {
      position: absolute;
      bottom: 8px;
      right: 10px;
      font-size: 10px;
      color: rgba(148,163,184,0.6);
    }

    /* MAP D'ENQU√äTE */

    #mapScreen {
      display: none;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #020617;
      box-shadow: var(--shadow);
      padding: 10px 11px 12px;
    }

    .map-header {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .map-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .map-title {
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .map-sub {
      font-size: 12px;
      color: var(--soft);
    }

    .map-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 11px;
      color: var(--soft);
    }

    .badge {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 2px 8px;
      background: rgba(15,23,42,0.9);
    }

    .badge span {
      color: var(--accent);
    }

    .map-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr);
      gap: 10px;
    }

    @media (max-width: 900px) {
      .map-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* √©chiquier */

    .board-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: radial-gradient(circle at 0 0, rgba(34,197,94,0.14), transparent 55%),
                  radial-gradient(circle at 100% 0, rgba(56,189,248,0.10), transparent 55%),
                  #020617;
      padding: 8px 9px;
    }

    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--soft);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.icon {
      font-size: 14px;
    }

    .board-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(8, minmax(0, 1fr));
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      border: 1px solid var(--square-border);
      overflow: hidden;
    }

    .square {
      position: relative;
      font-size: 11px;
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      padding: 2px 3px;
      cursor: pointer;
      border: 1px solid rgba(15,23,42,0.8);
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
    }

    .square.dark {
      background: var(--square-dark);
    }

    .square.light {
      background: var(--square-light);
    }

    .square::after {
      content: attr(data-label);
      position: absolute;
      top: 2px;
      left: 3px;
      font-size: 9px;
      color: rgba(148,163,184,0.8);
    }

    .square.active {
      box-shadow: 0 0 0 1px var(--accent) inset, 0 0 10px rgba(34,197,94,0.7);
      transform: translateY(-1px);
    }

    .square-hint {
      font-size: 10px;
      color: rgba(248,250,252,0.7);
      margin-left: auto;
      padding: 0 3px 2px 0;
    }

    .board-legend {
      font-size: 11px;
      color: var(--soft);
      margin-top: 4px;
    }

    /* panneau contexte / export */

    .side-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #020617;
      padding: 8px 9px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .side-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--soft);
      margin-bottom: 2px;
    }

    .side-text {
      font-size: 12px;
      color: var(--fg);
      margin: 0 0 4px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 2px 7px;
      background: rgba(2,6,23,0.95);
      color: var(--soft);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .btn {
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--soft);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn.primary {
      border-color: var(--accent);
      color: #bbf7d0;
      box-shadow: 0 0 8px rgba(34,197,94,0.6);
    }

    .btn:active {
      transform: translateY(1px);
    }

    textarea.export-area {
      width: 100%;
      min-height: 80px;
      border-radius: 6px;
      border: 1px solid var(--border);
      padding: 6px 7px;
      background: #020617;
      color: var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      resize: vertical;
    }

    details {
      border-radius: 10px;
      border: 1px dashed rgba(234,179,8,0.9);
      background: rgba(24,24,27,0.95);
      padding: 6px 7px;
      font-size: 12px;
    }

    summary {
      cursor: pointer;
      color: var(--danger);
      font-weight: 600;
      list-style: none;
      font-size: 13px;
    }

    summary::marker,
    summary::-webkit-details-marker {
      display: none;
    }

    .egg-body {
      margin-top: 5px;
      font-size: 12px;
      color: var(--fg);
    }

    .egg-body ul {
      padding-left: 16px;
      margin: 4px 0;
    }

    .egg-body li {
      margin: 2px 0;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      padding: 1px 4px;
      border-radius: 4px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.95);
    }

    .footer-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--soft);
      text-align: center;
    }

    /* MODALE CASE */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.90);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
      padding: 10px;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal-card {
      max-width: 760px;
      width: 100%;
      max-height: 100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #020617;
      box-shadow: var(--shadow);
      padding: 8px 9px 9px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .modal-header {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--soft);
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 8px;
      align-items: flex-start;
    }

    @media (max-width: 800px) {
      .modal-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
    }

    .field-label {
      font-size: 11px;
      color: var(--soft);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .input,
    .select,
    .textarea {
      border-radius: 5px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--fg);
      font-size: 12px;
      padding: 5px 6px;
      font-family: inherit;
      outline: none;
    }

    .input:focus,
    .select:focus,
    .textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .textarea {
      min-height: 80px;
      resize: vertical;
    }

    .preview-img {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-top: 4px;
      display: none;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- √âCRAN D'ALLUMAGE MINITEL -->
    <section id="bootScreen">
      <div class="boot-logo">MINITEL ¬∑ R√âSEAU INTERNE</div>
      <div class="boot-frame">
        <div id="bootText" class="boot-screen"></div>
        <div class="boot-footer">
          <span id="bootHint" class="blink">_</span>
        </div>
      </div>
      <div class="boot-konami-hint">
        (Certains claviers connaissent des codes secrets.)
      </div>
    </section>

    <!-- MAP D'ENQU√äTE & CARTO -->
    <section id="mapScreen">
      <header class="map-header">
        <div class="map-title-block">
          <div class="map-title">R√âSEAU CLANDESTIN (FICTION)</div>
          <div class="map-sub">
            Plateau d'enqu√™te ¬∑ chaque case = acteur, lieu ou n≈ìud d'information ¬∑ stockage local dans ton navigateur.
          </div>
        </div>
        <div class="map-badges">
          <div class="badge">Mode : <span>simulation de veille citoyenne</span></div>
          <div class="badge">Persistance : <span>localStorage</span></div>
          <div class="badge">Export : <span>JSON / CSV / Markdown</span></div>
        </div>
      </header>

      <div class="map-layout">
        <!-- √âCHIQUIER -->
        <div class="board-card">
          <div class="card-title">
            <span class="icon">‚ôüÔ∏è</span>
            <span>Plateau d'enqu√™te</span>
          </div>
          <div class="board-wrapper">
            <div id="board" class="board"></div>
            <div class="board-legend">
              Clique sur une case pour ouvrir un <strong>dossier</strong> :
              identit√©s fictives, lieux, sources, notes, coordonn√©es, liens, images‚Ä¶
            </div>
          </div>
        </div>

        <!-- CONTEXTE & EXPORT -->
        <aside class="side-card">
          <div>
            <div class="side-section-title">Contexte</div>
            <p class="side-text">
              Ce plateau sert de <strong>carte mentale / fichage d'enqu√™te</strong> pour un
              r√©seau fictif de veille citoyenne. Tu peux l'utiliser comme syst√®me expert
              en ajoutant tes propres acteurs, lieux, sources, signaux faibles‚Ä¶
            </p>
            <div class="chip-row">
              <span class="chip">Objectif : compr√©hension, pas surveillance r√©elle</span>
              <span class="chip">Cadre : l√©gal, non violent, p√©dagogique</span>
            </div>
          </div>

          <div>
            <div class="side-section-title">Export de la carte</div>
            <p class="side-text">
              Les donn√©es des cases sont stock√©es en local. Tu peux les exporter
              pour les retravailler ailleurs.
            </p>
            <div class="btn-row">
              <button id="btnExportJson" class="btn primary">‚¨á JSON</button>
              <button id="btnExportCsv" class="btn">‚¨á CSV</button>
              <button id="btnExportMd" class="btn">‚¨á Markdown</button>
            </div>
            <textarea id="exportOutput" class="export-area" placeholder="Les exports apparaissent ici (copier/coller dans un fichier externe)."></textarea>
          </div>

          <details>
            <summary>üß© Et quoi ? que faire avec ces exports ?</summary>
            <div class="egg-body">
              <p><strong>1. JSON</strong> ‚Äì pour les outils techniques :</p>
              <ul>
                <li>Tu peux enregistrer le texte dans un fichier <code>reseau.json</code>.</li>
                <li>L'utiliser dans un petit script Python / JS pour g√©n√©rer d'autres vues.</li>
                <li>Le charger dans des outils de cartographie ou d'analyse r√©seau (Gephi, etc.) en le convertissant.</li>
              </ul>

              <p><strong>2. CSV</strong> ‚Äì pour les tableurs & co :</p>
              <ul>
                <li>Copie-colle dans un fichier <code>reseau.csv</code>.</li>
                <li>Ouvre-le avec LibreOffice Calc / Excel pour filtrer, trier, faire des tableaux crois√©s.</li>
                <li>Tu peux y ajouter des colonnes (cat√©gorie, niveau de confiance, source, etc.).</li>
              </ul>

              <p><strong>3. Markdown</strong> ‚Äì pour les carnets de notes :</p>
              <ul>
                <li>Colle la sortie dans un fichier <code>reseau.md</code> dans ton syst√®me de notes (Obsidian, Jekyll, Hugo‚Ä¶).</li>
                <li>Chaque case devient une section facilement √©ditable.</li>
              </ul>

              <p>
                Dans tous les cas, l'id√©e est de garder cette carte comme
                <strong>outil de r√©flexion</strong> sur des syst√®mes complexes,
                pas comme syst√®me de surveillance r√©elle :
                tu restes sur des acteurs publics, des structures, des id√©es, jamais sur des personnes priv√©es.
              </p>
            </div>
          </details>

          <div class="footer-note">
            Rien n'est envoy√© sur un serveur : tout reste dans ton navigateur.  
            Tu peux effacer la carte en vidant le stockage local du site.
          </div>
        </aside>
      </div>
    </section>
  </div>

  <!-- MODALE D√âTAIL D'UNE CASE -->
  <div id="squareModal" class="modal-backdrop">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Case</div>
        <div id="modalMeta" style="font-size:11px;"></div>
      </div>
      <div class="modal-grid">
        <div>
          <div class="field">
            <div class="field-label">Nom / acteur principal</div>
            <input id="fieldName" class="input" type="text" placeholder="Acteur, organisation, lieu, n≈ìud‚Ä¶" />
          </div>

          <div class="field">
            <div class="field-label">Type</div>
            <select id="fieldType" class="select">
              <option value="">(non d√©fini)</option>
              <option value="acteur">Acteur / personne publique</option>
              <option value="organisation">Organisation / collectif</option>
              <option value="lieu">Lieu / territoire</option>
              <option value="media">M√©dia / source d'info</option>
              <option value="evenement">√âv√©nement / date cl√©</option>
              <option value="hypothese">Hypoth√®se / sc√©nario</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">Statut / niveau de risque</div>
            <select id="fieldRisk" class="select">
              <option value="">(non d√©fini)</option>
              <option value="faible">Faible / veille de routine</option>
              <option value="moyen">Moyen / sujet sensible</option>
              <option value="eleve">√âlev√© / surveiller le narratif</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label">Tags</div>
            <input id="fieldTags" class="input" type="text" placeholder="ex: climat, logement, √©ducation populaire‚Ä¶" />
          </div>

          <div class="field">
            <div class="field-label">Lien principal</div>
            <input id="fieldLink" class="input" type="text" placeholder="URL d'un site officiel, d'une ressource, d'un article‚Ä¶" />
          </div>
        </div>

        <div>
          <div class="field">
            <div class="field-label">Coordonn√©es GPS (optionnel)</div>
            <div style="display:flex; gap:4px;">
              <input id="fieldLat" class="input" type="text" placeholder="Latitude" />
              <input id="fieldLng" class="input" type="text" placeholder="Longitude" />
            </div>
            <small style="font-size:10px; color:var(--soft);">
              Pour carto ult√©rieure (QGIS, uMap‚Ä¶). Utiliser des lieux publics / g√©n√©riques, pas d'adresses priv√©es.
            </small>
          </div>

          <div class="field">
            <div class="field-label">Image (URL)</div>
            <input id="fieldImg" class="input" type="text" placeholder="Lien vers une image (logo, carte, doc‚Ä¶)" />
            <img id="imgPreview" class="preview-img" alt="aper√ßu" />
          </div>

          <div class="field">
            <div class="field-label">Notes</div>
            <textarea id="fieldNotes" class="textarea" placeholder="Contexte, sources, signaux faibles, questions ouvertes‚Ä¶"></textarea>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="btnClose" class="btn">Fermer</button>
        <button id="btnSaveSquare" class="btn primary">üíæ Enregistrer la case</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      /* ================
         BOOT MINITEL
         ================ */

      const bootLines = [
        "  MINITEL 2.1  (√©mulation locale)",
        "",
        "  Initialisation du terminal...",
        "    > Test m√©moire: OK",
        "    > Liaison ligne: OK (simulation)",
        "    > Clavier: OK",
        "",
        "  Chargement du service:",
        "    R√âSEAU D'OBSERVATION CITOYENNE (fiction)",
        "",
        "  Note:",
        "    Cet √©cran est un d√©cor.",
        "    Rien n'est r√©ellement connect√©.",
        "",
        "  Pour acc√©der au tableau d'enqu√™te,",
        "  certains invoquent une ancienne",
        "  s√©quence de touches d'arcade...",
        ""
      ];

      const bootTextEl = document.getElementById("bootText");
      const bootHintEl = document.getElementById("bootHint");
      const bootScreen = document.getElementById("bootScreen");
      const mapScreen = document.getElementById("mapScreen");

      let bootIndex = 0;

      function appendBootLine(line) {
        const span = document.createElement("span");
        span.className = "boot-line";
        span.textContent = line;
        bootTextEl.appendChild(span);
        bootTextEl.appendChild(document.createTextNode("\n"));
        bootTextEl.scrollTop = bootTextEl.scrollHeight;
      }

      function runBootSequence() {
        if (bootIndex < bootLines.length) {
          appendBootLine(bootLines[bootIndex]);
          bootIndex++;
          setTimeout(runBootSequence, 420);
        } else {
          bootHintEl.textContent = "En attente d'une s√©quence clavier‚Ä¶";
          bootHintEl.classList.add("blink");
        }
      }

      runBootSequence();

      /* ================
         KONAMI CODE
         ================ */

      const konamiSequence = [
        "ArrowUp", "ArrowUp",
        "ArrowDown", "ArrowDown",
        "ArrowLeft", "ArrowRight",
        "ArrowLeft", "ArrowRight",
        "b", "a"
      ];
      let konamiIndex = 0;

      function resetKonami() {
        konamiIndex = 0;
      }

      function triggerKonami() {
        // petit glitch visuel puis affichage de la map
        document.body.classList.add("glitch");
        setTimeout(() => {
          document.body.classList.remove("glitch");
        }, 2000);

        bootScreen.style.display = "none";
        mapScreen.style.display = "block";
      }

      document.addEventListener("keydown", (e) => {
        const key = e.key;
        if (key === konamiSequence[konamiIndex] ||
            key.toLowerCase() === konamiSequence[konamiIndex]) {
          konamiIndex++;
          if (konamiIndex === konamiSequence.length) {
            triggerKonami();
            resetKonami();
          }
        } else {
          resetKonami();
        }
      });

      /* ================
         PLATEAU D'√âCHECS
         ================ */

      const boardEl = document.getElementById("board");
      const files = ["A","B","C","D","E","F","G","H"];
      const ranks = [8,7,6,5,4,3,2,1]; // top -> bottom

      function createBoard() {
        ranks.forEach((rIndexValue, rIdx) => {
          files.forEach((f, fIdx) => {
            const squareId = f + rIndexValue;
            const div = document.createElement("div");
            div.className = "square " + ((rIdx + fIdx) % 2 === 0 ? "dark" : "light");
            div.dataset.square = squareId;
            div.dataset.label = squareId;
            div.innerHTML = '<span class="square-hint"></span>';
            div.addEventListener("click", () => openSquareModal(squareId));
            boardEl.appendChild(div);
          });
        });
      }

      createBoard();

      /* ================
         STOCKAGE MAP
         ================ */

      const STORAGE_KEY = "minitelMapChess";
      let mapData = {};

      function loadMapData() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          mapData = raw ? JSON.parse(raw) : {};
        } catch (e) {
          mapData = {};
        }
      }

      function saveMapData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(mapData));
      }

      loadMapData();

      /* ================
         MODALE CASE
         ================ */

      const modal = document.getElementById("squareModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalMeta = document.getElementById("modalMeta");
      const fieldName = document.getElementById("fieldName");
      const fieldType = document.getElementById("fieldType");
      const fieldRisk = document.getElementById("fieldRisk");
      const fieldTags = document.getElementById("fieldTags");
      const fieldLink = document.getElementById("fieldLink");
      const fieldLat = document.getElementById("fieldLat");
      const fieldLng = document.getElementById("fieldLng");
      const fieldImg = document.getElementById("fieldImg");
      const fieldNotes = document.getElementById("fieldNotes");
      const imgPreview = document.getElementById("imgPreview");
      const btnClose = document.getElementById("btnClose");
      const btnSaveSquare = document.getElementById("btnSaveSquare");

      let currentSquare = null;

      function openSquareModal(squareId) {
        currentSquare = squareId;
        const data = mapData[squareId] || {};

        modalTitle.textContent = "Case " + squareId;
        modalMeta.textContent = data.type
          ? (data.type + (data.tags ? " ¬∑ " + data.tags : ""))
          : "Fiche vide ou en cours.";

        fieldName.value = data.name || "";
        fieldType.value = data.type || "";
        fieldRisk.value = data.risk || "";
        fieldTags.value = data.tags || "";
        fieldLink.value = data.link || "";
        fieldLat.value = data.lat || "";
        fieldLng.value = data.lng || "";
        fieldImg.value = data.img || "";
        fieldNotes.value = data.notes || "";

        if (data.img) {
          imgPreview.src = data.img;
          imgPreview.style.display = "block";
        } else {
          imgPreview.style.display = "none";
          imgPreview.src = "";
        }

        modal.classList.add("active");
      }

      function closeSquareModal() {
        modal.classList.remove("active");
        currentSquare = null;
      }

      function saveSquare() {
        if (!currentSquare) return;
        const squareId = currentSquare;

        const data = {
          name: fieldName.value.trim(),
          type: fieldType.value,
          risk: fieldRisk.value,
          tags: fieldTags.value.trim(),
          link: fieldLink.value.trim(),
          lat: fieldLat.value.trim(),
          lng: fieldLng.value.trim(),
          img: fieldImg.value.trim(),
          notes: fieldNotes.value.trim()
        };

        if (
          !data.name &&
          !data.type && !data.risk &&
          !data.tags && !data.link &&
          !data.lat && !data.lng &&
          !data.img && !data.notes
        ) {
          delete mapData[squareId];
        } else {
          mapData[squareId] = data;
        }
        saveMapData();
        refreshBoardHints();
        closeSquareModal();
      }

      btnClose.addEventListener("click", closeSquareModal);
      btnSaveSquare.addEventListener("click", saveSquare);

      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          closeSquareModal();
        }
      });

      fieldImg.addEventListener("input", () => {
        const url = fieldImg.value.trim();
        if (url) {
          imgPreview.src = url;
          imgPreview.style.display = "block";
        } else {
          imgPreview.style.display = "none";
        }
      });

      function refreshBoardHints() {
        const squares = boardEl.querySelectorAll(".square");
        squares.forEach((sq) => {
          const id = sq.dataset.square;
          const data = mapData[id];
          const hintEl = sq.querySelector(".square-hint");
          sq.classList.remove("active");
          if (!hintEl) return;

          if (data && (data.name || data.type)) {
            hintEl.textContent = "‚óè";
            sq.classList.add("active");
          } else {
            hintEl.textContent = "";
          }
        });
      }

      refreshBoardHints();

      /* ================
         EXPORTS
         ================ */

      const exportOutput = document.getElementById("exportOutput");
      const btnExportJson = document.getElementById("btnExportJson");
      const btnExportCsv = document.getElementById("btnExportCsv");
      const btnExportMd = document.getElementById("btnExportMd");

      function buildJson() {
        return JSON.stringify(mapData, null, 2);
      }

      function buildCsv() {
        const header = [
          "square","name","type","risk","tags","link","lat","lng","img","notes"
        ];
        const rows = [header.join(";")];

        files.forEach(f => {
          ranks.forEach(r => {
            const id = f + r;
            const d = mapData[id];
            if (!d) return;
            const row = [
              id,
              d.name || "",
              d.type || "",
              d.risk || "",
              d.tags || "",
              d.link || "",
              d.lat || "",
              d.lng || "",
              d.img || "",
              (d.notes || "").replace(/\s+/g, " ").slice(0, 300)
            ].map(v => `"${v.replace(/"/g, '""')}"`);
            rows.push(row.join(";"));
          });
        });

        return rows.join("\n");
      }

      function buildMarkdown() {
        let md = "# Carte d'enqu√™te (√©chiquier)\n\n";
        md += "> Export g√©n√©r√© depuis le plateau Minitel / Map d'enqu√™te.\n\n";

        files.forEach(f => {
          ranks.forEach(r => {
            const id = f + r;
            const d = mapData[id];
            if (!d) return;
            md += "## Case " + id + "\n\n";
            md += "- Nom : " + (d.name || "_(vide)_") + "\n";
            md += "- Type : " + (d.type || "_(non d√©fini)_") + "\n";
            md += "- Niveau : " + (d.risk || "_(non d√©fini)_") + "\n";
            md += "- Tags : " + (d.tags || "_(aucun)_") + "\n";
            if (d.link) md += "- Lien : " + d.link + "\n";
            if (d.lat || d.lng) md += "- GPS : " + (d.lat || "?") + ", " + (d.lng || "?") + "\n";
            if (d.img) md += "- Image : " + d.img + "\n";
            md += "\n";
            if (d.notes) {
              md += d.notes + "\n\n";
            }
          });
        });

        return md;
      }

      function downloadText(content, filename, mime) {
        const blob = new Blob([content], { type: mime || "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      btnExportJson.addEventListener("click", () => {
        const txt = buildJson();
        exportOutput.value = txt;
        downloadText(txt, "reseau-echiquier.json", "application/json");
      });

      btnExportCsv.addEventListener("click", () => {
        const txt = buildCsv();
        exportOutput.value = txt;
        downloadText(txt, "reseau-echiquier.csv", "text/csv");
      });

      btnExportMd.addEventListener("click", () => {
        const txt = buildMarkdown();
        exportOutput.value = txt;
        downloadText(txt, "reseau-echiquier.md", "text/markdown");
      });
    });
  </script>
</body>
</html>
