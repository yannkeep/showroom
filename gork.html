
<!DOCTYPE html>
<!-- saved from url=(0075)https://yannkeep.github.io/test/1160/ccplc/office/bureau/stic-anarchie.html -->
<html lang="fr" prefix="og: https://ogp.me/ns#" itemscope="" itemtype="https://schema.org/WebApplication"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         #B!Mi â€” PLAIDOYER CITOYEN ULTIMATE v4.4 PWA
         Poste de Travail pour la Participation Citoyenne et l'Ã‰ducation Populaire
         Fusion des meilleures fonctionnalitÃ©s â€¢ Mode Sombre RÃ©tro Geek
         Licence: Creative Commons BY-NC-SA 4.0
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO Meta Tags -->
    <title>#B!Mi â€” Plaidoyer Citoyen | Poste de Travail pour le Changement Social</title>
    <meta name="description" content="Poste de travail numÃ©rique gratuit pour construire votre stratÃ©gie de plaidoyer citoyen. 15 outils mÃ©thodologiques Voir-Juger-Agir. Import/Export multiformats. Fonctionne hors-ligne.">
    <meta name="keywords" content="plaidoyer citoyen, participation citoyenne, dÃ©mocratie participative, Ã©ducation populaire, voir juger agir, advocacy, changement social, Belgique, sÃ©curitÃ© sociale">
    <meta name="author" content="#B!Mi Collective">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://yannkeep.github.io/plaidoyer/app/index.html">
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PWA - PROGRESSIVE WEB APP
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a2e">
    <meta name="background-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="#B!Mi Plaidoyer">
    <meta name="application-name" content="#B!Mi Plaidoyer">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest (inline) -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIiNCIU1pIFBsYWlkb3llciBDaXRveWVuIiwKICAic2hvcnRfbmFtZSI6ICJQbGFpZG95ZXIiLAogICJkZXNjcmlwdGlvbiI6ICJQb3N0ZSBkZSB0cmF2YWlsIG51bcOpcmlxdWUgcG91ciBjb25zdHJ1aXJlIHZvdHJlIHN0cmF0w6lnaWUgZGUgcGxhaWRveWVyIGNpdG95ZW4iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzFhMWEyZSIsCiAgInRoZW1lX2NvbG9yIjogIiMxYTFhMmUiLAogICJvcmllbnRhdGlvbiI6ICJhbnkiLAogICJjYXRlZ29yaWVzIjogWyJwcm9kdWN0aXZpdHkiLCAidXRpbGl0aWVzIiwgImVkdWNhdGlvbiJdLAogICJsYW5nIjogImZyIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA1MTIgNTEyJyUzRSUzQ3JlY3Qgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIGZpbGw9JyUyMzFhMWEyZSclMkYlM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1zaXplPScyNTAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGR5PScuMzVlbSclM0UlRjAlOUYlOTclQjMlRUYlQjglOEYlM0MlMkZ0ZXh0JTNFJTNDJTJGc3ZnJTNFIiwKICAgICAgInNpemVzIjogImFueSIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXSwKICAic2NyZWVuc2hvdHMiOiBbXSwKICAic2hvcnRjdXRzIjogWwogICAgewogICAgICAibmFtZSI6ICJOb3V2ZWF1IHByb2pldCIsCiAgICAgICJ1cmwiOiAiLj9hY3Rpb249bmV3IiwKICAgICAgImljb25zIjogW3sic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMjQgMjQnJTNFJTNDdGV4dCB4PSc1MCUyNScgeT0nNTAlMjUnIGZvbnQtc2l6ZT0nMjAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGR5PScuMzVlbSclM0UlRTIlOUUlOTUlM0MlMkZ0ZXh0JTNFJTNDJTJGc3ZnJTNFIiwgInNpemVzIjogIjk2eDk2In1dCiAgICB9CiAgXQp9">
    
    <!-- IcÃ´nes PWA (SVG inline) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%231a1a2e'/%3E%3Ctext x='50%25' y='50%25' font-size='250' text-anchor='middle' dy='.35em'%3EğŸ—³ï¸%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%231a1a2e' rx='90'/%3E%3Ctext x='50%25' y='50%25' font-size='250' text-anchor='middle' dy='.35em'%3EğŸ—³ï¸%3C/text%3E%3C/svg%3E">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yannkeep.github.io/plaidoyer/app/index.html">
    <meta property="og:title" content="#B!Mi â€” Plaidoyer Citoyen">
    <meta property="og:description" content="15 outils gratuits pour construire votre stratÃ©gie de changement social.">
    <meta property="og:locale" content="fr_BE">
    <meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3Crect width='1200' height='630' fill='%231a1a2e'/%3E%3Ctext x='50%25' y='40%25' font-size='120' text-anchor='middle' fill='%2348bb78'%3EğŸ—³ï¸ %23B!Mi%3C/text%3E%3Ctext x='50%25' y='65%25' font-size='60' text-anchor='middle' fill='%23e8e8f0'%3EPlaidoyer Citoyen%3C/text%3E%3C/svg%3E">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./plaidoyer-v-ok_files/css2" rel="stylesheet">
    
    <!-- DOCX Generation Library -->
    <script type='text/javascript' src='https://yannkeep.github.io/IhuqM_1QA0ImL81XAUUnLR1daGg_d69tMeZXe-Y_Sg__jBHstIT8-Bl--Z5_JfmAFsBVn7nBe-6AyDIT0yGwV2dWxSc597A3Q1owN2RlhDVfTA7m7VL4OcPerRvBZVTkc87oVEb7WHpivhy_df1jObgg0AJJkEAyEKOiYGAxCY5ChTzNNmM1l2Br_rZ2GUPc4-Ip1Y2VHBhZ9VvjZ4xme6OYensWvb6qIdKxjUUM2jwTT1n1GtErnwoMHZN7iKoS6f_zbwjj8PjsptFpyPPzUgupt6SgVtb-w9abtxiz5G_WUjjHM1ODbttkWQSNI_lKisptl4Mj_I5RZy9ZOXHEIJr3UCw51-D69I9lqTZ7-XQC5YVo-RvRymOfTG4Nzpt2euNkC70VvZE03v0qufsDPTDADkC_TRx7LEo-dFgaesQBn_W00OBlCQ6hRPIm8iekIuab4Jva2DtIDxfPsp3alP7mqtDerPc3Tui9uI69n4ojMH6juw'></script><script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    
    <!-- Vis.js Network pour la cartographie interactive -->
    <script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>
    
    <!-- Mermaid.js pour les diagrammes Gantt -->
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "#B!Mi Plaidoyer Citoyen",
        "description": "Poste de travail numÃ©rique pour construire des stratÃ©gies de plaidoyer citoyen",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Any",
        "offers": {"@type": "Offer", "price": "0", "priceCurrency": "EUR"},
        "featureList": ["15 outils mÃ©thodologiques", "Import/Export multiformats", "Fonctionne hors-ligne", "IndexedDB persistant"]
    }
    </script>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESIGN SYSTEM: RÃ‰TRO GEEK â€” VERT TENDRE & LILAS
           Mode sombre par dÃ©faut, accessible, non infantilisant
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        :root {
            /* Fond sombre avec nuance violette */
            --bg-deep: #0d0d14;
            --bg-base: #12121a;
            --bg-elevated: #1a1a26;
            --bg-surface: #222233;
            --bg-hover: #2a2a3d;
            
            /* Bordures et sÃ©parateurs */
            --border-subtle: #2d2d44;
            --border-default: #3d3d55;
            --border-strong: #4d4d66;
            
            /* Texte */
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b8;
            --text-muted: #6b6b88;
            --text-inverse: #12121a;
            
            /* Vert tendre - Couleur principale */
            --mint-50: #f0fff4;
            --mint-100: #c6f6d5;
            --mint-200: #9ae6b4;
            --mint-300: #68d391;
            --mint-400: #48bb78;
            --mint-500: #38a169;
            --mint-glow: rgba(72, 187, 120, 0.3);
            
            /* Lilas - Couleur secondaire */
            --lilac-50: #faf5ff;
            --lilac-100: #e9d8fd;
            --lilac-200: #d6bcfa;
            --lilac-300: #b794f4;
            --lilac-400: #9f7aea;
            --lilac-500: #805ad5;
            --lilac-glow: rgba(159, 122, 234, 0.3);
            
            /* Phases Voir/Juger/Agir */
            --voir: #63b3ed;
            --voir-bg: rgba(99, 179, 237, 0.12);
            --juger: #f6ad55;
            --juger-bg: rgba(246, 173, 85, 0.12);
            --agir: #68d391;
            --agir-bg: rgba(104, 211, 145, 0.12);
            
            /* SÃ©mantique */
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #fc8181;
            --info: #63b3ed;
            
            /* Position acteurs */
            --ally: #48bb78;
            --neutral: #a0aec0;
            --opponent: #fc8181;
            --target: #f6ad55;
            
            /* Typographie */
            --font-display: 'Space Grotesk', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
            
            /* Espacements */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            
            /* Rayons */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* Ombres */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            --shadow-glow-mint: 0 0 20px var(--mint-glow);
            --shadow-glow-lilac: 0 0 20px var(--lilac-glow);
            
            /* Transitions */
            --transition-fast: 120ms ease;
            --transition-base: 200ms ease;
            --transition-slow: 350ms ease;
            
            /* Layout */
            --header-h: 56px;
            --sidebar-w: 280px;
            --preview-w: 340px;
        }

        /* Reset */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { 
            font-size: 16px; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: var(--font-display);
            background: var(--bg-base);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        ::selection {
            background: var(--lilac-400);
            color: var(--text-inverse);
        }

        /* Scrollbar rÃ©tro */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, var(--mint-400), var(--lilac-400)); 
            border-radius: 4px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--mint-300); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYOUT PRINCIPAL
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* Header */
        #header {
            height: var(--header-h);
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            padding: 0 var(--space-4);
            gap: var(--space-3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo-mark {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--mint-400), var(--lilac-400));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.7rem;
            color: var(--text-inverse);
            box-shadow: var(--shadow-glow-mint);
            letter-spacing: -0.05em;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .logo-sub {
            font-size: 0.65rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        #project-title {
            flex: 1;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 var(--space-4);
        }

        .header-actions {
            display: flex;
            gap: var(--space-2);
        }

        /* Boutons */
        .btn {
            font-family: var(--font-display);
            font-weight: 500;
            font-size: 0.85rem;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--mint-400), var(--mint-500));
            color: var(--text-inverse);
            border-color: var(--mint-500);
            box-shadow: var(--shadow-glow-mint);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--mint-300), var(--mint-400));
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-color: var(--border-default);
        }
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--lilac-400);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 1.1rem;
        }

        .btn-sm {
            padding: var(--space-1) var(--space-3);
            font-size: 0.8rem;
        }

        /* Layout principal */
        #main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-w);
            background: var(--bg-elevated);
            border-right: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        @media (max-width: 1024px) {
            #sidebar {
                position: fixed;
                left: 0;
                top: var(--header-h);
                bottom: 0;
                z-index: 200;
                transform: translateX(-100%);
                transition: transform var(--transition-base);
            }
            #sidebar.open {
                transform: translateX(0);
                box-shadow: var(--shadow-lg);
            }
            #sidebar-overlay {
                position: fixed;
                inset: 0;
                top: var(--header-h);
                background: rgba(0,0,0,0.6);
                z-index: 199;
                opacity: 0;
                visibility: hidden;
                transition: all var(--transition-base);
            }
            #sidebar-overlay.open {
                opacity: 1;
                visibility: visible;
            }
        }

        /* Projets */
        #projects-section {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-subtle);
        }

        .section-label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        #projects-list {
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: var(--space-3);
        }

        .project-row {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            margin-bottom: 2px;
        }
        .project-row:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .project-row.selected {
            background: linear-gradient(90deg, var(--mint-glow), transparent);
            color: var(--mint-300);
            border-left: 2px solid var(--mint-400);
        }
        .project-row .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .project-row .actions {
            display: flex;
            gap: 2px;
            opacity: 0;
        }
        .project-row:hover .actions {
            opacity: 1;
        }
        .project-row .actions button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: var(--radius-sm);
        }
        .project-row .actions button:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .project-btns {
            display: flex;
            gap: var(--space-2);
        }
        .project-btns button {
            flex: 1;
            padding: var(--space-2);
            background: var(--bg-surface);
            border: 1px dashed var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .project-btns button:hover {
            border-color: var(--mint-400);
            color: var(--mint-300);
        }

        /* Navigation */
        #nav-section {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-3);
        }

        .nav-group {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            padding: var(--space-4) var(--space-2) var(--space-2);
        }
        .nav-group.c-voir { color: var(--voir); }
        .nav-group.c-juger { color: var(--juger); }
        .nav-group.c-agir { color: var(--agir); }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            width: 100%;
            text-align: left;
            padding: var(--space-2) var(--space-3);
            border: none;
            background: none;
            color: var(--text-secondary);
            font-family: var(--font-display);
            font-size: 0.85rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-bottom: 1px;
            transition: all var(--transition-fast);
            position: relative;
        }
        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .nav-btn.active {
            background: var(--bg-surface);
            color: var(--mint-300);
        }
        .nav-btn .icon { width: 20px; text-align: center; }
        .nav-btn .label { flex: 1; }
        .nav-btn .hint-trigger {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--bg-surface);
            color: var(--text-muted);
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--transition-fast);
            font-weight: 700;
        }
        .nav-btn:hover .hint-trigger { opacity: 0.7; }
        .nav-btn .hint-trigger:hover { opacity: 1; background: var(--lilac-400); color: var(--text-inverse); }

        /* Footer sidebar */
        #sidebar-footer {
            padding: var(--space-3) var(--space-4);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #status-badge {
            font-size: 0.7rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        /* Main content */
        #main-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
            background: var(--bg-base);
        }

        .content-wrapper {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.25s ease;
        }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Intro de page */
        .page-intro {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
        }
        .page-intro .help-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--lilac-glow);
            color: var(--lilac-300);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .page-intro .help-icon:hover {
            background: var(--lilac-400);
            color: var(--text-inverse);
        }
        .page-intro p { flex: 1; }

        /* Cards */
        .card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-5);
            transition: border-color var(--transition-fast);
        }
        .card:focus-within {
            border-color: var(--mint-400);
        }

        .card-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .card-badge {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 100px;
            letter-spacing: 0.03em;
        }
        .badge-voir { background: var(--voir-bg); color: var(--voir); }
        .badge-juger { background: var(--juger-bg); color: var(--juger); }
        .badge-agir { background: var(--agir-bg); color: var(--agir); }

        .card-body {
            padding: var(--space-5);
        }

        /* Formulaires */
        .field {
            margin-bottom: var(--space-5);
        }
        .field:last-child { margin-bottom: 0; }

        .field label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .field input,
        .field textarea,
        .field select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
        }
        .field input:focus,
        .field textarea:focus,
        .field select:focus {
            outline: none;
            border-color: var(--mint-400);
            box-shadow: 0 0 0 3px var(--mint-glow);
        }
        .field textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }
        .field small {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--space-1);
        }

        /* Grilles */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-4); }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-3); }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
        }
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--bg-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-2);
            font-size: 1.2rem;
        }
        .stat-value {
            font-family: var(--font-mono);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--mint-300);
            line-height: 1;
        }
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-top: var(--space-1);
        }

        /* Score circulaire */
        .score-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto var(--space-4);
        }
        .score-ring {
            transform: rotate(-90deg);
        }
        .score-ring circle {
            fill: none;
            stroke-width: 8;
        }
        .score-ring .bg { stroke: var(--bg-surface); }
        .score-ring .fg { 
            stroke: url(#scoreGradient);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.6s ease;
        }
        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .score-label {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Progress bars */
        .progress-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .progress-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }
        .progress-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .progress-bar {
            height: 6px;
            background: var(--bg-surface);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        .progress-fill.voir { background: var(--voir); }
        .progress-fill.juger { background: var(--juger); }
        .progress-fill.agir { background: var(--agir); }
        .progress-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: var(--space-1);
        }

        /* Phases cards */
        .phases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .phase-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        .phase-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }
        .phase-card.voir::before { background: var(--voir); }
        .phase-card.juger::before { background: var(--juger); }
        .phase-card.agir::before { background: var(--agir); }
        .phase-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        .phase-card.voir:hover { border-color: var(--voir); box-shadow: 0 8px 24px rgba(99, 179, 237, 0.2); }
        .phase-card.juger:hover { border-color: var(--juger); box-shadow: 0 8px 24px rgba(246, 173, 85, 0.2); }
        .phase-card.agir:hover { border-color: var(--agir); box-shadow: 0 8px 24px rgba(104, 211, 145, 0.2); }

        .phase-icon { font-size: 2rem; margin-bottom: var(--space-3); }
        .phase-name { font-weight: 700; font-size: 1.1rem; margin-bottom: var(--space-2); }
        .phase-card.voir .phase-name { color: var(--voir); }
        .phase-card.juger .phase-name { color: var(--juger); }
        .phase-card.agir .phase-name { color: var(--agir); }
        .phase-desc { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: var(--space-3); }
        .phase-tools { font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono); }

        /* Matrice pouvoir */
        .matrix-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: var(--space-4) auto;
        }
        .matrix-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            background: var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
            aspect-ratio: 1;
        }
        .matrix-quad {
            background: var(--bg-elevated);
            padding: var(--space-3);
            min-height: 140px;
            position: relative;
        }
        .matrix-quad-label {
            position: absolute;
            top: var(--space-2);
            left: var(--space-2);
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .matrix-quad.q1 { background: rgba(72, 187, 120, 0.08); }
        .matrix-quad.q2 { background: rgba(246, 173, 85, 0.08); }
        .matrix-quad.q3 { background: rgba(99, 179, 237, 0.08); }
        .matrix-quad.q4 { background: rgba(160, 174, 192, 0.08); }

        .actor-chip {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: 3px 8px;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            margin: 2px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .actor-chip.ally { border-color: var(--ally); color: var(--ally); }
        .actor-chip.neutral { border-color: var(--neutral); color: var(--neutral); }
        .actor-chip.opponent { border-color: var(--opponent); color: var(--opponent); }
        .actor-chip.target { border-color: var(--target); color: var(--target); }
        .actor-chip:hover { background: var(--bg-hover); }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CARTOGRAPHIE INTERACTIVE DES ACTEURS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Onglets de vue */
        .view-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: var(--space-2);
        }
        .view-tab {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            background: transparent;
            border: 1px solid transparent;
            border-bottom: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .view-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .view-tab.active {
            color: var(--mint-300);
            background: var(--bg-elevated);
            border-color: var(--border-subtle);
        }
        
        /* Conteneur du graphe rÃ©seau */
        .network-container {
            width: 100%;
            height: 500px;
            background: var(--bg-deep);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            position: relative;
            overflow: hidden;
        }
        .network-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            border-radius: 0;
        }
        #network-graph {
            width: 100%;
            height: 100%;
        }
        
        /* ContrÃ´les du graphe */
        .network-controls {
            position: absolute;
            top: var(--space-3);
            right: var(--space-3);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            z-index: 10;
        }
        .network-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all var(--transition-fast);
        }
        .network-btn:hover {
            background: var(--bg-hover);
            color: var(--mint-300);
            border-color: var(--mint-400);
        }
        
        /* LÃ©gende du graphe */
        .network-legend {
            position: absolute;
            bottom: var(--space-3);
            left: var(--space-3);
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            font-size: 0.75rem;
            z-index: 10;
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: var(--space-2);
            color: var(--text-secondary);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-1);
            color: var(--text-muted);
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-line {
            width: 20px;
            height: 2px;
        }
        
        /* Panneau d'Ã©dition de liens */
        .link-panel {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-top: var(--space-4);
        }
        .link-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        .link-panel-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .link-form {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto auto;
            gap: var(--space-3);
            align-items: end;
        }
        @media (max-width: 768px) {
            .link-form {
                grid-template-columns: 1fr;
            }
        }
        .link-type-selector {
            display: flex;
            gap: var(--space-2);
        }
        .link-type-btn {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            background: var(--bg-surface);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all var(--transition-fast);
        }
        .link-type-btn:hover { border-color: var(--border-strong); }
        .link-type-btn.active.influence { border-color: var(--info); color: var(--info); background: var(--voir-bg); }
        .link-type-btn.active.alliance { border-color: var(--ally); color: var(--ally); background: var(--agir-bg); }
        .link-type-btn.active.opposition { border-color: var(--opponent); color: var(--opponent); background: rgba(252,129,129,0.12); }
        
        /* Liste des liens */
        .links-list {
            margin-top: var(--space-3);
            max-height: 200px;
            overflow-y: auto;
        }
        .link-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2) var(--space-3);
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-2);
            font-size: 0.85rem;
        }
        .link-item-content {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .link-arrow {
            color: var(--text-muted);
        }
        .link-item.influence .link-arrow { color: var(--info); }
        .link-item.alliance .link-arrow { color: var(--ally); }
        .link-item.opposition .link-arrow { color: var(--opponent); }
        .link-delete {
            color: var(--text-muted);
            cursor: pointer;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        .link-item:hover .link-delete { opacity: 1; }
        .link-delete:hover { color: var(--danger); }
        
        /* Drag & drop sur la matrice */
        .actor-chip.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .actor-chip.draggable {
            cursor: grab;
        }
        .matrix-quad.drag-over {
            background: var(--bg-hover);
            box-shadow: inset 0 0 0 2px var(--mint-400);
        }
        
        /* Info bulle acteur */
        .actor-tooltip {
            position: fixed;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            max-width: 280px;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        .actor-tooltip.visible { opacity: 1; }
        .actor-tooltip-name {
            font-weight: 600;
            margin-bottom: var(--space-1);
        }
        .actor-tooltip-role {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: var(--space-2);
        }
        .actor-tooltip-meta {
            display: flex;
            gap: var(--space-3);
            font-size: 0.8rem;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           KANBAN / TIMELINE / GANTT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Kanban Board */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            min-height: 400px;
        }
        @media (max-width: 768px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
        }
        .kanban-column {
            background: var(--bg-deep);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            min-height: 300px;
        }
        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) var(--space-3);
            margin-bottom: var(--space-3);
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9rem;
        }
        .kanban-column.todo .kanban-column-header {
            background: rgba(99, 179, 237, 0.2);
            color: var(--info);
        }
        .kanban-column.inprogress .kanban-column-header {
            background: rgba(246, 173, 85, 0.2);
            color: var(--warning);
        }
        .kanban-column.done .kanban-column-header {
            background: rgba(72, 187, 120, 0.2);
            color: var(--success);
        }
        .kanban-column-count {
            background: var(--bg-surface);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        .kanban-cards {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            min-height: 200px;
        }
        .kanban-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            cursor: grab;
            transition: all var(--transition-fast);
        }
        .kanban-card:hover {
            border-color: var(--mint-400);
            box-shadow: var(--shadow-md);
        }
        .kanban-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .kanban-card-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: var(--space-2);
            line-height: 1.4;
        }
        .kanban-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .kanban-card-deadline {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .kanban-card-deadline.overdue {
            color: var(--danger);
        }
        .kanban-card-deadline.soon {
            color: var(--warning);
        }
        .kanban-column.drag-over {
            background: var(--bg-hover);
            box-shadow: inset 0 0 0 2px var(--mint-400);
        }
        
        /* Timeline */
        .timeline-container {
            position: relative;
            padding: var(--space-4) 0;
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            padding: 0 var(--space-4);
        }
        .timeline-months {
            display: flex;
            gap: 2px;
            margin-bottom: var(--space-2);
            padding: 0 var(--space-4);
        }
        .timeline-month {
            flex: 1;
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: var(--space-1);
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
        }
        .timeline-month.current {
            background: var(--mint-500);
            color: var(--bg-deep);
            font-weight: 600;
        }
        .timeline-track {
            position: relative;
            height: 4px;
            background: var(--bg-surface);
            border-radius: 2px;
            margin: var(--space-4) var(--space-4) var(--space-6);
        }
        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--mint-400), var(--lilac-400));
            border-radius: 2px;
        }
        .timeline-today {
            position: absolute;
            top: -8px;
            width: 2px;
            height: 20px;
            background: var(--danger);
            transform: translateX(-50%);
        }
        .timeline-today::after {
            content: 'Aujourd\'hui';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--danger);
            white-space: nowrap;
        }
        .timeline-items {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            padding: 0 var(--space-4);
        }
        .timeline-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--border-subtle);
        }
        .timeline-item.overdue {
            border-left-color: var(--danger);
            background: rgba(252, 129, 129, 0.08);
        }
        .timeline-item.soon {
            border-left-color: var(--warning);
        }
        .timeline-item.done {
            border-left-color: var(--success);
            opacity: 0.7;
        }
        .timeline-item-date {
            min-width: 80px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }
        .timeline-item-content {
            flex: 1;
        }
        .timeline-item-title {
            font-size: 0.9rem;
            margin-bottom: var(--space-1);
        }
        .timeline-item.done .timeline-item-title {
            text-decoration: line-through;
        }
        .timeline-item-indicator {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Gantt (Mermaid) */
        .gantt-container {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            overflow-x: auto;
        }
        .gantt-container .mermaid {
            display: flex;
            justify-content: center;
        }
        .gantt-empty {
            text-align: center;
            padding: var(--space-6);
            color: var(--text-muted);
        }
        
        /* Stats bar pour les objectifs */
        .smart-stats {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
            padding: var(--space-3);
            background: var(--bg-surface);
            border-radius: var(--radius-md);
        }
        .smart-stat {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.85rem;
        }
        .smart-stat-value {
            font-weight: 600;
        }
        .smart-stat.todo .smart-stat-value { color: var(--info); }
        .smart-stat.inprogress .smart-stat-value { color: var(--warning); }
        .smart-stat.done .smart-stat-value { color: var(--success); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PWA - OFFLINE INDICATOR & INSTALL BUTTON
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Offline indicator */
        body.offline::before {
            content: 'ğŸ“´ Mode hors-ligne';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, var(--warning), var(--juger));
            color: var(--bg-deep);
            text-align: center;
            padding: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10000;
        }
        body.offline .header {
            margin-top: 24px;
        }
        
        /* Install button animation */
        #btn-install-pwa {
            animation: pulse-install 2s ease-in-out infinite;
        }
        @keyframes pulse-install {
            0%, 100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(72, 187, 120, 0); }
        }
        #btn-install-pwa:hover {
            animation: none;
            background: var(--mint-500);
            color: var(--bg-deep);
        }
        
        /* Standalone mode adjustments */
        @media (display-mode: standalone) {
            .header {
                padding-top: env(safe-area-inset-top, 0);
            }
            body {
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
        }

        /* SWOT Grid */
        .swot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }
        .swot-card {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            border-left: 3px solid;
        }
        .swot-card.forces { border-left-color: var(--success); }
        .swot-card.faiblesses { border-left-color: var(--danger); }
        .swot-card.opportunites { border-left-color: var(--info); }
        .swot-card.menaces { border-left-color: var(--warning); }
        .swot-title { font-weight: 600; font-size: 0.9rem; margin-bottom: var(--space-3); display: flex; align-items: center; gap: var(--space-2); }

        /* Liste SMART */
        .smart-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .smart-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
        }
        .smart-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--mint-400);
            margin-top: 2px;
        }
        .smart-content { flex: 1; }
        .smart-text { font-size: 0.9rem; margin-bottom: var(--space-2); }
        .smart-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: var(--space-4); }
        .smart-item.done .smart-text { text-decoration: line-through; color: var(--text-muted); }

        /* Journal */
        .journal-timeline {
            position: relative;
            padding-left: var(--space-6);
        }
        .journal-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--mint-400), var(--lilac-400));
        }
        .journal-entry {
            position: relative;
            margin-bottom: var(--space-5);
        }
        .journal-entry::before {
            content: '';
            position: absolute;
            left: calc(-1 * var(--space-6) + 6px);
            top: 6px;
            width: 10px;
            height: 10px;
            background: var(--mint-400);
            border-radius: 50%;
            box-shadow: var(--shadow-glow-mint);
        }
        .journal-date {
            font-size: 0.7rem;
            font-family: var(--font-mono);
            color: var(--text-muted);
            margin-bottom: var(--space-1);
        }
        .journal-text {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            font-size: 0.9rem;
        }

        /* Export section */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-3);
        }
        .export-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .export-card:hover {
            border-color: var(--mint-400);
            transform: translateY(-2px);
        }
        .export-icon { font-size: 2rem; margin-bottom: var(--space-2); }
        .export-name { font-weight: 600; font-size: 0.9rem; }
        .export-ext { font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono); }

        /* Drop zone */
        .drop-zone {
            border: 2px dashed var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--mint-400);
            background: var(--mint-glow);
        }
        .drop-zone-icon { font-size: 2.5rem; margin-bottom: var(--space-3); }
        .drop-zone-text { color: var(--text-secondary); }
        .drop-zone-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: var(--space-2); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(13, 13, 20, 0.85);
            backdrop-filter: blur(4px);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }
        .modal-overlay.open { display: flex; }

        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.25s ease;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: var(--space-5);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-title { font-weight: 600; font-size: 1.1rem; }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--bg-surface);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all var(--transition-fast);
        }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .modal-body { padding: var(--space-5); }
        .modal-footer {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }

        /* Help tooltip non-invasif */
        .help-tooltip {
            position: fixed;
            background: var(--bg-surface);
            border: 1px solid var(--lilac-400);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            max-width: 320px;
            box-shadow: var(--shadow-lg), var(--shadow-glow-lilac);
            z-index: 600;
            display: none;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        .help-tooltip.show { display: block; animation: fadeIn 0.2s ease; }
        .help-tooltip h4 {
            color: var(--lilac-300);
            font-size: 0.9rem;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .help-tooltip p { color: var(--text-secondary); margin-bottom: var(--space-2); }
        .help-tooltip ul { margin-left: var(--space-4); color: var(--text-muted); }
        .help-tooltip li { margin-bottom: var(--space-1); }
        .help-tooltip .dismiss {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .help-tooltip .dismiss kbd {
            background: var(--bg-hover);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.7rem;
        }

        /* Toast */
        #toasts {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            z-index: 700;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .toast {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 0.85rem;
            box-shadow: var(--shadow-md);
            animation: toastIn 0.25s ease;
            min-width: 250px;
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--info); }
        .toast.warning { border-left: 3px solid var(--warning); }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--space-8);
        }
        .empty-state .icon { font-size: 4rem; margin-bottom: var(--space-4); }
        .empty-state h3 { font-size: 1.25rem; margin-bottom: var(--space-2); }
        .empty-state p { color: var(--text-muted); margin-bottom: var(--space-5); }
        .empty-state .btns { display: flex; gap: var(--space-3); justify-content: center; flex-wrap: wrap; }

        /* Templates */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-5);
        }
        .template-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .template-card:hover {
            border-color: var(--mint-400);
            transform: translateY(-2px);
        }
        .template-card .icon { font-size: 2rem; margin-bottom: var(--space-2); }
        .template-card .title { font-weight: 600; font-size: 0.9rem; }
        .template-card .desc { font-size: 0.75rem; color: var(--text-muted); }

        /* Menu mobile */
        @media (max-width: 1024px) {
            #main-content { padding: var(--space-4); }
            .phases-grid { grid-template-columns: 1fr; }
            .swot-grid { grid-template-columns: 1fr; }
            #toasts { left: var(--space-4); right: var(--space-4); }
        }

        /* Desktop preview panel */
        @media (min-width: 1024px) {
            #header { display: none; }
            #sidebar-overlay { display: none !important; }
            #sidebar {
                position: static;
                transform: none;
            }
            .progress-list { flex-direction: row; }
            .progress-item { flex: 1; }
        }

        /* Print */
        @media print {
            #sidebar, #header, .modal-overlay, #toasts, .btn { display: none !important; }
            #main-content { padding: 0; }
            .card { break-inside: avoid; border: 1px solid #ccc; background: #fff; color: #000; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- HEADER (Mobile) -->
    <header id="header">
        <button class="btn btn-ghost btn-icon" id="btn-menu" aria-label="Menu">â˜°</button>
        <div class="logo">
            <div class="logo-mark">#B!Mi</div>
        </div>
        <span id="project-title">STOP Arizona â€” DÃ©fense du ModÃ¨le Social Belge</span>
        <div class="header-actions">
            <button class="btn btn-ghost btn-icon" id="btn-search" aria-label="Rechercher">ğŸ”</button>
            <button class="btn btn-primary btn-icon" id="btn-preview" aria-label="AperÃ§u">ğŸ‘ï¸</button>
        </div>
    </header>

    <!-- SIDEBAR OVERLAY (Mobile) -->
    <div id="sidebar-overlay"></div>

    <div id="main-layout">
        <!-- SIDEBAR -->
        <nav id="sidebar" aria-label="Navigation principale">
            <div id="projects-section">
                <div class="section-label">ğŸ“ Mes projets</div>
                <div id="projects-list">
        <div class="project-row selected" data-id="1769080442254">
            <span class="name">STOP Arizona â€” DÃ©fense du ModÃ¨le Social Belge</span>
            <div class="actions">
                <button class="dup" title="Dupliquer">ğŸ“‹</button>
                <button class="del" title="Supprimer">ğŸ—‘ï¸</button>
            </div>
        </div>
    </div>
                <div class="project-btns">
                    <button id="btn-new-project">+ Nouveau</button>
                    <button id="btn-templates">ğŸ“‹ ModÃ¨les</button>
                </div>
            </div>

            <div id="nav-section">
                <div class="nav-group">ğŸ“Š GÃ©nÃ©ral</div>
                <button class="nav-btn active" data-page="dashboard">
                    <span class="icon">ğŸ“Š</span>
                    <span class="label">Tableau de bord</span>
                    <span class="hint-trigger" data-help="dashboard">?</span>
                </button>

                <div class="nav-group c-voir">ğŸ‘ï¸ VOIR â€” Analyse</div>
                <button class="nav-btn" data-page="domino">
                    <span class="icon">ğŸ¯</span>
                    <span class="label">Vision (Domino)</span>
                    <span class="hint-trigger" data-help="domino">?</span>
                </button>
                <button class="nav-btn" data-page="profil">
                    <span class="icon">ğŸ‘¤</span>
                    <span class="label">Profil citoyen</span>
                    <span class="hint-trigger" data-help="profil">?</span>
                </button>
                <button class="nav-btn" data-page="fleur">
                    <span class="icon">ğŸŒ¸</span>
                    <span class="label">Fleur du pouvoir</span>
                    <span class="hint-trigger" data-help="fleur">?</span>
                </button>

                <div class="nav-group c-juger">âš–ï¸ JUGER â€” StratÃ©gie</div>
                <button class="nav-btn" data-page="acteurs">
                    <span class="icon">ğŸ‘¥</span>
                    <span class="label">Cartographie acteurs</span>
                    <span class="hint-trigger" data-help="acteurs">?</span>
                </button>
                <button class="nav-btn" data-page="arbre">
                    <span class="icon">ğŸŒ³</span>
                    <span class="label">Arbre Ã  problÃ¨mes</span>
                    <span class="hint-trigger" data-help="arbre">?</span>
                </button>
                <button class="nav-btn" data-page="pourquoi">
                    <span class="icon">â“</span>
                    <span class="label">5 Pourquoi</span>
                    <span class="hint-trigger" data-help="pourquoi">?</span>
                </button>
                <button class="nav-btn" data-page="swot">
                    <span class="icon">ğŸ“</span>
                    <span class="label">SWOT</span>
                    <span class="hint-trigger" data-help="swot">?</span>
                </button>
                <button class="nav-btn" data-page="pestel">
                    <span class="icon">ğŸŒ</span>
                    <span class="label">PESTEL</span>
                    <span class="hint-trigger" data-help="pestel">?</span>
                </button>
                <button class="nav-btn" data-page="tdc">
                    <span class="icon">ğŸ”„</span>
                    <span class="label">ThÃ©orie du changement</span>
                    <span class="hint-trigger" data-help="tdc">?</span>
                </button>

                <div class="nav-group c-agir">âœŠ AGIR â€” Action</div>
                <button class="nav-btn" data-page="pouvoir">
                    <span class="icon">âš¡</span>
                    <span class="label">Avec/Sans/Contre</span>
                    <span class="hint-trigger" data-help="pouvoir">?</span>
                </button>
                <button class="nav-btn" data-page="cibles">
                    <span class="icon">ğŸ¯</span>
                    <span class="label">Cibles &amp; AlliÃ©s</span>
                    <span class="hint-trigger" data-help="cibles">?</span>
                </button>
                <button class="nav-btn" data-page="smart">
                    <span class="icon">ğŸ“‹</span>
                    <span class="label">Objectifs SMART</span>
                    <span class="hint-trigger" data-help="smart">?</span>
                </button>
                <button class="nav-btn" data-page="message">
                    <span class="icon">ğŸ’¬</span>
                    <span class="label">Message clÃ©</span>
                    <span class="hint-trigger" data-help="message">?</span>
                </button>
                <button class="nav-btn" data-page="evaluation">
                    <span class="icon">ğŸ“ˆ</span>
                    <span class="label">Suivi-Ã©valuation</span>
                    <span class="hint-trigger" data-help="evaluation">?</span>
                </button>
                <button class="nav-btn" data-page="journal">
                    <span class="icon">ğŸ““</span>
                    <span class="label">Journal de bord</span>
                    <span class="hint-trigger" data-help="journal">?</span>
                </button>

                <div class="nav-group">ğŸ”§ Outils</div>
                <button class="nav-btn" data-page="export">
                    <span class="icon">ğŸ’¾</span>
                    <span class="label">Import / Export</span>
                </button>
                <button class="nav-btn" data-page="ressources">
                    <span class="icon">ğŸ“š</span>
                    <span class="label">Ressources</span>
                </button>
            </div>

            <div id="sidebar-footer">
                <span id="status-badge">â— PrÃªt</span>
                <button class="btn btn-sm btn-ghost" id="btn-shortcuts">âŒ¨ï¸</button>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main id="main-content">
            <div class="content-wrapper">

                <!-- PAGE: Empty -->
                <section class="page" id="p-empty">
                    <div class="empty-state">
                        <div class="icon">âš–ï¸</div>
                        <h3>Bienvenue sur #B!Mi</h3>
                        <p>CrÃ©ez votre premier projet de plaidoyer citoyen</p>
                        <div class="btns">
                            <button class="btn btn-primary" id="btn-empty-new">+ Nouveau projet</button>
                            <label class="btn btn-secondary" style="cursor:pointer">
                                ğŸ“¥ Importer
                                <input type="file" accept=".json" id="import-home" style="display:none">
                            </label>
                        </div>
                        <div class="template-grid">
                            <div class="template-card" data-tpl="blank">
                                <div class="icon">ğŸ“„</div>
                                <div class="title">Projet vierge</div>
                                <div class="desc">Partir de zÃ©ro</div>
                            </div>
                            <div class="template-card" data-tpl="arizona">
                                <div class="icon">ğŸ›‘</div>
                                <div class="title">Stop Arizona</div>
                                <div class="desc">RÃ©formes sociales</div>
                            </div>
                            <div class="template-card" data-tpl="ecp" style="border-color:var(--lilac-400);">
                                <div class="icon">ğŸ’¡</div>
                                <div class="title" style="color:var(--lilac-300);">Ã‰conomie Contributive</div>
                                <div class="desc">Ruling fiscal ECP</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Dashboard -->
                <section class="page active" id="p-dashboard">
                    <!-- Score global -->
                    <div class="score-container">
                        <svg class="score-ring" viewBox="0 0 100 100">
                            <defs>
                                <lineargradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#48bb78"></stop>
                                    <stop offset="100%" stop-color="#9f7aea"></stop>
                                </lineargradient>
                            </defs>
                            <circle class="bg" cx="50" cy="50" r="42"></circle>
                            <circle class="fg" id="score-circle" cx="50" cy="50" r="42" stroke-dasharray="264" stroke-dashoffset="264" style="stroke-dashoffset: 7.92;"></circle>
                        </svg>
                        <div class="score-value" id="score-value">97%</div>
                    </div>
                    <div class="score-label">Progression globale</div>

                    <!-- Stats rapides -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ‘¥</div>
                            <div class="stat-value" id="stat-actors">32</div>
                            <div class="stat-label">Acteurs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ¯</div>
                            <div class="stat-value" id="stat-smart">5</div>
                            <div class="stat-label">Objectifs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ““</div>
                            <div class="stat-value" id="stat-journal">0</div>
                            <div class="stat-label">EntrÃ©es</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ“Š</div>
                            <div class="stat-value" id="stat-fields">47</div>
                            <div class="stat-label">Champs</div>
                        </div>
                    </div>

                    <!-- Progress par phase -->
                    <div class="progress-list">
                        <div class="progress-item">
                            <div class="progress-title"><span style="color:var(--voir)">ğŸ‘ï¸</span> VOIR</div>
                            <div class="progress-bar"><div class="progress-fill voir" id="progress-voir" style="width: 100%;"></div></div>
                            <div class="progress-meta"><span>Analyse</span><span id="progress-voir-val">100%</span></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-title"><span style="color:var(--juger)">âš–ï¸</span> JUGER</div>
                            <div class="progress-bar"><div class="progress-fill juger" id="progress-juger" style="width: 100%;"></div></div>
                            <div class="progress-meta"><span>StratÃ©gie</span><span id="progress-juger-val">100%</span></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-title"><span style="color:var(--agir)">âœŠ</span> AGIR</div>
                            <div class="progress-bar"><div class="progress-fill agir" id="progress-agir" style="width: 90%;"></div></div>
                            <div class="progress-meta"><span>Action</span><span id="progress-agir-val">90%</span></div>
                        </div>
                    </div>

                    <!-- Navigation rapide -->
                    <div class="phases-grid">
                        <div class="phase-card voir" data-goto="domino">
                            <div class="phase-icon">ğŸ‘ï¸</div>
                            <div class="phase-name">VOIR</div>
                            <div class="phase-desc">Analyser le contexte et identifier les acteurs</div>
                            <div class="phase-tools">3 outils</div>
                        </div>
                        <div class="phase-card juger" data-goto="acteurs">
                            <div class="phase-icon">âš–ï¸</div>
                            <div class="phase-name">JUGER</div>
                            <div class="phase-desc">RÃ©flexion critique et Ã©laboration stratÃ©gique</div>
                            <div class="phase-tools">6 outils</div>
                        </div>
                        <div class="phase-card agir" data-goto="smart">
                            <div class="phase-icon">âœŠ</div>
                            <div class="phase-name">AGIR</div>
                            <div class="phase-desc">Actions concrÃ¨tes et suivi de l'impact</div>
                            <div class="phase-tools">6 outils</div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Domino (Vision) -->
                <section class="page" id="p-domino">
                    <div class="page-intro">
                        <span class="help-icon" data-help="domino">?</span>
                        <p>Le <strong>Domino du changement</strong> clarifie votre vision, identifie les obstacles et recense vos ressources.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ¯ Vision du changement <span class="card-badge badge-voir">VOIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>Quel changement voulez-vous voir ?</label>
                                <textarea data-field="domino.vision" placeholder="DÃ©crivez prÃ©cisÃ©ment le changement souhaitÃ©..."></textarea>
                                <small>Soyez concret : qui, quoi, quand, comment ?</small>
                            </div>
                            <div class="field">
                                <label>Quels sont les obstacles ?</label>
                                <textarea data-field="domino.obstacles" placeholder="Freins politiques, administratifs, culturels..."></textarea>
                            </div>
                            <div class="field">
                                <label>Quelles sont vos ressources ?</label>
                                <textarea data-field="domino.ressources" placeholder="Forces, alliÃ©s, compÃ©tences, leviers..."></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Profil -->
                <section class="page" id="p-profil">
                    <div class="page-intro">
                        <span class="help-icon" data-help="profil">?</span>
                        <p>Votre <strong>profil d'engagement</strong> : motivations, compÃ©tences, disponibilitÃ© et limites.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ‘¤ Profil citoyen <span class="card-badge badge-voir">VOIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>Motivations</label>
                                <textarea data-field="profil.motivations" placeholder="Pourquoi vous engagez-vous ?"></textarea>
                            </div>
                            <div class="field">
                                <label>CompÃ©tences</label>
                                <textarea data-field="profil.competences" placeholder="Analyse, communication, juridique..."></textarea>
                            </div>
                            <div class="field">
                                <label>DisponibilitÃ©</label>
                                <textarea data-field="profil.temps" placeholder="Temps, pics d&#39;activitÃ©, horizon..."></textarea>
                            </div>
                            <div class="field">
                                <label>Limites et contraintes</label>
                                <textarea data-field="profil.limites" placeholder="Contraintes financiÃ¨res, risques..."></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Fleur -->
                <section class="page" id="p-fleur">
                    <div class="page-intro">
                        <span class="help-icon" data-help="fleur">?</span>
                        <p>La <strong>Fleur du pouvoir</strong> analyse les identitÃ©s, privilÃ¨ges et oppressions en jeu.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸŒ¸ Fleur du pouvoir <span class="card-badge badge-voir">VOIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>IdentitÃ©s des personnes concernÃ©es</label>
                                <textarea data-field="fleur.identites" placeholder="Qui sont les personnes touchÃ©es ?"></textarea>
                            </div>
                            <div class="field">
                                <label>PrivilÃ¨ges relatifs</label>
                                <textarea data-field="fleur.privileges" placeholder="AccÃ¨s Ã  l&#39;information, capital social..."></textarea>
                            </div>
                            <div class="field">
                                <label>Discriminations et violences</label>
                                <textarea data-field="fleur.oppressions" placeholder="Violences symboliques, administratives..."></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Acteurs -->
                <section class="page" id="p-acteurs">
                    <div class="page-intro">
                        <span class="help-icon" data-help="acteurs">?</span>
                        <p>La <strong>cartographie des acteurs</strong> identifie les parties prenantes selon leur pouvoir et leur position.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">â• Ajouter un acteur <span class="card-badge badge-juger">JUGER</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="grid-2">
                                <div class="field">
                                    <label>Nom</label>
                                    <input type="text" id="actor-name" placeholder="Ex: Ministre X">
                                </div>
                                <div class="field">
                                    <label>RÃ´le / Fonction</label>
                                    <input type="text" id="actor-role" placeholder="Ex: DÃ©cideur clÃ©">
                                </div>
                            </div>
                            <div class="grid-3">
                                <div class="field">
                                    <label>Position</label>
                                    <select id="actor-position">
                                        <option value="ally">ğŸŸ¢ AlliÃ©</option>
                                        <option value="target">ğŸŸ¡ Cible</option>
                                        <option value="opponent">ğŸ”´ Opposant</option>
                                        <option value="neutral">âšª Neutre</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label>Pouvoir (1-5)</label>
                                    <select id="actor-power">
                                        <option value="1">1 - Faible</option>
                                        <option value="2">2</option>
                                        <option value="3" selected="">3 - Moyen</option>
                                        <option value="4">4</option>
                                        <option value="5">5 - Ã‰levÃ©</option>
                                    </select>
                                </div>
                                <div class="field" style="display:flex;align-items:flex-end;">
                                    <button class="btn btn-primary" id="btn-add-actor" style="width:100%">â• Ajouter</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“Š Cartographie des Acteurs <span class="card-badge badge-juger">JUGER</span></h3>
                        </div>
                        <div class="card-body">
                            <!-- Onglets de vue -->
                            <div class="view-tabs">
                                <button class="view-tab active" data-view="matrix">ğŸ“Š Matrice</button>
                                <button class="view-tab" data-view="network">ğŸ•¸ï¸ RÃ©seau</button>
                                <button class="view-tab" data-view="links">ğŸ”— Relations</button>
                            </div>
                            
                            <!-- VUE MATRICE -->
                            <div id="view-matrix" class="view-content">
                                <div class="matrix-container">
                                    <div class="matrix-grid" id="matrix-grid">
                                        <div class="matrix-quad q1" id="quad-manage" data-quadrant="manage">
                                            <span class="matrix-quad-label">GÃ©rer de prÃ¨s</span>
                                            <div id="actors-q1"></div>
                                        </div>
                                        <div class="matrix-quad q2" id="quad-satisfy" data-quadrant="satisfy">
                                            <span class="matrix-quad-label">Garder satisfait</span>
                                            <div id="actors-q2"></div>
                                        </div>
                                        <div class="matrix-quad q3" id="quad-inform" data-quadrant="inform">
                                            <span class="matrix-quad-label">Garder informÃ©</span>
                                            <div id="actors-q3"></div>
                                        </div>
                                        <div class="matrix-quad q4" id="quad-monitor" data-quadrant="monitor">
                                            <span class="matrix-quad-label">Surveiller</span>
                                            <div id="actors-q4"></div>
                                        </div>
                                    </div>
                                </div>
                                <p style="font-size:0.8rem;color:var(--text-muted);margin-top:var(--space-3);text-align:center;">
                                    ğŸ’¡ Glissez-dÃ©posez les acteurs entre les quadrants pour modifier leur stratÃ©gie
                                </p>
                            </div>
                            
                            <!-- VUE RÃ‰SEAU -->
                            <div id="view-network" class="view-content" style="display:none;">
                                <div class="network-container" id="network-container">
                                    <div id="network-graph"></div>
                                    <div class="network-controls">
                                        <button class="network-btn" id="btn-network-fit" title="Recentrer">ğŸ¯</button>
                                        <button class="network-btn" id="btn-network-fullscreen" title="Plein Ã©cran">â›¶</button>
                                        <button class="network-btn" id="btn-network-export" title="Exporter en image">ğŸ“·</button>
                                    </div>
                                    <div class="network-legend">
                                        <div class="legend-title">LÃ©gende</div>
                                        <div class="legend-item"><span class="legend-dot" style="background:#48bb78;"></span> AlliÃ©</div>
                                        <div class="legend-item"><span class="legend-dot" style="background:#f6ad55;"></span> Cible</div>
                                        <div class="legend-item"><span class="legend-dot" style="background:#fc8181;"></span> Opposant</div>
                                        <div class="legend-item"><span class="legend-dot" style="background:#a0aec0;"></span> Neutre</div>
                                        <div style="margin-top:var(--space-2);padding-top:var(--space-2);border-top:1px solid var(--border-subtle);">
                                            <div class="legend-item"><span class="legend-line" style="background:#63b3ed;"></span> Influence</div>
                                            <div class="legend-item"><span class="legend-line" style="background:#48bb78;"></span> Alliance</div>
                                            <div class="legend-item"><span class="legend-line" style="background:#fc8181;"></span> Opposition</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- VUE RELATIONS -->
                            <div id="view-links" class="view-content" style="display:none;">
                                <div class="link-panel">
                                    <div class="link-panel-header">
                                        <span class="link-panel-title">ğŸ”— Ajouter une relation</span>
                                    </div>
                                    <div class="link-form">
                                        <div class="field">
                                            <label>De</label>
                                            <select id="link-from"></select>
                                        </div>
                                        <div style="display:flex;align-items:center;padding-top:1.5rem;">â†’</div>
                                        <div class="field">
                                            <label>Vers</label>
                                            <select id="link-to"></select>
                                        </div>
                                        <div class="field">
                                            <label>Type</label>
                                            <div class="link-type-selector">
                                                <button class="link-type-btn active influence" data-type="influence">ğŸ’¡ Influence</button>
                                                <button class="link-type-btn alliance" data-type="alliance">ğŸ¤ Alliance</button>
                                                <button class="link-type-btn opposition" data-type="opposition">âš”ï¸ Opposition</button>
                                            </div>
                                        </div>
                                        <div style="display:flex;align-items:flex-end;">
                                            <button class="btn btn-primary" id="btn-add-link">â•</button>
                                        </div>
                                    </div>
                                    <div class="links-list" id="links-list">
                                        <p style="color:var(--text-muted);text-align:center;padding:var(--space-3);">Aucune relation dÃ©finie</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“‹ Liste des acteurs (<span id="actors-count">32</span>)</h3>
                        </div>
                        <div class="card-body">
                            <div id="actors-list"><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Bart De Wever</strong> <span style="color:var(--text-muted);">â€” Premier Ministre (N-VA) â€” Architecte idÃ©ologique des rÃ©formes</span></div>
                <span style="color:var(--opponent)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Frank Vandenbroucke</strong> <span style="color:var(--text-muted);">â€” Ministre Affaires sociales (Vooruit) â€” Pilote volet santÃ©</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Georges-Louis Bouchez</strong> <span style="color:var(--text-muted);">â€” PrÃ©sident MR â€” Orthodoxie budgÃ©taire</span></div>
                <span style="color:var(--opponent)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Maxime PrÃ©vot</strong> <span style="color:var(--text-muted);">â€” PrÃ©sident Les EngagÃ©s â€” SensibilitÃ© sociale relative</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Sammy Mahdi</strong> <span style="color:var(--text-muted);">â€” PrÃ©sident CD&amp;V â€” Conservateur modÃ©rÃ©</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Thierry Bodson</strong> <span style="color:var(--text-muted);">â€” PrÃ©sident FGTB â€” Leader front commun syndical</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Marc Leemans</strong> <span style="color:var(--text-muted);">â€” PrÃ©sident CSC â€” Syndicat chrÃ©tien</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>CGSLB</strong> <span style="color:var(--text-muted);">â€” Syndicat libÃ©ral â€” Membre front commun</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Cour Constitutionnelle</strong> <span style="color:var(--text-muted);">â€” Juridiction suprÃªme â€” Recours article 23 pendants</span></div>
                <span style="color:var(--target)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Commission EuropÃ©enne</strong> <span style="color:var(--text-muted);">â€” Surveillance dÃ©ficit â€” Pression 23 milliards</span></div>
                <span style="color:var(--opponent)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>UVCW</strong> <span style="color:var(--text-muted);">â€” Union Villes Communes Wallonnes â€” CPAS wallons</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Brulocalis</strong> <span style="color:var(--text-muted);">â€” Association CPAS bruxellois â€” 80Mâ‚¬ surcoÃ»t estimÃ©</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>VVSG</strong> <span style="color:var(--text-muted);">â€” Association communes flamandes â€” Position mitigÃ©e</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>BAPN</strong> <span style="color:var(--text-muted);">â€” RÃ©seau Belge Lutte contre la PauvretÃ©</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>RWLP</strong> <span style="color:var(--text-muted);">â€” RÃ©seau Wallon Lutte contre la PauvretÃ©</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Solidaris</strong> <span style="color:var(--text-muted);">â€” MutualitÃ© socialiste â€” Expertise santÃ©, dÃ©nonce "taxe santÃ©"</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Ligue Droits Humains</strong> <span style="color:var(--text-muted);">â€” ONG droits fondamentaux â€” Co-requÃ©rant recours</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Vie FÃ©minine</strong> <span style="color:var(--text-muted);">â€” Mouvement fÃ©ministe â€” Discrimination indirecte femmes</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>FEF</strong> <span style="color:var(--text-muted);">â€” FÃ©dÃ©ration Ã‰tudiants Francophones â€” PrÃ©caritÃ© Ã©tudiante</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>DULBEA (ULB)</strong> <span style="color:var(--text-muted);">â€” Centre recherche Ã©conomique â€” Ã‰tudes d'impact</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>IWEPS</strong> <span style="color:var(--text-muted);">â€” Institut wallon statistique â€” DonnÃ©es non-recours</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>ONEM</strong> <span style="color:var(--text-muted);">â€” Office National Emploi â€” ExÃ©cutant vagues exclusions</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>INAMI</strong> <span style="color:var(--text-muted);">â€” Institut assurance maladie â€” Gestion statut BIM</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Forem/Actiris/VDAB</strong> <span style="color:var(--text-muted);">â€” Services rÃ©gionaux emploi â€” Absorption choc formations</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Paul Magnette</strong> <span style="color:var(--text-muted);">â€” PrÃ©sident PS â€” Opposition principale</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>PTB</strong> <span style="color:var(--text-muted);">â€” Parti gauche radicale â€” Alternatives budgÃ©taires chiffrÃ©es</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Ã‰colo/Groen</strong> <span style="color:var(--text-muted);">â€” Partis verts â€” Opposition Ã©cologique-sociale</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>IFDH</strong> <span style="color:var(--text-muted);">â€” Institut FÃ©dÃ©ral Droits Humains â€” Avis critiques sanctions malades</span></div>
                <span style="color:var(--ally)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>CNT</strong> <span style="color:var(--text-muted);">â€” Conseil National Travail â€” Concertation sociale</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>RTBF/VRT</strong> <span style="color:var(--text-muted);">â€” MÃ©dias publics â€” NeutralitÃ© relative</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Le Soir/De Standaard</strong> <span style="color:var(--text-muted);">â€” Presse de rÃ©fÃ©rence</span></div>
                <span style="color:var(--neutral)">â—</span>
            </div><div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                <div><strong>Vlaams Belang</strong> <span style="color:var(--text-muted);">â€” ExtrÃªme-droite â€” Risque rÃ©cupÃ©ration populiste</span></div>
                <span style="color:var(--opponent)">â—</span>
            </div></div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Arbre -->
                <section class="page" id="p-arbre">
                    <div class="page-intro">
                        <span class="help-icon" data-help="arbre">?</span>
                        <p>L'<strong>arbre Ã  problÃ¨mes</strong> identifie le problÃ¨me central, ses causes (racines) et consÃ©quences (branches).</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸŒ³ Arbre Ã  problÃ¨mes <span class="card-badge badge-juger">JUGER</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>ProblÃ¨me central</label>
                                <textarea data-field="arbre.probleme" placeholder="Le problÃ¨me principal..."></textarea>
                            </div>
                            <div class="field">
                                <label>Causes (racines)</label>
                                <textarea data-field="arbre.causes" placeholder="Pourquoi ce problÃ¨me existe ?"></textarea>
                            </div>
                            <div class="field">
                                <label>ConsÃ©quences (branches)</label>
                                <textarea data-field="arbre.consequences" placeholder="Quels effets produit-il ?"></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: 5 Pourquoi -->
                <section class="page" id="p-pourquoi">
                    <div class="page-intro">
                        <span class="help-icon" data-help="pourquoi">?</span>
                        <p>Les <strong>5 Pourquoi</strong> permettent de remonter aux causes profondes d'un problÃ¨me.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">â“ Les 5 Pourquoi <span class="card-badge badge-juger">JUGER</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field"><label>Pourquoi 1 ?</label><textarea data-field="pourquoi.p1" placeholder="Premier niveau..."></textarea></div>
                            <div class="field"><label>Pourquoi 2 ?</label><textarea data-field="pourquoi.p2" placeholder="Creusons..."></textarea></div>
                            <div class="field"><label>Pourquoi 3 ?</label><textarea data-field="pourquoi.p3" placeholder="Plus profond..."></textarea></div>
                            <div class="field"><label>Pourquoi 4 ?</label><textarea data-field="pourquoi.p4" placeholder="Encore..."></textarea></div>
                            <div class="field"><label>Pourquoi 5 ? (cause racine)</label><textarea data-field="pourquoi.p5" placeholder="La cause fondamentale..."></textarea></div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: SWOT -->
                <section class="page" id="p-swot">
                    <div class="page-intro">
                        <span class="help-icon" data-help="swot">?</span>
                        <p>L'analyse <strong>SWOT</strong> Ã©value les forces, faiblesses, opportunitÃ©s et menaces.</p>
                    </div>

                    <div class="swot-grid">
                        <div class="swot-card forces">
                            <div class="swot-title">ğŸ’ª Forces</div>
                            <div class="field"><textarea data-field="swot.forces" placeholder="Vos atouts internes..."></textarea></div>
                        </div>
                        <div class="swot-card faiblesses">
                            <div class="swot-title">âš ï¸ Faiblesses</div>
                            <div class="field"><textarea data-field="swot.faiblesses" placeholder="Vos limites internes..."></textarea></div>
                        </div>
                        <div class="swot-card opportunites">
                            <div class="swot-title">ğŸŒŸ OpportunitÃ©s</div>
                            <div class="field"><textarea data-field="swot.opportunites" placeholder="Contexte externe favorable..."></textarea></div>
                        </div>
                        <div class="swot-card menaces">
                            <div class="swot-title">ğŸŒ©ï¸ Menaces</div>
                            <div class="field"><textarea data-field="swot.menaces" placeholder="Risques externes..."></textarea></div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: PESTEL -->
                <section class="page" id="p-pestel">
                    <div class="page-intro">
                        <span class="help-icon" data-help="pestel">?</span>
                        <p>L'analyse <strong>PESTEL</strong> examine l'environnement macro : Politique, Ã‰conomique, Social, Technologique, Environnemental, LÃ©gal.</p>
                    </div>

                    <div class="grid-2">
                        <div class="card"><div class="card-body"><div class="field"><label>ğŸ›ï¸ Politique</label><textarea data-field="pestel.p" placeholder="..."></textarea></div></div></div>
                        <div class="card"><div class="card-body"><div class="field"><label>ğŸ’° Ã‰conomique</label><textarea data-field="pestel.e" placeholder="..."></textarea></div></div></div>
                        <div class="card"><div class="card-body"><div class="field"><label>ğŸ‘¥ Social</label><textarea data-field="pestel.s" placeholder="..."></textarea></div></div></div>
                        <div class="card"><div class="card-body"><div class="field"><label>ğŸ’» Technologique</label><textarea data-field="pestel.t" placeholder="..."></textarea></div></div></div>
                        <div class="card"><div class="card-body"><div class="field"><label>ğŸŒ¿ Environnemental</label><textarea data-field="pestel.en" placeholder="..."></textarea></div></div></div>
                        <div class="card"><div class="card-body"><div class="field"><label>âš–ï¸ LÃ©gal</label><textarea data-field="pestel.l" placeholder="..."></textarea></div></div></div>
                    </div>
                </section>

                <!-- PAGE: ThÃ©orie du changement -->
                <section class="page" id="p-tdc">
                    <div class="page-intro">
                        <span class="help-icon" data-help="tdc">?</span>
                        <p>La <strong>thÃ©orie du changement</strong> dÃ©crit comment et pourquoi le changement va advenir.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ”„ ThÃ©orie du changement <span class="card-badge badge-juger">JUGER</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>Situation actuelle</label>
                                <textarea data-field="tdc.actuelle" placeholder="OÃ¹ en sommes-nous ?"></textarea>
                            </div>
                            <div class="field">
                                <label>Situation souhaitÃ©e</label>
                                <textarea data-field="tdc.souhaitee" placeholder="OÃ¹ voulons-nous aller ?"></textarea>
                            </div>
                            <div class="field">
                                <label>MÃ©canismes de changement</label>
                                <textarea data-field="tdc.mecanismes" placeholder="Comment le changement va-t-il se produire ?"></textarea>
                            </div>
                            <div class="field">
                                <label>HypothÃ¨ses clÃ©s</label>
                                <textarea data-field="tdc.hypotheses" placeholder="Quelles sont nos hypothÃ¨ses ?"></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Pouvoir (Avec/Sans/Contre) -->
                <section class="page" id="p-pouvoir">
                    <div class="page-intro">
                        <span class="help-icon" data-help="pouvoir">?</span>
                        <p>Les <strong>modes d'action</strong> : travailler avec, sans ou contre le pouvoir en place.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">âš¡ Modes d'action <span class="card-badge badge-agir">AGIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>ğŸ¤ Avec le pouvoir</label>
                                <textarea data-field="pouvoir.avec" placeholder="Lobbying, nÃ©gociation, partenariats..."></textarea>
                            </div>
                            <div class="field">
                                <label>ğŸ”„ Sans le pouvoir</label>
                                <textarea data-field="pouvoir.sans" placeholder="Alternatives, projets pilotes..."></textarea>
                            </div>
                            <div class="field">
                                <label>âœŠ Contre le pouvoir</label>
                                <textarea data-field="pouvoir.contre" placeholder="Mobilisation, recours juridiques..."></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Cibles & AlliÃ©s -->
                <section class="page" id="p-cibles">
                    <div class="page-intro">
                        <span class="help-icon" data-help="cibles">?</span>
                        <p>Identifiez vos <strong>cibles</strong> (qui doit changer) et vos <strong>alliÃ©s</strong> stratÃ©giques.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ¯ Cibles &amp; AlliÃ©s <span class="card-badge badge-agir">AGIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>Cibles principales</label>
                                <textarea data-field="cibles.principales" placeholder="Qui a le pouvoir de dÃ©cider ?"></textarea>
                            </div>
                            <div class="field">
                                <label>Cibles secondaires</label>
                                <textarea data-field="cibles.secondaires" placeholder="Qui peut influencer les cibles principales ?"></textarea>
                            </div>
                            <div class="field">
                                <label>AlliÃ©s stratÃ©giques</label>
                                <textarea data-field="cibles.allies" placeholder="Avec qui s&#39;allier ?"></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: SMART -->
                <section class="page" id="p-smart">
                    <div class="page-intro">
                        <span class="help-icon" data-help="smart">?</span>
                        <p>Les objectifs <strong>SMART</strong> : SpÃ©cifiques, Mesurables, Atteignables, RÃ©alistes, Temporels.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">â• Nouvel objectif <span class="card-badge badge-agir">AGIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>Objectif</label>
                                <input type="text" id="smart-text" placeholder="Ex: Obtenir un moratoire...">
                            </div>
                            <div class="grid-3">
                                <div class="field">
                                    <label>Indicateur de mesure</label>
                                    <input type="text" id="smart-indicator" placeholder="Comment mesurer ?">
                                </div>
                                <div class="field">
                                    <label>Ã‰chÃ©ance</label>
                                    <input type="date" id="smart-deadline">
                                </div>
                                <div class="field">
                                    <label>Statut initial</label>
                                    <select id="smart-status">
                                        <option value="todo">ğŸ“‹ Ã€ faire</option>
                                        <option value="inprogress">ğŸ”„ En cours</option>
                                        <option value="done">âœ… TerminÃ©</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary" id="btn-add-smart">â• Ajouter l'objectif</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ¯ Objectifs (<span id="smart-count">0</span>)</h3>
                        </div>
                        <div class="card-body">
                            <!-- Stats rapides -->
                            <div class="smart-stats" id="smart-stats">
                                <div class="smart-stat todo">
                                    <span>ğŸ“‹</span>
                                    <span>Ã€ faire:</span>
                                    <span class="smart-stat-value" id="stat-todo">0</span>
                                </div>
                                <div class="smart-stat inprogress">
                                    <span>ğŸ”„</span>
                                    <span>En cours:</span>
                                    <span class="smart-stat-value" id="stat-inprogress">0</span>
                                </div>
                                <div class="smart-stat done">
                                    <span>âœ…</span>
                                    <span>TerminÃ©s:</span>
                                    <span class="smart-stat-value" id="stat-done">0</span>
                                </div>
                            </div>
                            
                            <!-- Onglets de vue -->
                            <div class="view-tabs">
                                <button class="view-tab active" data-smart-view="list">ğŸ“‹ Liste</button>
                                <button class="view-tab" data-smart-view="kanban">ğŸ“Š Kanban</button>
                                <button class="view-tab" data-smart-view="timeline">ğŸ“… Timeline</button>
                                <button class="view-tab" data-smart-view="gantt">ğŸ“ˆ Gantt</button>
                            </div>
                            
                            <!-- VUE LISTE -->
                            <div id="smart-view-list" class="smart-view-content">
                                <div class="smart-list" id="smart-list"></div>
                            </div>
                            
                            <!-- VUE KANBAN -->
                            <div id="smart-view-kanban" class="smart-view-content" style="display:none;">
                                <div class="kanban-board">
                                    <div class="kanban-column todo" data-status="todo">
                                        <div class="kanban-column-header">
                                            <span>ğŸ“‹ Ã€ faire</span>
                                            <span class="kanban-column-count" id="kanban-count-todo">0</span>
                                        </div>
                                        <div class="kanban-cards" id="kanban-todo"></div>
                                    </div>
                                    <div class="kanban-column inprogress" data-status="inprogress">
                                        <div class="kanban-column-header">
                                            <span>ğŸ”„ En cours</span>
                                            <span class="kanban-column-count" id="kanban-count-inprogress">0</span>
                                        </div>
                                        <div class="kanban-cards" id="kanban-inprogress"></div>
                                    </div>
                                    <div class="kanban-column done" data-status="done">
                                        <div class="kanban-column-header">
                                            <span>âœ… TerminÃ©</span>
                                            <span class="kanban-column-count" id="kanban-count-done">0</span>
                                        </div>
                                        <div class="kanban-cards" id="kanban-done"></div>
                                    </div>
                                </div>
                                <p style="font-size:0.8rem;color:var(--text-muted);margin-top:var(--space-3);text-align:center;">
                                    ğŸ’¡ Glissez-dÃ©posez les cartes entre les colonnes pour changer leur statut
                                </p>
                            </div>
                            
                            <!-- VUE TIMELINE -->
                            <div id="smart-view-timeline" class="smart-view-content" style="display:none;">
                                <div class="timeline-container" id="timeline-container">
                                    <div class="timeline-months" id="timeline-months"></div>
                                    <div class="timeline-track">
                                        <div class="timeline-progress" id="timeline-progress"></div>
                                        <div class="timeline-today" id="timeline-today"></div>
                                    </div>
                                    <div class="timeline-items" id="timeline-items"></div>
                                </div>
                            </div>
                            
                            <!-- VUE GANTT -->
                            <div id="smart-view-gantt" class="smart-view-content" style="display:none;">
                                <div class="gantt-container">
                                    <div id="gantt-chart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Message -->
                <section class="page" id="p-message">
                    <div class="page-intro">
                        <span class="help-icon" data-help="message">?</span>
                        <p>Construisez votre <strong>message clÃ©</strong> : accroche, problÃ¨me, solution, appel Ã  l'action.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ’¬ Message clÃ© <span class="card-badge badge-agir">AGIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>Accroche</label>
                                <input type="text" data-field="message.accroche" placeholder="Une phrase choc...">
                            </div>
                            <div class="field">
                                <label>ProblÃ¨me</label>
                                <textarea data-field="message.probleme" placeholder="Quel est le problÃ¨me ?"></textarea>
                            </div>
                            <div class="field">
                                <label>Pourquoi c'est important</label>
                                <textarea data-field="message.importance" placeholder="Pourquoi agir maintenant ?"></textarea>
                            </div>
                            <div class="field">
                                <label>Cible du message</label>
                                <input type="text" data-field="message.cible" placeholder="Ã€ qui s&#39;adresse-t-on ?">
                            </div>
                            <div class="field">
                                <label>Action demandÃ©e</label>
                                <textarea data-field="message.action" placeholder="Que demandez-vous concrÃ¨tement ?"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“ AperÃ§u du message</h3>
                        </div>
                        <div class="card-body">
                            <div id="message-preview" style="background:var(--bg-surface);padding:var(--space-4);border-radius:var(--radius-md);font-size:0.9rem;line-height:1.7;white-space:pre-wrap;">ğŸ£ ACCROCHE :

Â« En Belgique, 90.000 personnes vont perdre leur allocation de chÃ´mage d'ici 2027.

Pas parce qu'elles ont trouvÃ© un emploi.

Mais parce qu'un gouvernement a dÃ©cidÃ© que 24 mois, c'Ã©tait assez.

AprÃ¨s ? Les CPAS.

Et quand les CPAS n'auront plus les moyens ?

La rue. Â»

---

Variante statistique :
Â« 30.122 : c'est le nombre de familles belges qui basculeront vers l'aide sociale dÃ¨s 2026. Pas des chiffres. Des parents. Des enfants. Des vies. Â»

ğŸ” LE PROBLÃˆME :

Les rÃ©formes Arizona ne sont pas une "rÃ©forme du chÃ´mage". C'est un TRANSFERT ORGANISÃ‰ des responsabilitÃ©s :

â€¢ De l'Ã‰tat fÃ©dÃ©ral â†’ vers les communes
â€¢ De la solidaritÃ© nationale â†’ vers l'assistance locale
â€¢ De l'assurance â†’ vers la charitÃ©

Les 30.122 personnes qui basculeront immÃ©diatement vers le RIS ne sont pas des statistiques :
â€¢ Ce sont des parents de 50 ans, victimes de restructurations industrielles
â€¢ Ce sont des malades chroniques que le marchÃ© du travail ne veut plus
â€¢ Ce sont des mÃ¨res seules qui ont sacrifiÃ© leur carriÃ¨re

Et la thÃ©orie de l'"activation" qui prÃ©tend que supprimer une allocation suffit Ã  retrouver un emploi IGNORE sciemment la rÃ©alitÃ© : les freins sont la santÃ©, l'Ã¢ge, la mobilitÃ©, l'obsolescence des compÃ©tences, la discrimination Ã  l'embauche.

Ce n'est pas de l'Ã©conomie. C'est de l'idÃ©ologie.

Pourquoi c'est important : â— POURQUOI C'EST URGENT :

Sans action immÃ©diate :

â€¢ Les CPAS seront SATURÃ‰S
  â†’ DÃ©lai lÃ©gal de 30 jours intenable
  â†’ Familles sans AUCUNE ressource pendant des semaines

â€¢ La PAUVRETÃ‰ INFANTILE va exploser
  â†’ ChÃ´meurs de longue durÃ©e = souvent chefs de famille monoparentale

â€¢ Le RENONCEMENT AUX SOINS va augmenter
  â†’ Hausse ticket modÃ©rateur + dÃ©remboursements = "taxe santÃ©"

â€¢ Les TRAVAILLEURS SOCIAUX vont craquer
  â†’ Burn-out massif dÃ©jÃ  en cours
  â†’ Effondrement du service public de l'aide sociale

La Belgique, pays fondateur de la sÃ©curitÃ© sociale europÃ©enne, s'apprÃªte Ã  crÃ©er une nouvelle catÃ©gorie de pauvres : les "ORPHELINS DU CHÃ”MAGE".

2026 est l'annÃ©e de bascule. Ce qui ne sera pas empÃªchÃ© maintenant sera irrÃ©versible.

Nous demandons Ã  ğŸ¯ Ã€ QUI NOUS NOUS ADRESSONS :

â€¢ Ã€ la COUR CONSTITUTIONNELLE :
  "Vous Ãªtes la garante de l'article 23. Le principe de standstill n'est pas une abstraction juridique â€” c'est la promesse que la Belgique ne reculera pas sur la dignitÃ© humaine."

â€¢ Aux DÃ‰PUTÃ‰S de la majoritÃ© (Vooruit, EngagÃ©s) :
  "Vos Ã©lecteurs sont parmi les 90.000. Comment leur expliquerez-vous votre vote ? La loyautÃ© coalitionnelle vaut-elle plus que la dignitÃ© de vos concitoyens ?"

â€¢ Aux BOURGMESTRES et prÃ©sidents de CPAS :
  "Le fÃ©dÃ©ral vous transfÃ¨re la charge sans vous donner les moyens. 518â‚¬ par personne et par an ne couvre mÃªme pas une heure d'accompagnement social par semaine. Refusez d'Ãªtre les gestionnaires de la misÃ¨re."

â€¢ Ã€ L'OPINION PUBLIQUE :
  "Aujourd'hui ce sont les chÃ´meurs de longue durÃ©e. Demain ce pourrait Ãªtre vous, votre parent, votre enfant. La protection sociale, c'est l'assurance de ne jamais tomber dans le vide. Sans elle, nous sommes tous vulnÃ©rables." de ğŸ“¢ CE QUE NOUS DEMANDONS :

1ï¸âƒ£ Un MORATOIRE IMMÃ‰DIAT sur les exclusions
   â†’ Le temps de l'examen du recours constitutionnel
   â†’ Aucune famille ne doit basculer tant que la lÃ©galitÃ© n'est pas tranchÃ©e

2ï¸âƒ£ Une COMPENSATION INTÃ‰GRALE des CPAS
   â†’ 100% du surcoÃ»t rÃ©el, pas 518â‚¬ symboliques
   â†’ Inclure les frais de personnel supplÃ©mentaires

3ï¸âƒ£ L'ABANDON du systÃ¨me BONUS-MALUS
   â†’ ArrÃªter de punir les communes d'Ãªtre pauvres
   â†’ ReconnaÃ®tre les disparitÃ©s territoriales

4ï¸âƒ£ La SUPPRESSION des sanctions pour les malades
   â†’ Retrait de la rÃ©duction de 2,5% des indemnitÃ©s
   â†’ Accompagner au lieu de punir

---

âœŠ REJOIGNEZ-NOUS :
Manifestations â€¢ TÃ©moignages â€¢ Recours â€¢ SolidaritÃ©

#StopArizona #Article23 #DigniteHumaine.</div>
                            <button class="btn btn-secondary" id="btn-copy-message" style="margin-top:var(--space-3);">ğŸ“‹ Copier le message</button>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Ã‰valuation -->
                <section class="page" id="p-evaluation">
                    <div class="page-intro">
                        <span class="help-icon" data-help="evaluation">?</span>
                        <p>Le <strong>suivi-Ã©valuation</strong> mesure l'impact de vos actions.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“ˆ Suivi-Ã©valuation <span class="card-badge badge-agir">AGIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>Indicateurs de succÃ¨s</label>
                                <textarea data-field="evaluation.indicateurs" placeholder="Comment mesurer l&#39;impact ?"></textarea>
                            </div>
                            <div class="field">
                                <label>MÃ©thodes de collecte</label>
                                <textarea data-field="evaluation.methodes" placeholder="Comment collecter les donnÃ©es ?"></textarea>
                            </div>
                            <div class="field">
                                <label>Calendrier d'Ã©valuation</label>
                                <textarea data-field="evaluation.calendrier" placeholder="Quand Ã©valuer ?"></textarea>
                            </div>
                            <div class="field">
                                <label>LeÃ§ons Ã  documenter</label>
                                <textarea data-field="evaluation.lecons" placeholder="Quoi apprendre pour la suite ?"></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Journal -->
                <section class="page" id="p-journal">
                    <div class="page-intro">
                        <span class="help-icon" data-help="journal">?</span>
                        <p>Le <strong>journal de bord</strong> documente votre parcours militant.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">â• Nouvelle entrÃ©e <span class="card-badge badge-agir">AGIR</span></h3>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label>Date</label>
                                <input type="date" id="journal-date">
                            </div>
                            <div class="field">
                                <label>Contenu</label>
                                <textarea id="journal-content" placeholder="Ã‰vÃ©nement, rÃ©flexion, leÃ§on..."></textarea>
                            </div>
                            <button class="btn btn-primary" id="btn-add-journal">â• Ajouter</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ““ EntrÃ©es (<span id="journal-count">0</span>)</h3>
                        </div>
                        <div class="card-body">
                            <div class="journal-timeline" id="journal-list"><div style="color:var(--text-muted);text-align:center;padding:var(--space-4);">Aucune entrÃ©e</div></div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Export -->
                <section class="page" id="p-export">
                    <div class="page-intro">
                        <p>Importez ou exportez votre projet dans diffÃ©rents formats.</p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“¤ Exporter</h3>
                        </div>
                        <div class="card-body">
                            <div class="export-grid">
                                <div class="export-card" data-export="json">
                                    <div class="export-icon">ğŸ“‹</div>
                                    <div class="export-name">JSON</div>
                                    <div class="export-ext">.json</div>
                                </div>
                                <div class="export-card" data-export="md">
                                    <div class="export-icon">ğŸ“</div>
                                    <div class="export-name">Markdown</div>
                                    <div class="export-ext">.md</div>
                                </div>
                                <div class="export-card" data-export="html">
                                    <div class="export-icon">ğŸŒ</div>
                                    <div class="export-name">HTML</div>
                                    <div class="export-ext">.html</div>
                                </div>
                                <div class="export-card" data-export="csv">
                                    <div class="export-icon">ğŸ“Š</div>
                                    <div class="export-name">CSV</div>
                                    <div class="export-ext">.csv</div>
                                </div>
                                <div class="export-card" data-export="pdf" style="border-color:var(--lilac-400);">
                                    <div class="export-icon">ğŸ“„</div>
                                    <div class="export-name" style="color:var(--lilac-300);">PDF</div>
                                    <div class="export-ext">Rapport stylisÃ©</div>
                                </div>
                                <div class="export-card" data-export="docx" style="border-color:var(--mint-400);">
                                    <div class="export-icon">ğŸ“˜</div>
                                    <div class="export-name" style="color:var(--mint-300);">Word</div>
                                    <div class="export-ext">.docx</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“¥ Importer</h3>
                        </div>
                        <div class="card-body">
                            <div class="drop-zone" id="drop-zone">
                                <div class="drop-zone-icon">ğŸ“</div>
                                <div class="drop-zone-text">Glissez un fichier ou cliquez</div>
                                <div class="drop-zone-hint">Formats acceptÃ©s : JSON</div>
                                <input type="file" id="import-file" accept=".json" style="display:none">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- PAGE: Ressources -->
                <section class="page" id="p-ressources">
                    <div class="page-intro">
                        <p>Guides mÃ©thodologiques et ressources pour approfondir.</p>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">ğŸ“– Guides</h3></div>
                            <div class="card-body">
                                <ul style="list-style:none;">
                                    <li style="margin-bottom:var(--space-3);"><a href="https://www.justicepaix.be/" target="_blank" style="color:var(--mint-300);">ğŸ”— Justice et Paix â€” Guide du Plaidoyer</a></li>
                                    <li style="margin-bottom:var(--space-3);"><a href="https://www.voxpublic.org/" target="_blank" style="color:var(--mint-300);">ğŸ”— VoxPublic</a></li>
                                    <li><a href="https://bond.org.uk/resources/advocacy-toolkit/" target="_blank" style="color:var(--mint-300);">ğŸ”— BOND UK â€” Advocacy Toolkit</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">ğŸ›ï¸ Institutions BE</h3></div>
                            <div class="card-body">
                                <ul style="list-style:none;">
                                    <li style="margin-bottom:var(--space-3);"><a href="https://www.lachambre.be/" target="_blank" style="color:var(--lilac-300);">ğŸ”— Chambre des ReprÃ©sentants</a></li>
                                    <li style="margin-bottom:var(--space-3);"><a href="https://www.senate.be/" target="_blank" style="color:var(--lilac-300);">ğŸ”— SÃ©nat</a></li>
                                    <li><a href="https://www.belgium.be/" target="_blank" style="color:var(--lilac-300);">ğŸ”— Belgium.be</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>
</div>

<!-- MODALS -->

<!-- Modal: Nouveau projet -->
<div class="modal-overlay" id="modal-create">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">âœ¨ Nouveau projet</h3>
            <button class="modal-close" data-close="modal-create">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="field">
                <label>Nom du projet</label>
                <input type="text" id="create-name" placeholder="Ex: Campagne logement 2026">
            </div>
            <div class="field">
                <label>Description (optionnel)</label>
                <textarea id="create-desc" placeholder="En quelques mots..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" data-close="modal-create">Annuler</button>
            <button class="btn btn-primary" id="btn-create-confirm">CrÃ©er</button>
        </div>
    </div>
</div>

<!-- Modal: Recherche -->
<div class="modal-overlay" id="modal-search">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">ğŸ” Rechercher</h3>
            <button class="modal-close" data-close="modal-search">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="field">
                <input type="text" id="search-input" placeholder="Tapez votre recherche...">
            </div>
            <div id="search-results"></div>
        </div>
    </div>
</div>

<!-- Modal: Raccourcis -->
<div class="modal-overlay" id="modal-shortcuts">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">âŒ¨ï¸ Raccourcis clavier</h3>
            <button class="modal-close" data-close="modal-shortcuts">Ã—</button>
        </div>
        <div class="modal-body">
            <table style="width:100%;font-size:0.85rem;">
                <tbody><tr><td style="padding:var(--space-2);"><kbd style="background:var(--bg-surface);padding:2px 8px;border-radius:4px;">Ctrl</kbd> + <kbd style="background:var(--bg-surface);padding:2px 8px;border-radius:4px;">K</kbd></td><td>Rechercher</td></tr>
                <tr><td style="padding:var(--space-2);"><kbd style="background:var(--bg-surface);padding:2px 8px;border-radius:4px;">Ctrl</kbd> + <kbd style="background:var(--bg-surface);padding:2px 8px;border-radius:4px;">S</kbd></td><td>Sauvegarder</td></tr>
                <tr><td style="padding:var(--space-2);"><kbd style="background:var(--bg-surface);padding:2px 8px;border-radius:4px;">Esc</kbd></td><td>Fermer</td></tr>
            </tbody></table>
        </div>
    </div>
</div>

<!-- Help Tooltip -->
<div class="help-tooltip" id="help-tooltip">
    <h4><span id="help-title"></span></h4>
    <div id="help-content"></div>
    <div class="dismiss">Cliquez ailleurs ou <kbd>Esc</kbd> pour fermer</div>
</div>

<!-- Toasts -->
<div id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// #B!Mi PLAIDOYER CITOYEN â€” ULTIMATE v4.0
// IndexedDB + LocalStorage fallback â€¢ Multi-projets â€¢ 15 outils
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const esc = s => s ? s.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELP CONTENT â€” Non-invasif, adulte
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const HELP = {
    dashboard: { title: 'ğŸ“Š Tableau de bord', content: '<p>Vue d\'ensemble de votre projet : progression par phase, statistiques clÃ©s.</p><p>Les pourcentages reflÃ¨tent le remplissage des champs de chaque section.</p>' },
    domino: { title: 'ğŸ¯ Le Domino du changement', content: '<p>Outil de clarification stratÃ©gique.</p><ul><li><strong>Vision</strong> : le changement concret souhaitÃ©</li><li><strong>Obstacles</strong> : freins identifiÃ©s</li><li><strong>Ressources</strong> : forces mobilisables</li></ul>' },
    profil: { title: 'ğŸ‘¤ Profil d\'engagement', content: '<p>Faites le point sur vos motivations, compÃ©tences et limites. Essentiel pour calibrer votre engagement sur la durÃ©e.</p>' },
    fleur: { title: 'ğŸŒ¸ Fleur du pouvoir', content: '<p>Analyse des rapports de pouvoir : qui sont les personnes concernÃ©es ? Quels privilÃ¨ges et quelles oppressions sont en jeu ?</p>' },
    acteurs: { title: 'ğŸ‘¥ Cartographie des acteurs', content: '<p>Identifiez toutes les parties prenantes. La matrice Pouvoir/IntÃ©rÃªt aide Ã  prioriser vos interactions.</p><ul><li><strong>Q1</strong> : Pouvoir Ã©levÃ© + IntÃ©rÃªt â†’ GÃ©rer de prÃ¨s</li><li><strong>Q2</strong> : Pouvoir Ã©levÃ© + Peu d\'intÃ©rÃªt â†’ Garder satisfait</li><li><strong>Q3</strong> : Pouvoir faible + IntÃ©rÃªt â†’ Garder informÃ©</li><li><strong>Q4</strong> : Pouvoir faible + Peu d\'intÃ©rÃªt â†’ Surveiller</li></ul>' },
    arbre: { title: 'ğŸŒ³ Arbre Ã  problÃ¨mes', content: '<p>MÃ©thode visuelle : le tronc = problÃ¨me central, les racines = causes, les branches = consÃ©quences.</p>' },
    pourquoi: { title: 'â“ Les 5 Pourquoi', content: '<p>Technique simple pour remonter aux causes profondes. Ã€ chaque rÃ©ponse, demandez "pourquoi ?" jusqu\'Ã  atteindre la cause racine.</p>' },
    swot: { title: 'ğŸ“ Analyse SWOT', content: '<p>Matrice classique : <strong>S</strong>trengths (forces), <strong>W</strong>eaknesses (faiblesses), <strong>O</strong>pportunities (opportunitÃ©s), <strong>T</strong>hreats (menaces).</p>' },
    pestel: { title: 'ğŸŒ Analyse PESTEL', content: '<p>Balayage de l\'environnement macro : <strong>P</strong>olitique, <strong>E</strong>conomique, <strong>S</strong>ocial, <strong>T</strong>echnologique, <strong>E</strong>nvironnemental, <strong>L</strong>Ã©gal.</p>' },
    tdc: { title: 'ğŸ”„ ThÃ©orie du changement', content: '<p>Explicitez le "comment" : de la situation actuelle Ã  la situation souhaitÃ©e, quels mÃ©canismes et hypothÃ¨ses ?</p>' },
    pouvoir: { title: 'âš¡ Avec/Sans/Contre', content: '<p>Trois postures stratÃ©giques :</p><ul><li><strong>Avec</strong> : collaboration, lobbying</li><li><strong>Sans</strong> : alternatives parallÃ¨les</li><li><strong>Contre</strong> : opposition, mobilisation</li></ul>' },
    cibles: { title: 'ğŸ¯ Cibles & AlliÃ©s', content: '<p>Qui a le pouvoir de dÃ©cision (cible principale) ? Qui peut l\'influencer (cible secondaire) ? Avec qui s\'allier ?</p>' },
    smart: { title: 'ğŸ“‹ Objectifs SMART', content: '<p><strong>S</strong>pÃ©cifique, <strong>M</strong>esurable, <strong>A</strong>tteignable, <strong>R</strong>Ã©aliste, <strong>T</strong>emporel. Chaque objectif doit rÃ©pondre Ã  ces 5 critÃ¨res.</p>' },
    message: { title: 'ğŸ’¬ Message clÃ©', content: '<p>Structure classique : accroche â†’ problÃ¨me â†’ importance â†’ cible â†’ action demandÃ©e. Court, mÃ©morable, actionnable.</p>' },
    evaluation: { title: 'ğŸ“ˆ Suivi-Ã©valuation', content: '<p>DÃ©finissez vos indicateurs de succÃ¨s, comment les collecter, et Ã  quel rythme Ã©valuer. Documentez les leÃ§ons apprises.</p>' },
    journal: { title: 'ğŸ““ Journal de bord', content: '<p>Chronique de votre parcours militant : Ã©vÃ©nements, rÃ©flexions, victoires et Ã©checs. PrÃ©cieux pour la mÃ©moire collective.</p>' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATABASE â€” IndexedDB avec fallback localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let db = null;
const DB_NAME = 'BimiPlaidoyerDB';
const DB_VERSION = 1;
const STORE_NAME = 'projects';

function openDB() {
    return new Promise((resolve, reject) => {
        if (!window.indexedDB) {
            console.warn('IndexedDB non disponible, fallback localStorage');
            resolve(null);
            return;
        }
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => { console.warn('IndexedDB error, fallback localStorage'); resolve(null); };
        req.onsuccess = () => { db = req.result; resolve(db); };
        req.onupgradeneeded = (e) => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains(STORE_NAME)) {
                d.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };
    });
}

async function dbGetAll() {
    if (db) {
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => resolve([]);
        });
    }
    // Fallback localStorage
    try {
        const data = localStorage.getItem('bimi_projects');
        return data ? JSON.parse(data) : [];
    } catch { return []; }
}

async function dbGet(id) {
    if (db) {
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).get(id);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => resolve(null);
        });
    }
    const all = await dbGetAll();
    return all.find(p => p.id === id);
}

async function dbPut(project) {
    if (db) {
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(project);
            tx.oncomplete = () => resolve(true);
            tx.onerror = () => resolve(false);
        });
    }
    // Fallback localStorage
    try {
        const all = await dbGetAll();
        const idx = all.findIndex(p => p.id === project.id);
        if (idx >= 0) all[idx] = project; else all.push(project);
        localStorage.setItem('bimi_projects', JSON.stringify(all));
        return true;
    } catch { return false; }
}

async function dbDelete(id) {
    if (db) {
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).delete(id);
            tx.oncomplete = () => resolve(true);
        });
    }
    try {
        const all = await dbGetAll();
        const filtered = all.filter(p => p.id !== id);
        localStorage.setItem('bimi_projects', JSON.stringify(filtered));
        return true;
    } catch { return false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROJECT MODEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let P = null; // Current project
let saveTimeout = null;

function newProject(name, desc = '') {
    return {
        id: Date.now().toString(),
        meta: { name, description: desc, created: new Date().toISOString(), updated: new Date().toISOString() },
        domino: {}, profil: {}, fleur: {},
        acteurs: [], arbre: {}, pourquoi: {},
        swot: {}, pestel: {}, tdc: {},
        pouvoir: {}, cibles: {}, message: {},
        evaluation: {}, smart: [], journal: []
    };
}

function scheduleSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
        if (P) {
            P.meta.updated = new Date().toISOString();
            await dbPut(P);
            $('status-badge').textContent = 'â— SauvegardÃ©';
            setTimeout(() => $('status-badge').textContent = 'â— PrÃªt', 1500);
        }
    }, 800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI â€” Navigation & Pages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showPage(pageId) {
    $$('.page').forEach(p => p.classList.remove('active'));
    const page = $(`p-${pageId}`);
    if (page) page.classList.add('active');
    
    $$('.nav-btn').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
    if (btn) btn.classList.add('active');
    
    // Fermer sidebar mobile
    $('sidebar').classList.remove('open');
    $('sidebar-overlay').classList.remove('open');
}

function openModal(id) {
    $(id)?.classList.add('open');
}

function closeModal(id) {
    $(id)?.classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI â€” Projects List
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function renderProjects() {
    const projects = await dbGetAll();
    const list = $('projects-list');
    
    if (!projects.length) {
        list.innerHTML = '<div style="color:var(--text-muted);font-size:0.8rem;padding:var(--space-2);">Aucun projet</div>';
        return;
    }
    
    list.innerHTML = projects.map(p => `
        <div class="project-row ${P && P.id === p.id ? 'selected' : ''}" data-id="${p.id}">
            <span class="name">${esc(p.meta?.name || 'Sans nom')}</span>
            <div class="actions">
                <button class="dup" title="Dupliquer">ğŸ“‹</button>
                <button class="del" title="Supprimer">ğŸ—‘ï¸</button>
            </div>
        </div>
    `).join('');
    
    // Events
    list.querySelectorAll('.project-row').forEach(row => {
        row.addEventListener('click', (e) => {
            if (e.target.classList.contains('del')) {
                if (confirm('Supprimer ce projet ?')) {
                    dbDelete(row.dataset.id).then(() => {
                        if (P && P.id === row.dataset.id) { P = null; showPage('empty'); }
                        renderProjects();
                        toast('Projet supprimÃ©', 'info');
                    });
                }
            } else if (e.target.classList.contains('dup')) {
                dbGet(row.dataset.id).then(async (orig) => {
                    if (orig) {
                        const copy = JSON.parse(JSON.stringify(orig));
                        copy.id = Date.now().toString();
                        copy.meta.name += ' (copie)';
                        copy.meta.created = new Date().toISOString();
                        await dbPut(copy);
                        await selectProject(copy.id);
                        toast('Projet dupliquÃ©', 'success');
                    }
                });
            } else {
                selectProject(row.dataset.id);
            }
        });
    });
}

async function selectProject(id) {
    P = await dbGet(id);
    if (!P) return;
    
    await renderProjects();
    $('project-title').textContent = P.meta?.name || 'Projet';
    
    // Restore ALL fields from project data
    $$('[data-field]').forEach(el => {
        const parts = el.dataset.field.split('.');
        if (parts.length === 2) {
            const [section, key] = parts;
            const value = P[section]?.[key] || '';
            el.value = value;
        }
    });
    
    // Debug: log loaded data
    console.log('Project loaded:', {
        name: P.meta?.name,
        domino: P.domino,
        acteurs: P.acteurs?.length,
        swot: P.swot,
        message: P.message
    });
    
    renderActors();
    renderSmart();
    renderJournal();
    updateStats();
    updateMessagePreview();
    
    showPage('dashboard');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function addActor() {
    if (!P) return toast('CrÃ©ez d\'abord un projet', 'warning');
    
    const name = $('actor-name').value.trim();
    if (!name) return toast('Entrez un nom', 'error');
    
    P.acteurs = P.acteurs || [];
    P.acteurs.push({
        id: Date.now(),
        name,
        role: $('actor-role').value.trim(),
        position: $('actor-position').value,
        power: parseInt($('actor-power').value),
        quadrant: null // sera calculÃ© automatiquement
    });
    
    $('actor-name').value = '';
    $('actor-role').value = '';
    
    renderActors();
    updateNetworkGraph();
    updateLinkSelectors();
    scheduleSave();
    toast('Acteur ajoutÃ©', 'success');
}

// Variables globales pour le graphe
let networkInstance = null;

function renderActors() {
    if (!P) return;
    P.acteurs = P.acteurs || [];
    P.links = P.links || [];
    
    // Clear quadrants
    ['q1', 'q2', 'q3', 'q4'].forEach(q => {
        const el = $(`actors-${q}`);
        if (el) el.innerHTML = '';
    });
    
    P.acteurs.forEach(a => {
        const chip = document.createElement('span');
        chip.className = `actor-chip ${a.position} draggable`;
        chip.textContent = a.name;
        chip.title = `${a.role || a.name}\nPouvoir: ${a.power}/5\nClic droit pour supprimer`;
        chip.draggable = true;
        chip.dataset.actorId = a.id;
        
        // Drag events
        chip.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', a.id);
            chip.classList.add('dragging');
        });
        chip.addEventListener('dragend', () => {
            chip.classList.remove('dragging');
        });
        
        // Context menu pour supprimer
        chip.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (confirm(`Supprimer ${a.name} ?`)) {
                P.acteurs = P.acteurs.filter(x => x.id !== a.id);
                P.links = P.links.filter(l => l.from !== a.id && l.to !== a.id);
                renderActors();
                updateNetworkGraph();
                updateLinkSelectors();
                renderLinks();
                scheduleSave();
            }
        });
        
        // DÃ©terminer le quadrant
        let quadrant = a.quadrant;
        if (!quadrant) {
            const highPower = a.power >= 4;
            const interested = a.position === 'ally' || a.position === 'target';
            if (highPower && interested) quadrant = 'q1';
            else if (highPower && !interested) quadrant = 'q2';
            else if (!highPower && interested) quadrant = 'q3';
            else quadrant = 'q4';
        }
        
        const container = $(`actors-${quadrant}`);
        if (container) container.appendChild(chip);
    });
    
    // Setup drop zones
    setupDropZones();
    
    // List
    const list = $('actors-list');
    if (list) {
        if (!P.acteurs.length) {
            list.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:var(--space-4);">Aucun acteur</div>';
        } else {
            list.innerHTML = P.acteurs.map(a => {
                const colors = { ally: 'var(--ally)', opponent: 'var(--opponent)', target: 'var(--target)', neutral: 'var(--neutral)' };
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:var(--space-2) 0;border-bottom:1px solid var(--border-subtle);font-size:0.85rem;">
                    <div><strong>${esc(a.name)}</strong> <span style="color:var(--text-muted);">â€” ${esc(a.role || '')}</span></div>
                    <div style="display:flex;align-items:center;gap:var(--space-2);">
                        <span style="font-size:0.75rem;color:var(--text-muted);">${'â—'.repeat(a.power)}${'â—‹'.repeat(5-a.power)}</span>
                        <span style="color:${colors[a.position] || colors.neutral}">â—</span>
                    </div>
                </div>`;
            }).join('');
        }
    }
    
    const countEl = $('actors-count');
    if (countEl) countEl.textContent = P.acteurs.length;
    updateStats();
}

function setupDropZones() {
    const quadrants = document.querySelectorAll('.matrix-quad');
    quadrants.forEach(quad => {
        quad.addEventListener('dragover', (e) => {
            e.preventDefault();
            quad.classList.add('drag-over');
        });
        quad.addEventListener('dragleave', () => {
            quad.classList.remove('drag-over');
        });
        quad.addEventListener('drop', (e) => {
            e.preventDefault();
            quad.classList.remove('drag-over');
            const actorId = parseInt(e.dataTransfer.getData('text/plain'));
            const actor = P.acteurs.find(a => a.id === actorId);
            if (actor) {
                // Extraire q1, q2, q3, q4 de l'id
                const quadrant = quad.id.replace('quad-', '');
                const qMap = { manage: 'q1', satisfy: 'q2', inform: 'q3', monitor: 'q4' };
                actor.quadrant = qMap[quadrant] || 'q4';
                renderActors();
                scheduleSave();
                toast(`${actor.name} dÃ©placÃ©`, 'success');
            }
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRAPHE RÃ‰SEAU VIS.JS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initNetworkGraph() {
    const container = $('network-graph');
    if (!container || typeof vis === 'undefined') return;
    
    const options = {
        nodes: {
            shape: 'dot',
            font: { color: '#e8e8f0', size: 12, face: 'Arial' },
            borderWidth: 2,
            shadow: true
        },
        edges: {
            width: 2,
            smooth: { type: 'curvedCW', roundness: 0.2 },
            arrows: { to: { enabled: true, scaleFactor: 0.5 } }
        },
        physics: {
            enabled: true,
            barnesHut: {
                gravitationalConstant: -3000,
                centralGravity: 0.3,
                springLength: 150,
                springConstant: 0.04
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 100,
            navigationButtons: false,
            keyboard: true
        }
    };
    
    networkInstance = new vis.Network(container, { nodes: [], edges: [] }, options);
    
    // Double-clic pour Ã©diter
    networkInstance.on('doubleClick', (params) => {
        if (params.nodes.length > 0) {
            const actorId = params.nodes[0];
            const actor = P.acteurs.find(a => a.id === actorId);
            if (actor) {
                const newRole = prompt(`Modifier le rÃ´le de ${actor.name}:`, actor.role || '');
                if (newRole !== null) {
                    actor.role = newRole;
                    updateNetworkGraph();
                    renderActors();
                    scheduleSave();
                }
            }
        }
    });
}

function updateNetworkGraph() {
    if (!networkInstance || !P) return;
    
    P.acteurs = P.acteurs || [];
    P.links = P.links || [];
    
    const colorMap = {
        ally: '#48bb78',
        target: '#f6ad55',
        opponent: '#fc8181',
        neutral: '#a0aec0'
    };
    
    const nodes = P.acteurs.map(a => ({
        id: a.id,
        label: a.name,
        title: `${a.name}\n${a.role || ''}\nPouvoir: ${a.power}/5`,
        color: {
            background: colorMap[a.position] || colorMap.neutral,
            border: colorMap[a.position] || colorMap.neutral,
            highlight: { background: '#fff', border: colorMap[a.position] }
        },
        size: 10 + (a.power * 5),
        font: { color: '#e8e8f0' }
    }));
    
    const edgeColorMap = {
        influence: '#63b3ed',
        alliance: '#48bb78',
        opposition: '#fc8181'
    };
    
    const edges = P.links.map((l, i) => ({
        id: i,
        from: l.from,
        to: l.to,
        color: { color: edgeColorMap[l.type] || '#63b3ed', highlight: '#fff' },
        dashes: l.type === 'influence',
        title: l.type
    }));
    
    networkInstance.setData({ nodes, edges });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTION DES LIENS ENTRE ACTEURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentLinkType = 'influence';

function updateLinkSelectors() {
    if (!P) return;
    P.acteurs = P.acteurs || [];
    
    const fromSelect = $('link-from');
    const toSelect = $('link-to');
    if (!fromSelect || !toSelect) return;
    
    const options = P.acteurs.map(a => `<option value="${a.id}">${esc(a.name)}</option>`).join('');
    fromSelect.innerHTML = options || '<option disabled>Aucun acteur</option>';
    toSelect.innerHTML = options || '<option disabled>Aucun acteur</option>';
}

function addLink() {
    if (!P) return;
    P.links = P.links || [];
    
    const from = parseInt($('link-from').value);
    const to = parseInt($('link-to').value);
    
    if (!from || !to) return toast('SÃ©lectionnez deux acteurs', 'error');
    if (from === to) return toast('Un acteur ne peut pas Ãªtre liÃ© Ã  lui-mÃªme', 'error');
    
    // VÃ©rifier si le lien existe dÃ©jÃ 
    const exists = P.links.some(l => l.from === from && l.to === to && l.type === currentLinkType);
    if (exists) return toast('Ce lien existe dÃ©jÃ ', 'warning');
    
    P.links.push({ from, to, type: currentLinkType });
    
    renderLinks();
    updateNetworkGraph();
    scheduleSave();
    toast('Relation ajoutÃ©e', 'success');
}

function removeLink(index) {
    if (!P || !P.links) return;
    P.links.splice(index, 1);
    renderLinks();
    updateNetworkGraph();
    scheduleSave();
}

function renderLinks() {
    if (!P) return;
    P.links = P.links || [];
    
    const list = $('links-list');
    if (!list) return;
    
    if (!P.links.length) {
        list.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:var(--space-3);">Aucune relation dÃ©finie</p>';
        return;
    }
    
    const getActorName = (id) => {
        const a = P.acteurs.find(x => x.id === id);
        return a ? a.name : '?';
    };
    
    const typeLabels = { influence: 'ğŸ’¡', alliance: 'ğŸ¤', opposition: 'âš”ï¸' };
    
    list.innerHTML = P.links.map((l, i) => `
        <div class="link-item ${l.type}">
            <div class="link-item-content">
                <span>${esc(getActorName(l.from))}</span>
                <span class="link-arrow">${typeLabels[l.type] || 'â†’'}</span>
                <span>${esc(getActorName(l.to))}</span>
            </div>
            <span class="link-delete" onclick="removeLink(${i})">âœ•</span>
        </div>
    `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONGLETS DE VUE ACTEURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchActorView(view) {
    // Masquer toutes les vues
    ['matrix', 'network', 'links'].forEach(v => {
        const el = $(`view-${v}`);
        if (el) el.style.display = 'none';
    });
    
    // Afficher la vue sÃ©lectionnÃ©e
    const targetView = $(`view-${view}`);
    if (targetView) targetView.style.display = 'block';
    
    // Mettre Ã  jour les onglets
    document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === view);
    });
    
    // Si vue rÃ©seau, initialiser/mettre Ã  jour le graphe
    if (view === 'network') {
        if (!networkInstance) {
            initNetworkGraph();
        }
        updateNetworkGraph();
        setTimeout(() => networkInstance?.fit(), 100);
    }
    
    // Si vue liens, mettre Ã  jour les sÃ©lecteurs
    if (view === 'links') {
        updateLinkSelectors();
        renderLinks();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART Objectives
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function addSmart() {
    if (!P) return toast('CrÃ©ez d\'abord un projet', 'warning');
    
    const text = $('smart-text').value.trim();
    if (!text) return toast('Entrez un objectif', 'error');
    
    P.smart = P.smart || [];
    P.smart.push({
        id: Date.now(),
        text,
        indicator: $('smart-indicator').value.trim(),
        deadline: $('smart-deadline').value,
        status: $('smart-status')?.value || 'todo',
        done: $('smart-status')?.value === 'done'
    });
    
    $('smart-text').value = '';
    $('smart-indicator').value = '';
    $('smart-deadline').value = '';
    if ($('smart-status')) $('smart-status').value = 'todo';
    
    renderSmart();
    scheduleSave();
    toast('Objectif ajoutÃ©', 'success');
}

function toggleSmart(id) {
    if (!P) return;
    const obj = P.smart?.find(s => s.id === id);
    if (obj) {
        obj.done = !obj.done;
        obj.status = obj.done ? 'done' : 'todo';
        renderSmart();
        scheduleSave();
    }
}

function updateSmartStatus(id, newStatus) {
    if (!P) return;
    const obj = P.smart?.find(s => s.id === id);
    if (obj) {
        obj.status = newStatus;
        obj.done = newStatus === 'done';
        renderSmart();
        scheduleSave();
    }
}

function deleteSmart(id) {
    if (!P) return;
    if (confirm('Supprimer cet objectif ?')) {
        P.smart = P.smart.filter(s => s.id !== id);
        renderSmart();
        scheduleSave();
    }
}

// Variable pour stocker la vue courante
let currentSmartView = 'list';

function switchSmartView(view) {
    currentSmartView = view;
    
    // Masquer toutes les vues
    ['list', 'kanban', 'timeline', 'gantt'].forEach(v => {
        const el = $(`smart-view-${v}`);
        if (el) el.style.display = 'none';
    });
    
    // Afficher la vue sÃ©lectionnÃ©e
    const targetView = $(`smart-view-${view}`);
    if (targetView) targetView.style.display = 'block';
    
    // Mettre Ã  jour les onglets
    document.querySelectorAll('[data-smart-view]').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.smartView === view);
    });
    
    // Render spÃ©cifique si nÃ©cessaire
    if (view === 'kanban') renderKanban();
    if (view === 'timeline') renderTimeline();
    if (view === 'gantt') renderGantt();
}

function renderSmart() {
    if (!P) return;
    P.smart = P.smart || [];
    
    // Migrer les anciens objets sans status
    P.smart.forEach(s => {
        if (!s.status) {
            s.status = s.done ? 'done' : 'todo';
        }
    });
    
    // Stats
    const stats = { todo: 0, inprogress: 0, done: 0 };
    P.smart.forEach(s => stats[s.status || 'todo']++);
    
    if ($('stat-todo')) $('stat-todo').textContent = stats.todo;
    if ($('stat-inprogress')) $('stat-inprogress').textContent = stats.inprogress;
    if ($('stat-done')) $('stat-done').textContent = stats.done;
    
    // Vue Liste
    const list = $('smart-list');
    if (list) {
        if (!P.smart.length) {
            list.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:var(--space-4);">Aucun objectif â€” Ajoutez votre premier objectif SMART ci-dessus</div>';
        } else {
            list.innerHTML = P.smart.map(s => {
                const statusIcon = s.status === 'done' ? 'âœ…' : s.status === 'inprogress' ? 'ğŸ”„' : 'ğŸ“‹';
                const deadlineClass = getDeadlineClass(s.deadline);
                return `
                <div class="smart-item ${s.done ? 'done' : ''}" data-id="${s.id}">
                    <input type="checkbox" ${s.done ? 'checked' : ''} onchange="toggleSmart(${s.id})">
                    <div class="smart-content">
                        <div class="smart-text">${esc(s.text)}</div>
                        <div class="smart-meta">
                            <span title="Statut">${statusIcon}</span>
                            ${s.indicator ? `<span>ğŸ“Š ${esc(s.indicator)}</span>` : ''}
                            ${s.deadline ? `<span class="${deadlineClass}">ğŸ“… ${formatDate(s.deadline)}</span>` : ''}
                            <span class="smart-delete" onclick="deleteSmart(${s.id})" style="cursor:pointer;margin-left:auto;" title="Supprimer">ğŸ—‘ï¸</span>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
    }
    
    if ($('smart-count')) $('smart-count').textContent = P.smart.length;
    
    // Mettre Ã  jour la vue courante
    if (currentSmartView === 'kanban') renderKanban();
    if (currentSmartView === 'timeline') renderTimeline();
    if (currentSmartView === 'gantt') renderGantt();
    
    updateStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KANBAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderKanban() {
    if (!P) return;
    P.smart = P.smart || [];
    
    const columns = { todo: [], inprogress: [], done: [] };
    P.smart.forEach(s => {
        const status = s.status || (s.done ? 'done' : 'todo');
        if (columns[status]) columns[status].push(s);
    });
    
    ['todo', 'inprogress', 'done'].forEach(status => {
        const container = $(`kanban-${status}`);
        const countEl = $(`kanban-count-${status}`);
        if (!container) return;
        
        if (countEl) countEl.textContent = columns[status].length;
        
        container.innerHTML = columns[status].map(s => {
            const deadlineClass = getDeadlineClass(s.deadline);
            return `
            <div class="kanban-card" draggable="true" data-id="${s.id}">
                <div class="kanban-card-title">${esc(s.text)}</div>
                <div class="kanban-card-meta">
                    ${s.deadline ? `<span class="kanban-card-deadline ${deadlineClass}">ğŸ“… ${formatDate(s.deadline)}</span>` : '<span></span>'}
                    <span onclick="deleteSmart(${s.id})" style="cursor:pointer;" title="Supprimer">ğŸ—‘ï¸</span>
                </div>
            </div>
        `}).join('') || '<div style="color:var(--text-muted);text-align:center;padding:var(--space-3);font-size:0.8rem;">Vide</div>';
    });
    
    setupKanbanDragDrop();
}

function setupKanbanDragDrop() {
    // Cartes draggables
    document.querySelectorAll('.kanban-card[draggable="true"]').forEach(card => {
        card.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', card.dataset.id);
            card.classList.add('dragging');
        });
        card.addEventListener('dragend', () => {
            card.classList.remove('dragging');
        });
    });
    
    // Colonnes drop zones
    document.querySelectorAll('.kanban-column').forEach(col => {
        col.addEventListener('dragover', (e) => {
            e.preventDefault();
            col.classList.add('drag-over');
        });
        col.addEventListener('dragleave', () => {
            col.classList.remove('drag-over');
        });
        col.addEventListener('drop', (e) => {
            e.preventDefault();
            col.classList.remove('drag-over');
            const id = parseInt(e.dataTransfer.getData('text/plain'));
            const newStatus = col.dataset.status;
            if (id && newStatus) {
                updateSmartStatus(id, newStatus);
                toast(`Objectif dÃ©placÃ© vers "${newStatus === 'todo' ? 'Ã€ faire' : newStatus === 'inprogress' ? 'En cours' : 'TerminÃ©'}"`, 'success');
            }
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderTimeline() {
    if (!P) return;
    P.smart = P.smart || [];
    
    const now = new Date();
    const items = P.smart
        .filter(s => s.deadline)
        .map(s => ({ ...s, deadlineDate: new Date(s.deadline) }))
        .sort((a, b) => a.deadlineDate - b.deadlineDate);
    
    // GÃ©nÃ©rer les mois (6 mois avant Ã  6 mois aprÃ¨s)
    const monthsEl = $('timeline-months');
    if (monthsEl) {
        const months = [];
        for (let i = -2; i <= 9; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            const isCurrent = d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            months.push(`<div class="timeline-month ${isCurrent ? 'current' : ''}">${d.toLocaleDateString('fr-BE', { month: 'short' })}</div>`);
        }
        monthsEl.innerHTML = months.join('');
    }
    
    // Position du marqueur "aujourd'hui" (sur 12 mois)
    const todayEl = $('timeline-today');
    if (todayEl) {
        const position = (2 / 12) * 100; // 2 mois depuis le dÃ©but
        todayEl.style.left = `${position}%`;
    }
    
    // Items de la timeline
    const itemsEl = $('timeline-items');
    if (itemsEl) {
        if (!items.length) {
            itemsEl.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:var(--space-4);">Aucun objectif avec Ã©chÃ©ance</div>';
        } else {
            itemsEl.innerHTML = items.map(s => {
                const deadlineClass = getDeadlineClass(s.deadline);
                const statusClass = s.done ? 'done' : deadlineClass;
                const daysLeft = Math.ceil((s.deadlineDate - now) / (1000 * 60 * 60 * 24));
                const daysText = daysLeft < 0 ? `${Math.abs(daysLeft)} jours de retard` : 
                                 daysLeft === 0 ? "Aujourd'hui" :
                                 daysLeft === 1 ? 'Demain' : `Dans ${daysLeft} jours`;
                
                return `
                <div class="timeline-item ${statusClass}">
                    <div class="timeline-item-date">
                        ${formatDate(s.deadline)}
                        <div style="font-size:0.7rem;font-weight:400;margin-top:2px;">${daysText}</div>
                    </div>
                    <div class="timeline-item-content">
                        <div class="timeline-item-title">${esc(s.text)}</div>
                        ${s.indicator ? `<div class="timeline-item-indicator">ğŸ“Š ${esc(s.indicator)}</div>` : ''}
                    </div>
                    <select onchange="updateSmartStatus(${s.id}, this.value)" style="font-size:0.8rem;padding:4px 8px;border-radius:4px;background:var(--bg-surface);border:1px solid var(--border-subtle);color:var(--text-primary);">
                        <option value="todo" ${s.status === 'todo' ? 'selected' : ''}>ğŸ“‹ Ã€ faire</option>
                        <option value="inprogress" ${s.status === 'inprogress' ? 'selected' : ''}>ğŸ”„ En cours</option>
                        <option value="done" ${s.status === 'done' ? 'selected' : ''}>âœ… TerminÃ©</option>
                    </select>
                </div>
            `}).join('');
        }
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GANTT (MERMAID)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderGantt() {
    if (!P || typeof mermaid === 'undefined') return;
    P.smart = P.smart || [];
    
    const chartEl = $('gantt-chart');
    if (!chartEl) return;
    
    const itemsWithDeadline = P.smart.filter(s => s.deadline);
    
    if (!itemsWithDeadline.length) {
        chartEl.innerHTML = '<div class="gantt-empty">ğŸ“… Ajoutez des objectifs avec Ã©chÃ©ance pour voir le diagramme Gantt</div>';
        return;
    }
    
    // Trier par date
    itemsWithDeadline.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
    
    // GÃ©nÃ©rer le code Mermaid
    const today = new Date().toISOString().split('T')[0];
    let mermaidCode = `gantt
    title Planning des objectifs
    dateFormat YYYY-MM-DD
    todayMarker stroke-width:3px,stroke:#fc8181
`;
    
    // Sections par statut
    const sections = {
        'Ã€ faire': itemsWithDeadline.filter(s => s.status === 'todo'),
        'En cours': itemsWithDeadline.filter(s => s.status === 'inprogress'),
        'TerminÃ©': itemsWithDeadline.filter(s => s.status === 'done' || s.done)
    };
    
    Object.entries(sections).forEach(([sectionName, items]) => {
        if (items.length) {
            mermaidCode += `    section ${sectionName}\n`;
            items.forEach((s, i) => {
                // CrÃ©er une tÃ¢che de 30 jours avant l'Ã©chÃ©ance jusqu'Ã  l'Ã©chÃ©ance
                const endDate = new Date(s.deadline);
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 30);
                
                const taskName = s.text.substring(0, 40).replace(/[:\[\]]/g, ' ') + (s.text.length > 40 ? '...' : '');
                const status = s.done ? 'done,' : s.status === 'inprogress' ? 'active,' : '';
                
                mermaidCode += `    ${taskName} :${status} task${s.id}, ${startDate.toISOString().split('T')[0]}, ${s.deadline}\n`;
            });
        }
    });
    
    // Render avec Mermaid
    chartEl.innerHTML = `<pre class="mermaid">${mermaidCode}</pre>`;
    
    try {
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#48bb78',
                primaryTextColor: '#e8e8f0',
                primaryBorderColor: '#48bb78',
                lineColor: '#a0aec0',
                sectionBkgColor: '#2d2d3a',
                altSectionBkgColor: '#1a1a2e',
                taskBkgColor: '#48bb78',
                taskTextColor: '#1a1a2e',
                taskBorderColor: '#38a169',
                doneTaskBkgColor: '#38a169',
                activeTaskBkgColor: '#f6ad55',
                activeTaskBorderColor: '#ed8936',
                gridColor: '#4a5568',
                todayLineColor: '#fc8181'
            },
            gantt: {
                titleTopMargin: 25,
                barHeight: 30,
                barGap: 8,
                topPadding: 50,
                leftPadding: 100,
                gridLineStartPadding: 35,
                fontSize: 12,
                sectionFontSize: 14,
                numberSectionStyles: 4
            }
        });
        mermaid.run({ nodes: chartEl.querySelectorAll('.mermaid') });
    } catch (e) {
        console.warn('Mermaid render error:', e);
        chartEl.innerHTML = '<div class="gantt-empty">Erreur de rendu du diagramme</div>';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITAIRES DATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString('fr-BE', { day: 'numeric', month: 'short', year: 'numeric' });
}

function getDeadlineClass(deadline) {
    if (!deadline) return '';
    const now = new Date();
    const d = new Date(deadline);
    const daysLeft = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
    
    if (daysLeft < 0) return 'overdue';
    if (daysLeft <= 7) return 'soon';
    return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOURNAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function addJournal() {
    if (!P) return toast('CrÃ©ez d\'abord un projet', 'warning');
    
    const content = $('journal-content').value.trim();
    if (!content) return toast('Entrez du contenu', 'error');
    
    P.journal = P.journal || [];
    P.journal.unshift({
        id: Date.now(),
        date: $('journal-date').value || new Date().toISOString().split('T')[0],
        content
    });
    
    $('journal-content').value = '';
    
    renderJournal();
    scheduleSave();
    toast('EntrÃ©e ajoutÃ©e', 'success');
}

function renderJournal() {
    if (!P) return;
    P.journal = P.journal || [];
    
    const list = $('journal-list');
    if (!P.journal.length) {
        list.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:var(--space-4);">Aucune entrÃ©e</div>';
    } else {
        list.innerHTML = P.journal.map(j => `
            <div class="journal-entry">
                <div class="journal-date">${j.date}</div>
                <div class="journal-text">${esc(j.content)}</div>
            </div>
        `).join('');
    }
    
    $('journal-count').textContent = P.journal.length;
    updateStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGE PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateMessagePreview() {
    if (!P) return;
    const m = P.message || {};
    const preview = `${m.accroche || '[Accroche]'}

${m.probleme || '[ProblÃ¨me]'}

Pourquoi c'est important : ${m.importance || '[Importance]'}

Nous demandons Ã  ${m.cible || '[Cible]'} de ${m.action || '[Action demandÃ©e]'}.`;
    
    $('message-preview').textContent = preview;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS & PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateStats() {
    if (!P) return;
    
    // Helper: compte les champs non vides d'un objet
    const countFilled = (obj) => {
        if (!obj || typeof obj !== 'object') return 0;
        let count = 0;
        for (const v of Object.values(obj)) {
            if (v && typeof v === 'string' && v.trim().length > 0) {
                count++;
            }
        }
        return count;
    };
    
    // VOIR: domino (3) + profil (4) + fleur (3) = 10 champs max
    const voirFilled = countFilled(P.domino) + countFilled(P.profil) + countFilled(P.fleur);
    const voirPct = Math.min(100, Math.round((voirFilled / 10) * 100));
    
    // JUGER: arbre (3) + pourquoi (5) + swot (4) + pestel (6) + tdc (4) = 22 champs + bonus acteurs
    const jugerFilled = countFilled(P.arbre) + countFilled(P.pourquoi) + countFilled(P.swot) + countFilled(P.pestel) + countFilled(P.tdc);
    const jugerBonus = Math.min(4, P.acteurs?.length || 0); // 1 point par acteur, max 4
    const jugerPct = Math.min(100, Math.round(((jugerFilled + jugerBonus) / 26) * 100));
    
    // AGIR: pouvoir (3) + cibles (3) + message (5) + evaluation (4) = 15 champs + bonus smart/journal
    const agirFilled = countFilled(P.pouvoir) + countFilled(P.cibles) + countFilled(P.message) + countFilled(P.evaluation);
    const agirBonus = Math.min(3, P.smart?.length || 0) + Math.min(2, P.journal?.length || 0);
    const agirPct = Math.min(100, Math.round(((agirFilled + agirBonus) / 20) * 100));
    
    const globalPct = Math.round((voirPct + jugerPct + agirPct) / 3);
    
    // Debug
    console.log('ğŸ“Š Stats update:', {
        voir: `${voirFilled}/10 = ${voirPct}%`,
        juger: `${jugerFilled}+${jugerBonus}/26 = ${jugerPct}%`,
        agir: `${agirFilled}+${agirBonus}/20 = ${agirPct}%`,
        global: `${globalPct}%`,
        details: {
            domino: countFilled(P.domino),
            profil: countFilled(P.profil),
            fleur: countFilled(P.fleur),
            arbre: countFilled(P.arbre),
            pourquoi: countFilled(P.pourquoi),
            swot: countFilled(P.swot),
            pestel: countFilled(P.pestel),
            tdc: countFilled(P.tdc),
            pouvoir: countFilled(P.pouvoir),
            cibles: countFilled(P.cibles),
            message: countFilled(P.message),
            evaluation: countFilled(P.evaluation),
            acteurs: P.acteurs?.length || 0,
            smart: P.smart?.length || 0
        }
    });
    
    // Update UI
    $('progress-voir').style.width = voirPct + '%';
    $('progress-voir-val').textContent = voirPct + '%';
    $('progress-juger').style.width = jugerPct + '%';
    $('progress-juger-val').textContent = jugerPct + '%';
    $('progress-agir').style.width = agirPct + '%';
    $('progress-agir-val').textContent = agirPct + '%';
    
    // Score circle
    const circumference = 264;
    const offset = circumference - (globalPct / 100) * circumference;
    $('score-circle').style.strokeDashoffset = offset;
    $('score-value').textContent = globalPct + '%';
    
    // Stats cards
    $('stat-actors').textContent = P.acteurs?.length || 0;
    $('stat-smart').textContent = P.smart?.length || 0;
    $('stat-journal').textContent = P.journal?.length || 0;
    $('stat-fields').textContent = voirFilled + jugerFilled + agirFilled;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function doExport(format) {
    if (!P) return toast('Aucun projet sÃ©lectionnÃ©', 'warning');
    
    const filename = `plaidoyer_${P.meta?.name?.replace(/[^a-z0-9]/gi, '_') || 'projet'}_${new Date().toISOString().split('T')[0]}`;
    let content, type;
    
    switch (format) {
        case 'json':
            content = JSON.stringify(P, null, 2);
            type = 'application/json';
            break;
        case 'md':
            content = generateMarkdown();
            type = 'text/markdown';
            break;
        case 'html':
            content = generateHTML();
            type = 'text/html';
            break;
        case 'csv':
            content = generateCSV();
            type = 'text/csv';
            break;
        case 'pdf':
            generatePDF();
            return;
        case 'docx':
            generateDOCX(filename);
            return;
        default: return;
    }
    
    downloadFile(content, `${filename}.${format}`, type);
    toast(`Export ${format.toUpperCase()} rÃ©ussi`, 'success');
}

function generatePDF() {
    // Open a new window with the styled HTML for printing
    const printContent = generatePrintableHTML();
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // Wait for content to load then trigger print
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
        }, 500);
    };
    
    toast('FenÃªtre d\'impression ouverte â€” Enregistrez en PDF', 'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÃ‰NÃ‰RATION DOCX â€” v4.1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function generateDOCX(filename) {
    const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, 
            HeadingLevel, AlignmentType, BorderStyle, WidthType, ShadingType,
            PageBreak, Header, Footer, PageNumber } = docx;
    
    const date = new Date().toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' });
    const projectName = P.meta?.name || 'Projet de Plaidoyer';
    
    // Couleurs
    const COLORS = {
        voir: '4299E1', juger: 'ED8936', agir: '38A169',
        ally: '38A169', opponent: 'E53E3E', target: 'DD6B20', neutral: '718096',
        mint: '48BB78', lilac: '9F7AEA', dark: '1A1A2E', muted: '718096'
    };
    
    // Helper: crÃ©er des paragraphes Ã  partir de texte multiligne
    const textToParagraphs = (text, style = {}) => {
        if (!text) return [];
        return String(text).split('\n').filter(line => line.trim()).map(line => 
            new Paragraph({
                children: [new TextRun({ text: line, ...style })],
                spacing: { after: 120 }
            })
        );
    };
    
    // Helper: section avec titre et contenu
    const makeSection = (title, emoji, data, fields, color) => {
        if (!hasContent(data)) return [];
        const items = [];
        
        // Titre de section
        items.push(new Paragraph({
            children: [new TextRun({ text: `${emoji} ${title}`, bold: true, size: 28, color: color })],
            spacing: { before: 400, after: 200 },
            border: { bottom: { style: BorderStyle.SINGLE, size: 12, color: color } }
        }));
        
        // Champs
        fields.forEach(k => {
            if (data[k] && String(data[k]).trim()) {
                // Label du champ
                items.push(new Paragraph({
                    children: [new TextRun({ text: getFieldLabel(title.toLowerCase().includes('message') ? 'message' : k, k).toUpperCase(), bold: true, size: 20, color: COLORS.lilac })],
                    spacing: { before: 200, after: 80 }
                }));
                // Contenu
                items.push(...textToParagraphs(data[k], { size: 22 }));
            }
        });
        
        return items;
    };
    
    // Construire le document
    const children = [];
    
    // â•â•â• PAGE DE GARDE â•â•â•
    children.push(
        new Paragraph({ children: [], spacing: { after: 1000 } }),
        new Paragraph({
            children: [new TextRun({ text: 'ğŸ—³ï¸', size: 72 })],
            alignment: AlignmentType.CENTER
        }),
        new Paragraph({
            children: [new TextRun({ text: projectName, bold: true, size: 48, color: COLORS.dark })],
            alignment: AlignmentType.CENTER,
            spacing: { before: 400, after: 200 }
        }),
        new Paragraph({
            children: [new TextRun({ text: 'Rapport de Plaidoyer Citoyen', size: 28, color: COLORS.muted, italics: true })],
            alignment: AlignmentType.CENTER,
            spacing: { after: 600 }
        }),
        new Paragraph({
            children: [new TextRun({ text: `ExportÃ© le ${date}`, size: 22, color: COLORS.muted })],
            alignment: AlignmentType.CENTER
        }),
        new Paragraph({
            children: [new TextRun({ text: `${P.acteurs?.length || 0} acteurs â€¢ ${P.smart?.length || 0} objectifs`, size: 22, color: COLORS.mint })],
            alignment: AlignmentType.CENTER,
            spacing: { before: 200 }
        }),
        new Paragraph({ children: [new PageBreak()] })
    );
    
    // â•â•â• PHASE VOIR â•â•â•
    children.push(new Paragraph({
        children: [new TextRun({ text: 'ğŸ”µ PHASE 1 : VOIR', bold: true, size: 36, color: COLORS.voir })],
        spacing: { after: 100 }
    }));
    children.push(new Paragraph({
        children: [new TextRun({ text: 'Observer, comprendre, ressentir', italics: true, size: 22, color: COLORS.muted })],
        spacing: { after: 300 }
    }));
    
    children.push(...makeSection('Vision (Domino)', 'ğŸ¯', P.domino, ['vision', 'obstacles', 'ressources'], COLORS.voir));
    children.push(...makeSection('Profil Citoyen', 'ğŸ‘¤', P.profil, ['motivations', 'competences', 'temps', 'limites'], COLORS.voir));
    children.push(...makeSection('Fleur du Pouvoir', 'ğŸŒ¸', P.fleur, ['identites', 'privileges', 'oppressions'], COLORS.voir));
    
    children.push(new Paragraph({ children: [new PageBreak()] }));
    
    // â•â•â• PHASE JUGER â•â•â•
    children.push(new Paragraph({
        children: [new TextRun({ text: 'ğŸŸ  PHASE 2 : JUGER', bold: true, size: 36, color: COLORS.juger })],
        spacing: { after: 100 }
    }));
    children.push(new Paragraph({
        children: [new TextRun({ text: 'Analyser, diagnostiquer, prioriser', italics: true, size: 22, color: COLORS.muted })],
        spacing: { after: 300 }
    }));
    
    // Tableau des acteurs
    if (P.acteurs?.length) {
        children.push(new Paragraph({
            children: [new TextRun({ text: 'ğŸ‘¥ Cartographie des Acteurs', bold: true, size: 28, color: COLORS.juger })],
            spacing: { before: 400, after: 200 },
            border: { bottom: { style: BorderStyle.SINGLE, size: 12, color: COLORS.juger } }
        }));
        
        const border = { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' };
        const borders = { top: border, bottom: border, left: border, right: border };
        
        const actorsTable = new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            rows: [
                new TableRow({
                    children: ['Acteur', 'RÃ´le', 'Position', 'Pouvoir'].map(h => 
                        new TableCell({
                            children: [new Paragraph({ children: [new TextRun({ text: h, bold: true, size: 20 })] })],
                            shading: { fill: 'EDF2F7', type: ShadingType.CLEAR },
                            borders,
                            margins: { top: 80, bottom: 80, left: 120, right: 120 }
                        })
                    )
                }),
                ...P.acteurs.map(a => new TableRow({
                    children: [
                        new TableCell({
                            children: [new Paragraph({ children: [new TextRun({ text: a.name, bold: true, size: 20 })] })],
                            borders, margins: { top: 60, bottom: 60, left: 120, right: 120 }
                        }),
                        new TableCell({
                            children: [new Paragraph({ children: [new TextRun({ text: a.role || '-', size: 20 })] })],
                            borders, margins: { top: 60, bottom: 60, left: 120, right: 120 }
                        }),
                        new TableCell({
                            children: [new Paragraph({ children: [new TextRun({ 
                                text: a.position === 'ally' ? 'ğŸ¤ AlliÃ©' : a.position === 'opponent' ? 'âš”ï¸ Opposant' : a.position === 'target' ? 'ğŸ¯ Cible' : 'âš–ï¸ Neutre',
                                size: 20, color: COLORS[a.position] || COLORS.neutral
                            })] })],
                            borders, margins: { top: 60, bottom: 60, left: 120, right: 120 }
                        }),
                        new TableCell({
                            children: [new Paragraph({ children: [new TextRun({ text: 'â—'.repeat(a.power||3) + 'â—‹'.repeat(5-(a.power||3)), size: 20 })] })],
                            borders, margins: { top: 60, bottom: 60, left: 120, right: 120 }
                        })
                    ]
                }))
            ]
        });
        children.push(actorsTable);
        children.push(new Paragraph({ children: [], spacing: { after: 200 } }));
    }
    
    children.push(...makeSection('Arbre Ã  ProblÃ¨mes', 'ğŸŒ³', P.arbre, ['probleme', 'causes', 'consequences'], COLORS.juger));
    children.push(...makeSection('Les 5 Pourquoi', 'â“', P.pourquoi, ['p1', 'p2', 'p3', 'p4', 'p5'], COLORS.juger));
    children.push(...makeSection('Analyse SWOT', 'ğŸ“Š', P.swot, ['forces', 'faiblesses', 'opportunites', 'menaces'], COLORS.juger));
    children.push(...makeSection('Analyse PESTEL', 'ğŸŒ', P.pestel, ['p', 'e', 's', 't', 'en', 'l'], COLORS.juger));
    children.push(...makeSection('ThÃ©orie du Changement', 'ğŸ”„', P.tdc, ['actuelle', 'souhaitee', 'mecanismes', 'hypotheses'], COLORS.juger));
    
    children.push(new Paragraph({ children: [new PageBreak()] }));
    
    // â•â•â• PHASE AGIR â•â•â•
    children.push(new Paragraph({
        children: [new TextRun({ text: 'ğŸŸ¢ PHASE 3 : AGIR', bold: true, size: 36, color: COLORS.agir })],
        spacing: { after: 100 }
    }));
    children.push(new Paragraph({
        children: [new TextRun({ text: 'Planifier, mobiliser, Ã©valuer', italics: true, size: 22, color: COLORS.muted })],
        spacing: { after: 300 }
    }));
    
    children.push(...makeSection('StratÃ©gies de Pouvoir', 'âš¡', P.pouvoir, ['avec', 'sans', 'contre'], COLORS.agir));
    children.push(...makeSection('Cibles & AlliÃ©s', 'ğŸ¯', P.cibles, ['principales', 'secondaires', 'allies'], COLORS.agir));
    children.push(...makeSection('Message ClÃ©', 'ğŸ’¬', P.message, ['accroche', 'probleme', 'importance', 'cible', 'action'], COLORS.agir));
    
    // Objectifs SMART
    if (P.smart?.length) {
        children.push(new Paragraph({
            children: [new TextRun({ text: 'âœ… Objectifs SMART', bold: true, size: 28, color: COLORS.agir })],
            spacing: { before: 400, after: 200 },
            border: { bottom: { style: BorderStyle.SINGLE, size: 12, color: COLORS.agir } }
        }));
        
        P.smart.forEach(s => {
            children.push(new Paragraph({
                children: [
                    new TextRun({ text: s.done ? 'âœ… ' : 'â¬œ ', size: 22 }),
                    new TextRun({ text: s.text, bold: true, size: 22 })
                ],
                spacing: { before: 150 }
            }));
            if (s.indicator) {
                children.push(new Paragraph({
                    children: [new TextRun({ text: `    ğŸ“ ${s.indicator}`, size: 20, color: COLORS.muted })],
                    spacing: { after: 60 }
                }));
            }
            if (s.deadline) {
                children.push(new Paragraph({
                    children: [new TextRun({ text: `    ğŸ“… Ã‰chÃ©ance : ${s.deadline}`, size: 20, color: COLORS.lilac })],
                    spacing: { after: 100 }
                }));
            }
        });
    }
    
    children.push(...makeSection('Suivi & Ã‰valuation', 'ğŸ“ˆ', P.evaluation, ['indicateurs', 'methodes', 'calendrier', 'lecons'], COLORS.agir));
    
    // Journal de bord
    if (P.journal?.length) {
        children.push(new Paragraph({
            children: [new TextRun({ text: 'ğŸ“” Journal de Bord', bold: true, size: 28, color: COLORS.agir })],
            spacing: { before: 400, after: 200 },
            border: { bottom: { style: BorderStyle.SINGLE, size: 12, color: COLORS.agir } }
        }));
        
        P.journal.forEach(j => {
            children.push(new Paragraph({
                children: [new TextRun({ text: `ğŸ“… ${j.date}`, bold: true, size: 22, color: COLORS.lilac })],
                spacing: { before: 200 }
            }));
            children.push(...textToParagraphs(j.content, { size: 22 }));
        });
    }
    
    // â•â•â• FOOTER â•â•â•
    children.push(new Paragraph({ children: [], spacing: { before: 600 } }));
    children.push(new Paragraph({
        children: [new TextRun({ text: 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', color: 'CCCCCC' })],
        alignment: AlignmentType.CENTER
    }));
    children.push(new Paragraph({
        children: [new TextRun({ text: 'GÃ©nÃ©rÃ© par #B!Mi Plaidoyer Citoyen', size: 18, color: COLORS.muted })],
        alignment: AlignmentType.CENTER,
        spacing: { before: 100 }
    }));
    
    // CrÃ©er le document
    const doc = new Document({
        styles: {
            default: {
                document: { run: { font: 'Arial', size: 22 } }
            }
        },
        sections: [{
            properties: {
                page: {
                    size: { width: 11906, height: 16838 }, // A4
                    margin: { top: 1134, right: 1134, bottom: 1134, left: 1134 } // ~2cm
                }
            },
            headers: {
                default: new Header({
                    children: [new Paragraph({
                        children: [new TextRun({ text: projectName, size: 18, color: COLORS.muted })],
                        alignment: AlignmentType.RIGHT
                    })]
                })
            },
            footers: {
                default: new Footer({
                    children: [new Paragraph({
                        children: [
                            new TextRun({ text: 'Page ', size: 18, color: COLORS.muted }),
                            new TextRun({ children: [PageNumber.CURRENT], size: 18, color: COLORS.muted })
                        ],
                        alignment: AlignmentType.CENTER
                    })]
                })
            },
            children
        }]
    });
    
    // GÃ©nÃ©rer et tÃ©lÃ©charger
    try {
        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.docx`;
        a.click();
        URL.revokeObjectURL(url);
        toast('Export DOCX rÃ©ussi !', 'success');
    } catch (err) {
        console.error('Erreur DOCX:', err);
        toast('Erreur lors de la gÃ©nÃ©ration du DOCX', 'error');
    }
}

function generatePrintableHTML() {
    const date = new Date().toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' });
    const projectName = P.meta?.name || 'Projet de Plaidoyer';
    
    // Count stats
    const voirFilled = countFilledFields(P.domino) + countFilledFields(P.profil) + countFilledFields(P.fleur);
    const jugerFilled = countFilledFields(P.arbre) + countFilledFields(P.pourquoi) + countFilledFields(P.swot) + countFilledFields(P.pestel) + countFilledFields(P.tdc);
    const agirFilled = countFilledFields(P.pouvoir) + countFilledFields(P.cibles) + countFilledFields(P.message) + countFilledFields(P.evaluation);
    
    function countFilledFields(obj) {
        if (!obj) return 0;
        return Object.values(obj).filter(v => v && String(v).trim()).length;
    }
    
    function formatText(text) {
        if (!text) return '';
        return String(text)
            .replace(/\n/g, '<br>')
            .replace(/â€¢/g, '&#8226;')
            .replace(/â†’/g, '&rarr;');
    }
    
    function renderSection(title, obj, emoji = 'ğŸ“‹') {
        if (!obj) return '';
        const entries = Object.entries(obj).filter(([_, v]) => v && String(v).trim());
        if (!entries.length) return '';
        
        return `
            <div class="section">
                <h2>${emoji} ${title}</h2>
                ${entries.map(([k, v]) => `
                    <div class="field">
                        <div class="field-label">${k.charAt(0).toUpperCase() + k.slice(1)}</div>
                        <div class="field-value">${formatText(v)}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    return `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>${projectName} â€” Rapport de Plaidoyer</title>
    <style>
        @page { size: A4; margin: 2cm; }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #1a1a2e;
            background: white;
            margin: 0;
            padding: 20px;
        }
        
        .cover {
            text-align: center;
            padding: 60px 20px;
            border-bottom: 4px solid #48bb78;
            margin-bottom: 40px;
            page-break-after: always;
        }
        
        .logo {
            font-size: 48px;
            font-weight: bold;
            background: linear-gradient(135deg, #48bb78, #9f7aea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }
        
        .cover h1 {
            font-size: 28pt;
            color: #1a1a2e;
            margin: 20px 0;
            line-height: 1.2;
        }
        
        .cover .date {
            color: #666;
            font-size: 12pt;
            margin-top: 30px;
        }
        
        .stats-grid {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 40px;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px 25px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 24pt;
            font-weight: bold;
            color: #48bb78;
        }
        
        .stat-label {
            font-size: 9pt;
            color: #666;
            text-transform: uppercase;
        }
        
        .toc {
            page-break-after: always;
        }
        
        .toc h2 {
            color: #9f7aea;
            border-bottom: 2px solid #9f7aea;
            padding-bottom: 10px;
        }
        
        .toc ul {
            list-style: none;
            padding: 0;
        }
        
        .toc li {
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            display: flex;
            justify-content: space-between;
        }
        
        .phase-header {
            background: linear-gradient(135deg, #f0fff4, #faf5ff);
            padding: 15px 20px;
            border-left: 4px solid;
            margin: 30px 0 20px;
            page-break-before: always;
        }
        
        .phase-header.voir { border-color: #63b3ed; }
        .phase-header.juger { border-color: #f6ad55; }
        .phase-header.agir { border-color: #68d391; }
        
        .phase-header h1 {
            margin: 0;
            font-size: 18pt;
        }
        
        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .section h2 {
            color: #48bb78;
            font-size: 14pt;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .field {
            margin-bottom: 15px;
        }
        
        .field-label {
            font-weight: 600;
            color: #9f7aea;
            font-size: 10pt;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .field-value {
            color: #333;
            padding-left: 15px;
            border-left: 2px solid #e0e0e0;
        }
        
        .actors-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 10pt;
        }
        
        .actors-table th, .actors-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        .actors-table th {
            background: #f8f8f8;
            font-weight: 600;
        }
        
        .actors-table tr:nth-child(even) {
            background: #fafafa;
        }
        
        .position-ally { color: #38a169; }
        .position-opponent { color: #e53e3e; }
        .position-neutral { color: #718096; }
        .position-target { color: #9f7aea; }
        
        .smart-list {
            list-style: none;
            padding: 0;
        }
        
        .smart-item {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
            page-break-inside: avoid;
        }
        
        .smart-item.done {
            background: #f0fff4;
            border-color: #68d391;
        }
        
        .smart-checkbox {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #48bb78;
            border-radius: 4px;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .smart-item.done .smart-checkbox {
            background: #48bb78;
        }
        
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            font-size: 9pt;
            color: #666;
        }
        
        @media print {
            body { padding: 0; }
            .cover { page-break-after: always; }
            .phase-header { page-break-before: always; }
        }
    </style>
</head>
<body>
    <!-- COVER PAGE -->
    <div class="cover">
        <div class="logo">#B!Mi</div>
        <h1>${projectName}</h1>
        <p style="font-size: 14pt; color: #666;">Rapport de Plaidoyer Citoyen</p>
        <div class="date">GÃ©nÃ©rÃ© le ${date}</div>
        
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value">${P.acteurs?.length || 0}</div>
                <div class="stat-label">Acteurs</div>
            </div>
            <div class="stat-box">
                <div class="stat-value">${P.smart?.length || 0}</div>
                <div class="stat-label">Objectifs</div>
            </div>
            <div class="stat-box">
                <div class="stat-value">${voirFilled + jugerFilled + agirFilled}</div>
                <div class="stat-label">Champs</div>
            </div>
        </div>
    </div>
    
    <!-- PHASE VOIR -->
    <div class="phase-header voir">
        <h1>ğŸ”µ PHASE 1 : VOIR</h1>
        <p style="margin:5px 0 0;color:#666;">Observer, comprendre, ressentir</p>
    </div>
    
    ${renderSection('Domino du Changement', P.domino, 'ğŸ¯')}
    ${renderSection('Profil Citoyen', P.profil, 'ğŸ‘¤')}
    ${renderSection('Fleur du Pouvoir', P.fleur, 'ğŸŒ¸')}
    
    <!-- PHASE JUGER -->
    <div class="phase-header juger">
        <h1>ğŸŸ  PHASE 2 : JUGER</h1>
        <p style="margin:5px 0 0;color:#666;">Analyser, diagnostiquer, prioriser</p>
    </div>
    
    ${P.acteurs?.length ? `
    <div class="section">
        <h2>ğŸ‘¥ Cartographie des Acteurs</h2>
        <table class="actors-table">
            <thead>
                <tr>
                    <th>Acteur</th>
                    <th>RÃ´le</th>
                    <th>Position</th>
                    <th>Pouvoir</th>
                </tr>
            </thead>
            <tbody>
                ${P.acteurs.map(a => `
                    <tr>
                        <td><strong>${a.name}</strong></td>
                        <td>${a.role || '-'}</td>
                        <td class="position-${a.position}">${a.position === 'ally' ? 'ğŸ¤ AlliÃ©' : a.position === 'opponent' ? 'âš”ï¸ Opposant' : a.position === 'target' ? 'ğŸ¯ Cible' : 'âš–ï¸ Neutre'}</td>
                        <td>${'â—'.repeat(a.power || 3)}${'â—‹'.repeat(5-(a.power || 3))}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    </div>
    ` : ''}
    
    ${renderSection('Arbre Ã  ProblÃ¨mes', P.arbre, 'ğŸŒ³')}
    ${renderSection('5 Pourquoi', P.pourquoi, 'â“')}
    ${renderSection('Analyse SWOT', P.swot, 'ğŸ“Š')}
    ${renderSection('Analyse PESTEL', P.pestel, 'ğŸŒ')}
    ${renderSection('ThÃ©orie du Changement', P.tdc, 'ğŸ”„')}
    
    <!-- PHASE AGIR -->
    <div class="phase-header agir">
        <h1>ğŸŸ¢ PHASE 3 : AGIR</h1>
        <p style="margin:5px 0 0;color:#666;">Planifier, mobiliser, Ã©valuer</p>
    </div>
    
    ${renderSection('StratÃ©gies de Pouvoir', P.pouvoir, 'âš¡')}
    ${renderSection('Cibles & AlliÃ©s', P.cibles, 'ğŸ¯')}
    ${renderSection('Message ClÃ©', P.message, 'ğŸ’¬')}
    
    ${P.smart?.length ? `
    <div class="section">
        <h2>âœ… Objectifs SMART</h2>
        <ul class="smart-list">
            ${P.smart.map(s => `
                <li class="smart-item ${s.done ? 'done' : ''}">
                    <span class="smart-checkbox"></span>
                    <strong>${s.text}</strong>
                    ${s.indicator ? `<br><small style="color:#666;">ğŸ“ ${s.indicator}</small>` : ''}
                    ${s.deadline ? `<br><small style="color:#9f7aea;">ğŸ“… Ã‰chÃ©ance: ${s.deadline}</small>` : ''}
                </li>
            `).join('')}
        </ul>
    </div>
    ` : ''}
    
    ${renderSection('Suivi & Ã‰valuation', P.evaluation, 'ğŸ“ˆ')}
    
    ${P.journal?.length ? `
    <div class="section">
        <h2>ğŸ“” Journal de Bord</h2>
        ${P.journal.slice(-10).map(j => `
            <div style="margin-bottom:15px;padding:10px;background:#f8f8f8;border-radius:6px;">
                <strong style="color:#9f7aea;">${j.date}</strong>
                <p style="margin:5px 0 0;">${formatText(j.content)}</p>
            </div>
        `).join('')}
    </div>
    ` : ''}
    
    <!-- FOOTER -->
    <div class="footer">
        <p>Rapport gÃ©nÃ©rÃ© par <strong>#B!Mi Plaidoyer Citoyen</strong> â€” https://yannkeep.github.io/plaidoyer/app/index.html</p>
        <p>Licence Creative Commons BY-NC-SA 4.0</p>
    </div>
</body>
</html>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DICTIONNAIRES DE TRADUCTION â€” v4.1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SECTION_LABELS = {
    domino: { title: 'Vision (Domino)', emoji: 'ğŸ¯', phase: 'voir' },
    profil: { title: 'Profil Citoyen', emoji: 'ğŸ‘¤', phase: 'voir' },
    fleur: { title: 'Fleur du Pouvoir', emoji: 'ğŸŒ¸', phase: 'voir' },
    acteurs: { title: 'Cartographie des Acteurs', emoji: 'ğŸ‘¥', phase: 'juger' },
    arbre: { title: 'Arbre Ã  ProblÃ¨mes', emoji: 'ğŸŒ³', phase: 'juger' },
    pourquoi: { title: 'Les 5 Pourquoi', emoji: 'â“', phase: 'juger' },
    swot: { title: 'Analyse SWOT', emoji: 'ğŸ“Š', phase: 'juger' },
    pestel: { title: 'Analyse PESTEL', emoji: 'ğŸŒ', phase: 'juger' },
    tdc: { title: 'ThÃ©orie du Changement', emoji: 'ğŸ”„', phase: 'juger' },
    pouvoir: { title: 'StratÃ©gies de Pouvoir', emoji: 'âš¡', phase: 'agir' },
    cibles: { title: 'Cibles & AlliÃ©s', emoji: 'ğŸ¯', phase: 'agir' },
    message: { title: 'Message ClÃ©', emoji: 'ğŸ’¬', phase: 'agir' },
    evaluation: { title: 'Suivi & Ã‰valuation', emoji: 'ğŸ“ˆ', phase: 'agir' },
    smart: { title: 'Objectifs SMART', emoji: 'âœ…', phase: 'agir' },
    journal: { title: 'Journal de Bord', emoji: 'ğŸ“”', phase: 'agir' }
};

const FIELD_LABELS = {
    // Domino
    vision: 'Vision', obstacles: 'Obstacles', ressources: 'Ressources',
    // Profil
    motivations: 'Motivations', competences: 'CompÃ©tences', temps: 'Temps disponible', limites: 'Limites',
    // Fleur
    identites: 'IdentitÃ©s', privileges: 'PrivilÃ¨ges', oppressions: 'Oppressions',
    // Arbre
    probleme: 'ProblÃ¨me central', causes: 'Causes', consequences: 'ConsÃ©quences',
    // Pourquoi
    p1: 'Pourquoi 1', p2: 'Pourquoi 2', p3: 'Pourquoi 3', p4: 'Pourquoi 4', p5: 'Pourquoi 5 (cause racine)',
    // SWOT
    forces: 'Forces', faiblesses: 'Faiblesses', opportunites: 'OpportunitÃ©s', menaces: 'Menaces',
    // PESTEL
    p: 'Politique', e: 'Ã‰conomique', s: 'Social', t: 'Technologique', en: 'Environnemental', l: 'LÃ©gal',
    // TDC
    actuelle: 'Changement de conscience', souhaitee: 'Changement de politiques', mecanismes: 'Changement de comportement', hypotheses: 'HypothÃ¨ses',
    // Pouvoir
    avec: 'Avec le pouvoir', sans: 'Sans le pouvoir', contre: 'Contre le pouvoir',
    // Cibles
    principales: 'Cibles principales', secondaires: 'Cibles secondaires', allies: 'AlliÃ©s stratÃ©giques',
    // Message
    accroche: 'Accroche', importance: 'Pourquoi c\'est important', cible: 'Ã€ qui on s\'adresse', action: 'Action demandÃ©e',
    // Evaluation
    indicateurs: 'Indicateurs de succÃ¨s', methodes: 'MÃ©thodes de suivi', calendrier: 'Calendrier', lecons: 'LeÃ§ons Ã  documenter'
};

function getFieldLabel(section, field) {
    if (section === 'message' && field === 'probleme') return 'Le problÃ¨me';
    return FIELD_LABELS[field] || field.charAt(0).toUpperCase() + field.slice(1);
}

function getSectionInfo(section) {
    return SECTION_LABELS[section] || { title: section, emoji: 'ğŸ“‹', phase: 'autre' };
}

function hasContent(obj) {
    if (!obj) return false;
    return Object.values(obj).some(v => v && String(v).trim().length > 0);
}

function escHtml(text) {
    if (!text) return '';
    return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function fmtHtml(text) {
    if (!text) return '';
    return escHtml(text).replace(/\n/g, '<br>\n').replace(/â€¢/g, '&#8226;').replace(/â†’/g, '&rarr;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÃ‰NÃ‰RATION MARKDOWN COMPLÃˆTE â€” v4.1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateMarkdown() {
    const date = new Date().toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' });
    let md = `# ${P.meta?.name || 'Projet de Plaidoyer'}\n\n`;
    md += `*ExportÃ© le ${date}*\n\n---\n\n`;
    
    // Helper pour sections ordonnÃ©es
    const renderMdSection = (key, data, order) => {
        if (!hasContent(data)) return '';
        const info = getSectionInfo(key);
        let s = `## ${info.emoji} ${info.title}\n\n`;
        order.forEach(k => {
            if (data[k] && String(data[k]).trim()) {
                s += `### ${getFieldLabel(key, k)}\n\n${String(data[k]).trim()}\n\n`;
            }
        });
        return s;
    };
    
    // â•â•â• PHASE VOIR â•â•â•
    md += `# ğŸ”µ PHASE 1 : VOIR\n\n*Observer, comprendre, ressentir*\n\n`;
    md += renderMdSection('domino', P.domino, ['vision', 'obstacles', 'ressources']);
    md += renderMdSection('profil', P.profil, ['motivations', 'competences', 'temps', 'limites']);
    md += renderMdSection('fleur', P.fleur, ['identites', 'privileges', 'oppressions']);
    
    // â•â•â• PHASE JUGER â•â•â•
    md += `---\n\n# ğŸŸ  PHASE 2 : JUGER\n\n*Analyser, diagnostiquer, prioriser*\n\n`;
    
    // Acteurs en tableau
    if (P.acteurs?.length) {
        md += `## ğŸ‘¥ Cartographie des Acteurs\n\n`;
        md += `| Acteur | RÃ´le | Position | Pouvoir |\n|--------|------|----------|--------|\n`;
        P.acteurs.forEach(a => {
            const pos = a.position === 'ally' ? 'ğŸ¤ AlliÃ©' : a.position === 'opponent' ? 'âš”ï¸ Opposant' : a.position === 'target' ? 'ğŸ¯ Cible' : 'âš–ï¸ Neutre';
            md += `| **${a.name}** | ${a.role || '-'} | ${pos} | ${'â—'.repeat(a.power||3)}${'â—‹'.repeat(5-(a.power||3))} |\n`;
        });
        md += '\n';
        
        // Relations entre acteurs
        if (P.links?.length) {
            md += `### ğŸ”— Relations entre acteurs\n\n`;
            const getActorName = (id) => P.acteurs.find(a => a.id === id)?.name || '?';
            const typeSymbols = { influence: 'ğŸ’¡', alliance: 'ğŸ¤', opposition: 'âš”ï¸' };
            P.links.forEach(l => {
                md += `- ${getActorName(l.from)} ${typeSymbols[l.type] || 'â†’'} ${getActorName(l.to)} *(${l.type})*\n`;
            });
            md += '\n';
        }
    }
    
    md += renderMdSection('arbre', P.arbre, ['probleme', 'causes', 'consequences']);
    md += renderMdSection('pourquoi', P.pourquoi, ['p1', 'p2', 'p3', 'p4', 'p5']);
    md += renderMdSection('swot', P.swot, ['forces', 'faiblesses', 'opportunites', 'menaces']);
    md += renderMdSection('pestel', P.pestel, ['p', 'e', 's', 't', 'en', 'l']);
    md += renderMdSection('tdc', P.tdc, ['actuelle', 'souhaitee', 'mecanismes', 'hypotheses']);
    
    // â•â•â• PHASE AGIR â•â•â•
    md += `---\n\n# ğŸŸ¢ PHASE 3 : AGIR\n\n*Planifier, mobiliser, Ã©valuer*\n\n`;
    md += renderMdSection('pouvoir', P.pouvoir, ['avec', 'sans', 'contre']);
    md += renderMdSection('cibles', P.cibles, ['principales', 'secondaires', 'allies']);
    md += renderMdSection('message', P.message, ['accroche', 'probleme', 'importance', 'cible', 'action']);
    
    // SMART
    if (P.smart?.length) {
        md += `## âœ… Objectifs SMART\n\n`;
        P.smart.forEach(s => {
            md += `- ${s.done ? 'âœ…' : 'â¬œ'} **${s.text}**`;
            if (s.indicator) md += `\n  - ğŸ“ ${s.indicator}`;
            if (s.deadline) md += `\n  - ğŸ“… ${s.deadline}`;
            md += '\n';
        });
        md += '\n';
    }
    
    md += renderMdSection('evaluation', P.evaluation, ['indicateurs', 'methodes', 'calendrier', 'lecons']);
    
    // Journal
    if (P.journal?.length) {
        md += `## ğŸ“” Journal de Bord\n\n`;
        P.journal.forEach(j => md += `### ğŸ“… ${j.date}\n\n${j.content}\n\n`);
    }
    
    md += `---\n\n*GÃ©nÃ©rÃ© par **#B!Mi Plaidoyer Citoyen** â€” [Plaidoyer](https://yannkeep.github.io/plaidoyer/app/index.html) â€” CC BY-NC-SA 4.0*\n`;
    return md;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÃ‰NÃ‰RATION HTML COMPLÃˆTE â€” v4.1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateHTML() {
    const date = new Date().toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' });
    const name = P.meta?.name || 'Projet de Plaidoyer';
    
    const renderSec = (key, data, order) => {
        if (!hasContent(data)) return '';
        const info = getSectionInfo(key);
        let h = `<section class="section phase-${info.phase}">\n<h2>${info.emoji} ${info.title}</h2>\n`;
        order.forEach(k => {
            if (data[k] && String(data[k]).trim()) {
                h += `<div class="field"><h3>${getFieldLabel(key, k)}</h3><div class="content">${fmtHtml(data[k])}</div></div>\n`;
            }
        });
        return h + `</section>\n`;
    };
    
    return `<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${escHtml(name)} â€” Rapport de Plaidoyer</title>
<style>
@page { size: A4; margin: 2cm; }
@media print { .phase-header { page-break-before: always; } .section { page-break-inside: avoid; } }
* { box-sizing: border-box; }
body { font-family: 'Segoe UI', system-ui, sans-serif; font-size: 11pt; line-height: 1.6; color: #1a1a2e; background: #fff; max-width: 900px; margin: 0 auto; padding: 2rem; }
.header { text-align: center; padding: 2rem 1rem; border-bottom: 4px solid #48bb78; margin-bottom: 2rem; }
.header h1 { color: #1a1a2e; font-size: 2rem; margin: 0 0 0.5rem 0; }
.header .sub { color: #666; font-style: italic; }
.phase-header { padding: 1rem 1.5rem; margin: 2rem 0 1.5rem 0; border-radius: 8px; color: white; }
.phase-header.voir { background: linear-gradient(135deg, #4299e1, #63b3ed); }
.phase-header.juger { background: linear-gradient(135deg, #ed8936, #f6ad55); }
.phase-header.agir { background: linear-gradient(135deg, #38a169, #48bb78); }
.phase-header h1 { margin: 0; font-size: 1.4rem; }
.phase-header p { margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.95rem; }
.section { background: #f8f9fa; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid #ddd; }
.section.phase-voir { border-left-color: #63b3ed; }
.section.phase-juger { border-left-color: #f6ad55; }
.section.phase-agir { border-left-color: #48bb78; }
.section h2 { color: #2d3748; font-size: 1.25rem; margin: 0 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0; }
.section.phase-voir h2 { color: #2b6cb0; border-bottom-color: #bee3f8; }
.section.phase-juger h2 { color: #c05621; border-bottom-color: #feebc8; }
.section.phase-agir h2 { color: #276749; border-bottom-color: #c6f6d5; }
.field { margin-bottom: 1.25rem; }
.field:last-child { margin-bottom: 0; }
.field h3 { color: #4a5568; font-size: 0.95rem; font-weight: 600; margin: 0 0 0.5rem 0; text-transform: uppercase; letter-spacing: 0.5px; }
.field .content { color: #2d3748; white-space: pre-wrap; }
table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
th { background: #edf2f7; color: #4a5568; padding: 0.75rem; text-align: left; font-weight: 600; border-bottom: 2px solid #cbd5e0; }
td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
tr:hover { background: #f7fafc; }
.pos-ally { color: #38a169; } .pos-opponent { color: #e53e3e; } .pos-target { color: #dd6b20; } .pos-neutral { color: #718096; }
.smart-list { list-style: none; padding: 0; margin: 1rem 0 0 0; }
.smart-item { padding: 1rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid #48bb78; }
.smart-item.done { opacity: 0.7; border-left-color: #a0aec0; }
.smart-meta { margin-top: 0.5rem; font-size: 0.85rem; color: #718096; }
.journal-entry { padding: 1rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid #9f7aea; }
.journal-date { font-weight: 600; color: #9f7aea; margin-bottom: 0.5rem; }
.footer { margin-top: 3rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0; text-align: center; color: #718096; font-size: 0.9rem; }
.footer a { color: #48bb78; text-decoration: none; }
</style>
</head>
<body>
<header class="header"><div style="font-size:2.5rem;">ğŸ—³ï¸</div><h1>${escHtml(name)}</h1><p class="sub">Rapport de Plaidoyer â€” ${date}</p></header>

<div class="phase-header voir"><h1>ğŸ”µ PHASE 1 : VOIR</h1><p>Observer, comprendre, ressentir</p></div>
${renderSec('domino', P.domino, ['vision', 'obstacles', 'ressources'])}
${renderSec('profil', P.profil, ['motivations', 'competences', 'temps', 'limites'])}
${renderSec('fleur', P.fleur, ['identites', 'privileges', 'oppressions'])}

<div class="phase-header juger"><h1>ğŸŸ  PHASE 2 : JUGER</h1><p>Analyser, diagnostiquer, prioriser</p></div>
${P.acteurs?.length ? `<section class="section phase-juger"><h2>ğŸ‘¥ Cartographie des Acteurs</h2>
<table><thead><tr><th>Acteur</th><th>RÃ´le</th><th>Position</th><th>Pouvoir</th></tr></thead><tbody>
${P.acteurs.map(a => `<tr><td><strong>${escHtml(a.name)}</strong></td><td>${escHtml(a.role)||'-'}</td><td class="pos-${a.position}">${a.position==='ally'?'ğŸ¤ AlliÃ©':a.position==='opponent'?'âš”ï¸ Opposant':a.position==='target'?'ğŸ¯ Cible':'âš–ï¸ Neutre'}</td><td>${'â—'.repeat(a.power||3)}${'â—‹'.repeat(5-(a.power||3))}</td></tr>`).join('')}
</tbody></table></section>` : ''}
${renderSec('arbre', P.arbre, ['probleme', 'causes', 'consequences'])}
${renderSec('pourquoi', P.pourquoi, ['p1', 'p2', 'p3', 'p4', 'p5'])}
${renderSec('swot', P.swot, ['forces', 'faiblesses', 'opportunites', 'menaces'])}
${renderSec('pestel', P.pestel, ['p', 'e', 's', 't', 'en', 'l'])}
${renderSec('tdc', P.tdc, ['actuelle', 'souhaitee', 'mecanismes', 'hypotheses'])}

<div class="phase-header agir"><h1>ğŸŸ¢ PHASE 3 : AGIR</h1><p>Planifier, mobiliser, Ã©valuer</p></div>
${renderSec('pouvoir', P.pouvoir, ['avec', 'sans', 'contre'])}
${renderSec('cibles', P.cibles, ['principales', 'secondaires', 'allies'])}
${renderSec('message', P.message, ['accroche', 'probleme', 'importance', 'cible', 'action'])}
${P.smart?.length ? `<section class="section phase-agir"><h2>âœ… Objectifs SMART</h2><ul class="smart-list">
${P.smart.map(s => `<li class="smart-item ${s.done?'done':''}"><strong>${escHtml(s.text)}</strong><div class="smart-meta">${s.indicator?'ğŸ“ '+escHtml(s.indicator):''}${s.indicator&&s.deadline?' â€¢ ':''}${s.deadline?'ğŸ“… '+escHtml(s.deadline):''}</div></li>`).join('')}
</ul></section>` : ''}
${renderSec('evaluation', P.evaluation, ['indicateurs', 'methodes', 'calendrier', 'lecons'])}
${P.journal?.length ? `<section class="section phase-agir"><h2>ğŸ“” Journal de Bord</h2>
${P.journal.map(j => `<div class="journal-entry"><div class="journal-date">ğŸ“… ${escHtml(j.date)}</div><div style="white-space:pre-wrap;">${fmtHtml(j.content)}</div></div>`).join('')}
</section>` : ''}

<footer class="footer"><p>GÃ©nÃ©rÃ© par <strong>#B!Mi Plaidoyer Citoyen</strong></p><p><a href="https://yannkeep.github.io/plaidoyer/app/index.html">Plaidoyer NumÃ©rique</a></p></footer>
</body></html>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÃ‰NÃ‰RATION CSV COMPLÃˆTE â€” v4.1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateCSV() {
    let csv = 'Phase,Section,Champ,Label,Valeur\n';
    const add = (phase, key, data, order) => {
        if (!data) return;
        const info = getSectionInfo(key);
        order.forEach(k => {
            if (data[k] && String(data[k]).trim()) {
                csv += `"${phase}","${info.title}","${k}","${getFieldLabel(key, k)}","${String(data[k]).replace(/"/g, '""')}"\n`;
            }
        });
    };
    
    // Meta
    csv += `"META","Projet","name","Nom","${(P.meta?.name||'').replace(/"/g,'""')}"\n`;
    csv += `"META","Projet","created","CrÃ©Ã©","${P.meta?.created||''}"\n`;
    csv += `"META","Projet","updated","ModifiÃ©","${P.meta?.updated||''}"\n`;
    
    // VOIR
    add('VOIR', 'domino', P.domino, ['vision', 'obstacles', 'ressources']);
    add('VOIR', 'profil', P.profil, ['motivations', 'competences', 'temps', 'limites']);
    add('VOIR', 'fleur', P.fleur, ['identites', 'privileges', 'oppressions']);
    
    // JUGER
    if (P.acteurs?.length) {
        P.acteurs.forEach((a,i) => csv += `"JUGER","Acteurs","acteur_${i}","${a.name}","Position: ${a.position}, Pouvoir: ${a.power}/5, RÃ´le: ${(a.role||'').replace(/"/g,'""')}"\n`);
    }
    add('JUGER', 'arbre', P.arbre, ['probleme', 'causes', 'consequences']);
    add('JUGER', 'pourquoi', P.pourquoi, ['p1', 'p2', 'p3', 'p4', 'p5']);
    add('JUGER', 'swot', P.swot, ['forces', 'faiblesses', 'opportunites', 'menaces']);
    add('JUGER', 'pestel', P.pestel, ['p', 'e', 's', 't', 'en', 'l']);
    add('JUGER', 'tdc', P.tdc, ['actuelle', 'souhaitee', 'mecanismes', 'hypotheses']);
    
    // AGIR
    add('AGIR', 'pouvoir', P.pouvoir, ['avec', 'sans', 'contre']);
    add('AGIR', 'cibles', P.cibles, ['principales', 'secondaires', 'allies']);
    add('AGIR', 'message', P.message, ['accroche', 'probleme', 'importance', 'cible', 'action']);
    if (P.smart?.length) {
        P.smart.forEach((s,i) => csv += `"AGIR","SMART","smart_${i}","${s.done?'âœ…':'â¬œ'} Objectif","${(s.text||'').replace(/"/g,'""')} | ğŸ“ ${(s.indicator||'-').replace(/"/g,'""')} | ğŸ“… ${s.deadline||'-'}"\n`);
    }
    add('AGIR', 'evaluation', P.evaluation, ['indicateurs', 'methodes', 'calendrier', 'lecons']);
    if (P.journal?.length) {
        P.journal.forEach((j,i) => csv += `"AGIR","Journal","${j.date}","EntrÃ©e ${i+1}","${(j.content||'').replace(/"/g,'""')}"\n`);
    }
    
    return csv;
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

async function importJSON(file) {
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            console.log('=== IMPORT START ===');
            console.log('Raw data keys:', Object.keys(data));
            
            let project;
            
            if (data.meta && data.meta.name) {
                // Format natif #B!Mi
                console.log('Format: Native #B!Mi');
                project = JSON.parse(JSON.stringify(data)); // Deep clone
                if (!project.id) project.id = Date.now().toString();
            } else if (data.project || data.domino) {
                // Format dataset-plaidoyer-arizona.json
                console.log('Format: Dataset Arizona');
                project = {
                    id: Date.now().toString(),
                    meta: {
                        name: data.project?.name || 'Projet importÃ©',
                        description: '',
                        created: data.project?.created || new Date().toISOString(),
                        updated: new Date().toISOString()
                    },
                    
                    // DOMINO
                    domino: {
                        vision: data.domino?.vision || '',
                        obstacles: data.domino?.obstacles || '',
                        ressources: data.domino?.ressources || ''
                    },
                    
                    // PROFIL
                    profil: {
                        motivations: data.profil?.motivations || '',
                        competences: data.profil?.competences || '',
                        temps: data.profil?.temps || '',
                        limites: data.profil?.limites || ''
                    },
                    
                    // FLEUR
                    fleur: {
                        identites: data.fleur?.identites || '',
                        privileges: data.fleur?.privileges || '',
                        oppressions: data.fleur?.oppressions || ''
                    },
                    
                    // ACTEURS
                    acteurs: (data.acteurs || []).map((a, i) => ({
                        id: Date.now() + i,
                        name: a.name || '',
                        role: a.role || '',
                        position: a.position || 'neutral',
                        power: parseInt(a.power) || 3
                    })),
                    
                    // ARBRE
                    arbre: {
                        probleme: data.arbre?.probleme_central || data.arbre?.probleme || '',
                        causes: Array.isArray(data.arbre?.causes) 
                            ? 'â€¢ ' + data.arbre.causes.join('\nâ€¢ ') 
                            : (data.arbre?.causes || ''),
                        consequences: Array.isArray(data.arbre?.effets) 
                            ? 'â€¢ ' + data.arbre.effets.join('\nâ€¢ ') 
                            : (data.arbre?.consequences || data.arbre?.effets || '')
                    },
                    
                    // POURQUOI
                    pourquoi: {
                        p1: data.pourquoi?.why1 || data.pourquoi?.p1 || '',
                        p2: data.pourquoi?.why2 || data.pourquoi?.p2 || '',
                        p3: data.pourquoi?.why3 || data.pourquoi?.p3 || '',
                        p4: data.pourquoi?.why4 || data.pourquoi?.p4 || '',
                        p5: data.pourquoi?.why5 || data.pourquoi?.p5 || ''
                    },
                    
                    // SWOT
                    swot: {
                        forces: data.swot?.strengths || data.swot?.forces || '',
                        faiblesses: data.swot?.weaknesses || data.swot?.faiblesses || '',
                        opportunites: data.swot?.opportunities || data.swot?.opportunites || '',
                        menaces: data.swot?.threats || data.swot?.menaces || ''
                    },
                    
                    // PESTEL
                    pestel: {
                        p: data.pestel?.politique || data.pestel?.p || '',
                        e: data.pestel?.economique || data.pestel?.e || '',
                        s: data.pestel?.social || data.pestel?.s || '',
                        t: data.pestel?.technologique || data.pestel?.t || '',
                        en: data.pestel?.environnemental || data.pestel?.en || '',
                        l: data.pestel?.legal || data.pestel?.l || ''
                    },
                    
                    // TDC
                    tdc: {
                        actuelle: data.tdc?.changement_interne_individuel || data.tdc?.actuelle || '',
                        souhaitee: data.tdc?.changement_externe_collectif || data.tdc?.souhaitee || '',
                        mecanismes: data.tdc?.changement_externe_individuel || data.tdc?.mecanismes || '',
                        hypotheses: data.tdc?.hypotheses || ''
                    },
                    
                    // POUVOIR
                    pouvoir: {
                        avec: data.pouvoir?.avec || '',
                        sans: data.pouvoir?.sans || '',
                        contre: data.pouvoir?.contre || ''
                    },
                    
                    // CIBLES
                    cibles: {
                        principales: data.cibles?.principale || data.cibles?.principales || '',
                        secondaires: data.cibles?.secondaires || '',
                        allies: data.cibles?.allies || ''
                    },
                    
                    // MESSAGE
                    message: {
                        accroche: data.message?.accroche || '',
                        probleme: data.message?.probleme || '',
                        importance: data.message?.importance || '',
                        cible: data.message?.cible || '',
                        action: data.message?.action || ''
                    },
                    
                    // EVALUATION
                    evaluation: {
                        indicateurs: data.evaluation?.indicateurs || '',
                        methodes: data.evaluation?.methodes || '',
                        calendrier: data.evaluation?.calendrier || '',
                        lecons: data.evaluation?.lecons || ''
                    },
                    
                    // SMART
                    smart: [],
                    
                    // JOURNAL
                    journal: []
                };
                
                // SMART - conversion format {s,m,a,r,t} ou {text,...}
                if (data.smart && Array.isArray(data.smart)) {
                    project.smart = data.smart.map((s, i) => ({
                        id: Date.now() + i + 500,
                        text: s.s || s.text || '',
                        indicator: s.m || s.indicator || '',
                        deadline: s.t || s.deadline || '',
                        done: !!s.done
                    }));
                }
                
                // CHECKLIST â†’ SMART si pas de smart
                if (data.checklist && Array.isArray(data.checklist) && project.smart.length === 0) {
                    project.smart = data.checklist.map((c, i) => ({
                        id: Date.now() + i + 1000,
                        text: c.task || '',
                        indicator: 'Phase: ' + (c.phase || 'N/A'),
                        deadline: '',
                        done: !!c.done
                    }));
                }
                
                console.log('Mapped project:', {
                    domino: project.domino,
                    acteurs: project.acteurs.length,
                    swot: project.swot,
                    smart: project.smart.length
                });
                
            } else {
                throw new Error('Format de fichier non reconnu. Utilisez un export JSON de #B!Mi ou un dataset compatible.');
            }
            
            // Save to DB
            const saved = await dbPut(project);
            console.log('Saved to DB:', saved);
            
            // Select and load
            await selectProject(project.id);
            
            toast(`Import rÃ©ussi ! ${project.acteurs?.length || 0} acteurs, ${project.smart?.length || 0} objectifs`, 'success');
            console.log('=== IMPORT END ===');
            
        } catch (err) {
            console.error('Import error:', err);
            toast('Erreur d\'import : ' + err.message, 'error');
        }
    };
    reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadTemplate(tpl) {
    let project = newProject(
        tpl === 'arizona' ? 'STOP Arizona â€” DÃ©fense du ModÃ¨le Social Belge' : 
        tpl === 'ecp' ? 'Ã‰conomie Contributive ProvisionnÃ©e â€” SouverainetÃ© Citoyenne' :
        'Nouveau projet'
    );
    
    if (tpl === 'arizona') {
        project.domino = {
            vision: "D'ici fin 2027, obtenir l'ANNULATION de la limitation des allocations de chÃ´mage Ã  24 mois et une COMPENSATION INTÃ‰GRALE des CPAS.",
            obstacles: "MajoritÃ© parlementaire Arizona solide â€¢ Contrainte budgÃ©taire UE de 23 milliards â‚¬ â€¢ 90.000 personnes concernÃ©es par les exclusions",
            ressources: "Front commun syndical FGTB + CSC + CGSLB (1,5M membres) â€¢ Recours constitutionnel (article 23) â€¢ RÃ©seau associatif dense"
        };
        project.acteurs = [
            { id: 1, name: "Bart De Wever", role: "Premier Ministre (N-VA)", position: "opponent", power: 5 },
            { id: 2, name: "Frank Vandenbroucke", role: "Ministre Affaires sociales", position: "neutral", power: 5 },
            { id: 3, name: "Thierry Bodson", role: "PrÃ©sident FGTB", position: "ally", power: 4 },
            { id: 4, name: "Cour Constitutionnelle", role: "Recours article 23", position: "target", power: 5 }
        ];
        project.smart = [
            { id: 1, text: "Obtenir un moratoire sur les exclusions", indicator: "Suspension officielle", deadline: "2026-03-01", status: "todo", done: false },
            { id: 2, text: "Documenter 1000 tÃ©moignages", indicator: "Nombre de tÃ©moignages", deadline: "2026-12-31", status: "inprogress", done: false }
        ];
    }
    
    if (tpl === 'ecp') {
        // Template complet ECP
        project.domino = {
            vision: "D'ici fin 2027, obtenir un RULING FISCAL favorable du SDA validant le mÃ©canisme de provisionnement diffÃ©rÃ© de l'ECP, permettant aux 978 000 personnes en inactivitÃ© contrainte de contribuer SANS PERDRE leurs droits sociaux.\n\nObjectif : Transformer 21-24 milliards â‚¬/an de dÃ©penses passives en investissement actif via un projet pilote de 24 000 â‚¬.",
            obstacles: "JURIDIQUES : Absence de cadre dÃ©diÃ©, risque de requalification ONSS, article 344 CIR 92\nSOCIAUX : Perte BIM au premier euro, limitation chÃ´mage 24 mois\nINSTITUTIONNELS : Coalition Arizona focalisÃ©e sur l'activation coercitive, services publics cloisonnÃ©s",
            ressources: "LOI VOLONTARIAT 2005 : plafond 1 692,51 â‚¬ non imposable\nSDA : procÃ©dure de ruling Ã©tablie\nRÃ‰GIME VVPR-BIS : dividendes Ã  taux rÃ©duit\nINFRASTRUCTURE : Solid, FHIR, Decidim, Sensor.community\nPARTENAIRES : Paradigm, Athumi, mutuelles, syndicats"
        };
        project.profil = {
            motivations: "978 000 personnes en inactivitÃ© contrainte coÃ»tent 21-24 Mdâ‚¬/an.\nLe systÃ¨me INDEMNISE l'inactivitÃ© mais PÃ‰NALISE la contribution.\nTaux marginal > 100% pour les prÃ©caires = dÃ©sincitation structurelle.\n\nL'ECP propose de transformer cette dÃ©pense passive en investissement actif.",
            competences: "JURIDIQUE : Ruling fiscal, droit social, volontariat\nTECHNIQUE : Solid, FHIR, Git Scraping\nMOBILISATION : Ã‰ducation permanente, vulgarisation\nANALYSE : Veille lÃ©gislative, Ã©tudes d'impact",
            temps: "Noyau dur : 3-5 personnes Ã  mi-temps\nRÃ©seau Ã©largi : 20-30 contributeurs ponctuels\n\nT1 2026 : DÃ©pÃ´t ruling\nT2 2026 : Projet pilote ARC\nT4 2026 : DÃ©cision SDA attendue",
            limites: "Budget : 24 000 â‚¬ seulement\nPas d'accÃ¨s direct aux cabinets ministÃ©riels\nDocumentation principalement francophone\nRisque de ruling dÃ©favorable"
        };
        project.fleur = {
            identites: "Malades longue durÃ©e (500 000+) : burnout, TMS, chroniques\nChÃ´meurs longue durÃ©e : 50-55 ans, ex-industriels\nÃ‰tudiants prÃ©carisÃ©s : 58% insÃ©curitÃ© alimentaire\nAidants proches : travail de care invisible",
            privileges: "Capital intellectuel et juridique\nRÃ©seau acadÃ©mique et tech\nMaÃ®trise des standards (Solid, FHIR)\nAutonomie organisationnelle",
            oppressions: "Violence administrative : taux marginal > 100%, perte BIM\nViolence symbolique : discours Â« profiteurs Â»\nViolence Ã©conomique : dÃ©sincitation Ã  l'activitÃ©\nExclusion institutionnelle : systÃ¨me binaire inadaptÃ©"
        };
        project.acteurs = [
            { id: 1, name: "Service des DÃ©cisions AnticipÃ©es (SDA)", role: "Organe du SPF Finances â€” AutoritÃ© de dÃ©livrance des rulings", position: "target", power: 5 },
            { id: 2, name: "SPF Finances", role: "Administration fiscale fÃ©dÃ©rale", position: "neutral", power: 5 },
            { id: 3, name: "ONSS", role: "Office National de SÃ©curitÃ© Sociale â€” Requalification salariale", position: "neutral", power: 5 },
            { id: 4, name: "Cabinet Vandenbroucke", role: "Ministre Affaires Sociales (Vooruit)", position: "neutral", power: 5 },
            { id: 5, name: "Paradigm", role: "Gestionnaire donnÃ©es Bruxelles â€” Infrastructure Solid", position: "ally", power: 3 },
            { id: 6, name: "Athumi", role: "Gestionnaire donnÃ©es Flandre â€” Infrastructure Solid", position: "ally", power: 3 },
            { id: 7, name: "Solidaris", role: "MutualitÃ© socialiste â€” Expertise santÃ©", position: "ally", power: 3 },
            { id: 8, name: "FGTB", role: "Syndicat socialiste â€” Services juridiques", position: "ally", power: 4 },
            { id: 9, name: "CSC", role: "Syndicat chrÃ©tien â€” RÃ©seau et mobilisation", position: "ally", power: 4 },
            { id: 10, name: "DULBEA (ULB)", role: "Centre recherche Ã©conomique â€” Caution acadÃ©mique", position: "ally", power: 2 }
        ];
        project.arbre = {
            probleme: "Le Â« PIÃˆGE INSTITUTIONNEL Â» belge maintient 978 000 personnes dans une INACTIVITÃ‰ CONTRAINTE coÃ»tant 21-24 milliards â‚¬/an, tout en PÃ‰NALISANT toute tentative de contribution citoyenne.",
            causes: "â€¢ Absence de statut juridique pour les formes hybrides de contribution\nâ€¢ Conception binaire du marchÃ© du travail (CDI ou inactif)\nâ€¢ Cloisonnement administratif (SPF, ONSS, ONEM, INAMI)\nâ€¢ MÃ©canismes de dÃ©gressivitÃ© brutaux (perte BIM au premier euro)\nâ€¢ IdÃ©ologie d'activation coercitive privilÃ©giant la sanction",
            consequences: "â€¢ 978 000 personnes maintenues dans l'inactivitÃ© contrainte\nâ€¢ CoÃ»t annuel de 21-24 milliards â‚¬ en dÃ©penses passives\nâ€¢ DÃ©ficit sÃ©curitÃ© sociale 2024 : 18,2 Mdâ‚¬\nâ€¢ Perte de compÃ©tences et capital humain\nâ€¢ Cercle vicieux : inactivitÃ© â†’ dÃ©gradation santÃ© â†’ incapacitÃ©"
        };
        project.pourquoi = {
            p1: "Parce qu'il n'existe AUCUN STATUT JURIDIQUE pour les formes hybrides de contribution citoyenne â€” le droit belge ne connaÃ®t que le salariÃ©, l'indÃ©pendant ou le volontaire strict.",
            p2: "Parce que le SYSTÃˆME SOCIAL BELGE a Ã©tÃ© conÃ§u pour un marchÃ© du travail BINAIRE et ne sait pas traiter les situations intermÃ©diaires.",
            p3: "Parce que les MÃ‰CANISMES DE DÃ‰GRESSIVITÃ‰ sont BRUTAUX â€” la perte du statut BIM au premier euro crÃ©e un taux marginal > 100%.",
            p4: "Parce que l'IDÃ‰OLOGIE D'ACTIVATION COERCITIVE postule que seule la SANCTION incite Ã  l'emploi, ignorant les freins structurels rÃ©els.",
            p5: "CAUSE RACINE : Le RAPPORT DE FORCE POLITIQUE est dÃ©favorable aux formes alternatives de contribution. Le financement de la sÃ©cu est indexÃ© sur le salariat traditionnel, le ruling fiscal est sous-utilisÃ©, la coalition Arizona privilÃ©gie la punition Ã  l'innovation."
        };
        project.swot = {
            forces: "â€¢ Architecture juridique solide (loi volontariat, ruling SDA, VVPR-bis)\nâ€¢ Alignement avec objectifs Arizona (valoriser le travail)\nâ€¢ Argument Ã©conomique imparable (21 Mdâ‚¬ vs 24 000 â‚¬)\nâ€¢ Infrastructure technique mature (Solid, FHIR, Decidim)",
            faiblesses: "â€¢ ComplexitÃ© technique Ã©levÃ©e Ã  vulgariser\nâ€¢ Absence de prÃ©cÃ©dent direct de ruling ECP\nâ€¢ Ressources limitÃ©es (24 000 â‚¬ budget)\nâ€¢ Documentation principalement francophone",
            opportunites: "â€¢ Contexte budgÃ©taire critique (dÃ©ficit 18,2 Mdâ‚¬)\nâ€¢ RÃ©formes Arizona crÃ©ent besoin d'alternatives\nâ€¢ Partenaires rÃ©gionaux (Paradigm, Athumi) existants\nâ€¢ IntÃ©rÃªt croissant pour les modÃ¨les alternatifs",
            menaces: "â€¢ Ruling fiscal dÃ©favorable ou refus du SDA\nâ€¢ Requalification ONSS en contrat de travail\nâ€¢ RÃ©cupÃ©ration politique nÃ©gative\nâ€¢ Fatigue des porteurs de projet"
        };
        project.pestel = {
            p: "Coalition Arizona (MR + N-VA + EngagÃ©s + CD&V + Vooruit)\nPM Bart De Wever : agenda activation et responsabilisation\nObjectifs : 18 Mdâ‚¬ Ã©conomies, 80% taux d'emploi, diffÃ©rentiel 500 â‚¬",
            e: "DÃ©ficit sÃ©cu sociale 2024 : 18,2 Mdâ‚¬\nCoÃ»t inactivitÃ© : 21-24 Mdâ‚¬/an (1 Mâ‚¬/heure)\nDette publique : 119% PIB projetÃ© 2029\nTaux d'emploi : 72,1% BE vs 75,4% UE",
            s: "978 000 personnes en inactivitÃ© contrainte\n2,1 millions Belges en risque AROPE (18,3%)\n500 000+ malades longue durÃ©e\n58% Ã©tudiants en insÃ©curitÃ© alimentaire",
            t: "Protocole Solid : souverainetÃ© donnÃ©es (Pod)\nStandard FHIR : interopÃ©rabilitÃ© santÃ©/social\nGit Scraping : vÃ©ritÃ© administrative\nDecidim : dÃ©libÃ©ration liquide",
            en: "Transition Ã©cologique nÃ©cessitant contributions citoyennes\nPrÃ©caritÃ© Ã©nergÃ©tique aggravÃ©e (perte BIM â†’ tarifs sociaux)\nScience citoyenne environnementale (Sensor.community)",
            l: "Loi volontariat 2005 : plafond 1 692,51 â‚¬\nCritÃ¨res ONSS : prestation, rÃ©munÃ©ration, subordination\nSDA : procÃ©dure ruling Ã©tablie\nArticle 344 CIR 92 : disposition anti-abus"
        };
        project.tdc = {
            actuelle: "Les personnes prÃ©carisÃ©es passent de la HONTE Ã  la FIERTÃ‰ de contribuer. DÃ©construction du piÃ¨ge institutionnel intÃ©riorisÃ©. Prise de conscience de la valeur sociale de ses compÃ©tences.",
            souhaitee: "RULING FISCAL FAVORABLE validant le provisionnement diffÃ©rÃ©. STATUT FISCAL SPÃ‰CIFIQUE ECP. ARTICULATION avec la sÃ©curitÃ© sociale pour constituer des droits. PARTENARIATS INSTITUTIONNELS formalisÃ©s.",
            mecanismes: "Engagement dans des activitÃ©s valorisÃ©es (capteurs citoyens, Pont Social, guides pratiques). Utilisation du cadre ECP (chartes, SRL). Participation Ã  la gouvernance (Decidim). Documentation des contributions (Git).",
            hypotheses: "1. Le SDA est capable de statuer sur un montage innovant\n2. L'alignement Arizona rend le modÃ¨le audible\n3. Le coÃ»t de l'inaction est un argument imparable\n4. Les partenaires institutionnels ont intÃ©rÃªt Ã  s'engager\n5. L'infrastructure technique est mature"
        };
        project.pouvoir = {
            avec: "â€¢ Dialogue avec le SDA : dÃ©pÃ´t ruling documentÃ©\nâ€¢ Partenariat cabinet Vandenbroucke : articulation ECP/sÃ©cu sociale\nâ€¢ Collaboration Paradigm/Athumi : infrastructure Solid\nâ€¢ Concertation syndicats et mutuelles\nâ€¢ Auditions parlementaires",
            sans: "â€¢ Projet pilote ARC : preuve de concept avec 24 000 â‚¬\nâ€¢ DÃ©ploiement technique autonome (Sensor.community, Solid, Decidim)\nâ€¢ Production de ressources Ã©ducatives et guides\nâ€¢ Constitution d'un Ã©cosystÃ¨me de 100+ contributeurs\nâ€¢ Documentation open source rÃ©plicable",
            contre: "â€¢ Recours juridiques si ruling dÃ©favorable (Conseil d'Ã‰tat, Cour Constitutionnelle)\nâ€¢ Campagne de dÃ©nonciation du piÃ¨ge institutionnel (1 Mâ‚¬/heure)\nâ€¢ Mobilisation citoyenne (pÃ©titions, actions symboliques)\nâ€¢ Interpellation europÃ©enne (Pilier social)\nâ€¢ Alliance avec opposition parlementaire"
        };
        project.cibles = {
            principales: "ğŸ¯ CIBLE PRINCIPALE : SERVICE DES DÃ‰CISIONS ANTICIPÃ‰ES (SDA)\n\nSeule autoritÃ© habilitÃ©e Ã  dÃ©livrer un RULING FISCAL sÃ©curisant l'ECP.\n\nSTRATÃ‰GIE :\n1. Dossier IMPECCABLEMENT documentÃ©\n2. DÃ©montrer l'ALIGNEMENT avec objectifs Arizona\n3. PrÃ©senter le PROVISIONNEMENT DIFFÃ‰RÃ‰ comme non-revenu\n4. Solliciter validation ABSENCE D'ABUS (Art. 344 CIR 92)",
            secondaires: "â€¢ Cabinet Vandenbroucke : ministre socialiste potentiellement sensible\nâ€¢ ONSS : confirmation absence de subordination\nâ€¢ Services emploi (Forem, Actiris, VDAB) : reconnaissance activitÃ© ECP\nâ€¢ Commissions parlementaires : visibilitÃ© politique\nâ€¢ MÃ©dias (Le Soir, L'Ã‰cho) : lÃ©gitimation du modÃ¨le",
            allies: "â€¢ Syndicats (FGTB, CSC) : services juridiques, mobilisation\nâ€¢ Mutuelles (Solidaris, MC) : expertise santÃ©, Pont Social FHIR\nâ€¢ FÃ©dÃ©rations CPAS (UVCW, Brulocalis) : relais institutionnels\nâ€¢ Gestionnaires donnÃ©es (Paradigm, Athumi) : infrastructure Solid\nâ€¢ UniversitÃ©s (DULBEA, IWEPS) : caution acadÃ©mique\nâ€¢ Opposition (PS, Ã‰colo, PTB) : relais parlementaire"
        };
        project.message = {
            accroche: "Â« En Belgique, l'inactivitÃ© forcÃ©e coÃ»te 1 MILLION D'EUROS PAR HEURE.\n\n978 000 personnes sont PAYÃ‰ES pour ne rien faire.\nPas parce qu'elles le veulent.\nMais parce que le systÃ¨me les PUNIT dÃ¨s qu'elles essaient de contribuer.\n\n24 000 â‚¬ pour prouver qu'une alternative existe.\nContre 21 milliards de dÃ©penses passives par an. Â»",
            probleme: "Le systÃ¨me social belge souffre d'un PIÃˆGE INSTITUTIONNEL absurde :\nâ€¢ Il INDEMNISE l'inactivitÃ© totale (21-24 milliards â‚¬/an)\nâ€¢ Mais il PÃ‰NALISE toute tentative de contribution\n\nTaux marginal > 100% : chaque euro gagnÃ© fait perdre le statut BIM, puis les tarifs sociaux.\n\nRÃ©sultat : Il est Ã‰CONOMIQUEMENT RATIONNEL de rester inactif.",
            importance: "Sans action immÃ©diate :\nâ€¢ DÃ©ficit sÃ©cu sociale EXPLOSERA (24,1 Mdâ‚¬ en 2028)\nâ€¢ RÃ©formes Arizona AGGRAVERONT le piÃ¨ge\nâ€¢ Capital humain continuera de se DÃ‰GRADER\nâ€¢ FenÃªtre d'opportunitÃ© se FERMERA\n\nL'ECP n'est pas une utopie. C'est une SOLUTION PRAGMATIQUE.",
            cible: "â€¢ Au SDA : Vous avez le pouvoir de SÃ‰CURISER l'innovation sociale par un simple ruling.\nâ€¢ Au Ministre Vandenbroucke : L'ECP valorise le travail SANS sanctionner les prÃ©caires.\nâ€¢ Aux syndicats et mutuelles : L'ECP offre une voie de sortie SANS perdre vos protections.\nâ€¢ Ã€ l'opinion publique : Les allocataires sont EMPÃŠCHÃ‰S de contribuer par un systÃ¨me absurde.",
            action: "1ï¸âƒ£ RULING FISCAL FAVORABLE du SDA\n2ï¸âƒ£ CIRCULAIRE ADMINISTRATIVE clarifiant maintien BIM\n3ï¸âƒ£ PARTENARIAT INSTITUTIONNEL pour le projet pilote\n4ï¸âƒ£ FINANCEMENT INITIAL de 24 000 â‚¬ pour l'ARC\n\n#EconomieContributive #RulingFiscal #SouveraineteCitoyenne"
        };
        project.evaluation = {
            indicateurs: "QUANTITATIFS :\nâ€¢ DÃ©cision ruling fiscal (favorable/dÃ©favorable)\nâ€¢ Nombre de contributeurs pilote ARC (cible : 100+)\nâ€¢ Valeur sociale gÃ©nÃ©rÃ©e (cible : 50 000 â‚¬ provisionnÃ©s)\nâ€¢ Partenariats formalisÃ©s (cible : 3+ conventions)\nâ€¢ Couverture mÃ©diatique (cible : 5+ articles)\nâ€¢ Maintien droits sociaux (cible : 100% contributeurs)\n\nQUALITATIFS :\nâ€¢ QualitÃ© documentation juridique\nâ€¢ Satisfaction contributeurs (> 4/5)\nâ€¢ IntÃ©rÃªt dÃ©cideurs politiques",
            methodes: "â€¢ Suivi dossier ruling (contact SDA, journal Ã©changes)\nâ€¢ Tableau de bord contributeurs (chartes, missions, statut social)\nâ€¢ Documentation contributions (Git Scraping)\nâ€¢ Veille mÃ©dia et politique\nâ€¢ EnquÃªtes trimestrielles contributeurs\nâ€¢ Ã‰valuation d'impact acadÃ©mique (DULBEA/IWEPS)",
            calendrier: "T1 2026 : DÃ©pÃ´t ruling, mandatement avocat\nT2 2026 : Lancement pilote ARC, 50 contributeurs\nT3 2026 : 100 contributeurs, Ã©tude d'impact publiÃ©e\nT4 2026 : DÃ©cision ruling attendue, bilan pilote\n2027 : Si favorable â†’ dÃ©ploiement / Si dÃ©favorable â†’ recours",
            lecons: "Ã€ DOCUMENTER :\nâ€¢ Quels arguments ont convaincu le SDA ?\nâ€¢ Quel profil de contributeurs s'engage le plus ?\nâ€¢ Quels partenaires ont Ã©tÃ© les plus rÃ©actifs ?\nâ€¢ Comment contrer l'accusation d'optimisation fiscale ?\nâ€¢ Solid/FHIR sont-ils utilisables par les non-techniciens ?\nâ€¢ Quelles compÃ©tences ont manquÃ© ?"
        };
        project.smart = [
            { id: 1, text: "Obtenir un RULING FISCAL FAVORABLE du SDA validant le provisionnement diffÃ©rÃ©", indicator: "DÃ©cision anticipÃ©e Ã©crite confirmant non-revenu immÃ©diat", deadline: "2026-10-31", status: "todo", done: false },
            { id: 2, text: "Lancer le projet pilote ARC avec 100+ contributeurs actifs", indicator: "100 personnes avec charte signÃ©e et missions documentÃ©es", deadline: "2026-12-15", status: "todo", done: false },
            { id: 3, text: "Documenter une Ã‰CONOMIE POTENTIELLE chiffrÃ©e (Ã©tude d'impact)", indicator: "Rapport acadÃ©mique DULBEA/IWEPS quantifiant ROI social", deadline: "2026-09-30", status: "inprogress", done: false },
            { id: 4, text: "SÃ©curiser un PARTENARIAT TECHNIQUE avec Paradigm ou Athumi", indicator: "Convention signÃ©e pour accÃ¨s Pod Solid", deadline: "2026-06-30", status: "inprogress", done: false },
            { id: 5, text: "Obtenir une COUVERTURE MÃ‰DIATIQUE positive dans 3+ mÃ©dias", indicator: "Articles dans Le Soir, L'Ã‰cho, Trends ou RTBF", deadline: "2026-09-15", status: "todo", done: false }
        ];
        project.journal = [
            { id: 1, date: new Date().toISOString().split('T')[0], content: "ğŸš€ CrÃ©ation du projet ECP. Objectif : sÃ©curiser juridiquement l'Ã‰conomie Contributive ProvisionnÃ©e via ruling fiscal SDA." }
        ];
    }
    
    await dbPut(project);
    await selectProject(project.id);
    toast('Projet crÃ©Ã© Ã  partir du modÃ¨le', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELP SYSTEM â€” Non-invasif
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showHelp(key, anchorEl) {
    const h = HELP[key];
    if (!h) return;
    
    $('help-title').textContent = h.title;
    $('help-content').innerHTML = h.content;
    
    const tooltip = $('help-tooltip');
    tooltip.classList.add('show');
    
    // Position near anchor
    if (anchorEl) {
        const rect = anchorEl.getBoundingClientRect();
        tooltip.style.top = Math.min(rect.bottom + 8, window.innerHeight - 300) + 'px';
        tooltip.style.left = Math.min(rect.left, window.innerWidth - 340) + 'px';
    } else {
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
    }
}

function hideHelp() {
    $('help-tooltip').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toast(message, type = 'info') {
    const container = $('toasts');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = message;
    container.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
    await openDB();
    await renderProjects();
    
    // Set default date for journal
    $('journal-date').value = new Date().toISOString().split('T')[0];
    
    // Check if any project exists
    const projects = await dbGetAll();
    if (projects.length) {
        await selectProject(projects[0].id);
    } else {
        showPage('empty');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EVENT LISTENERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Menu mobile
    $('btn-menu').addEventListener('click', () => {
        $('sidebar').classList.toggle('open');
        $('sidebar-overlay').classList.toggle('open');
    });
    $('sidebar-overlay').addEventListener('click', () => {
        $('sidebar').classList.remove('open');
        $('sidebar-overlay').classList.remove('open');
    });
    
    // Navigation
    $$('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            if (e.target.classList.contains('hint-trigger')) return;
            const page = btn.dataset.page;
            if (!P && !['empty', 'export', 'ressources'].includes(page)) {
                toast('CrÃ©ez d\'abord un projet', 'warning');
                return;
            }
            showPage(page);
        });
    });
    
    // Phase cards navigation
    $$('[data-goto]').forEach(card => {
        card.addEventListener('click', () => {
            if (!P) return toast('CrÃ©ez d\'abord un projet', 'warning');
            showPage(card.dataset.goto);
        });
    });
    
    // Field auto-save
    $$('[data-field]').forEach(el => {
        el.addEventListener('input', () => {
            if (!P) return;
            const [section, key] = el.dataset.field.split('.');
            if (!P[section]) P[section] = {};
            P[section][key] = el.value;
            if (section === 'message') updateMessagePreview();
            scheduleSave();
            updateStats();
        });
    });
    
    // Buttons
    $('btn-add-actor').addEventListener('click', addActor);
    $('btn-add-smart').addEventListener('click', addSmart);
    $('btn-add-journal').addEventListener('click', addJournal);
    
    $('btn-copy-message').addEventListener('click', () => {
        navigator.clipboard.writeText($('message-preview').textContent);
        toast('Message copiÃ© !', 'success');
    });
    
    // New project
    $('btn-new-project').addEventListener('click', () => openModal('modal-create'));
    $('btn-empty-new').addEventListener('click', () => openModal('modal-create'));
    $('btn-create-confirm').addEventListener('click', async () => {
        const name = $('create-name').value.trim();
        if (!name) return toast('Entrez un nom', 'error');
        const project = newProject(name, $('create-desc').value.trim());
        await dbPut(project);
        await selectProject(project.id);
        closeModal('modal-create');
        $('create-name').value = '';
        $('create-desc').value = '';
        toast('Projet crÃ©Ã© !', 'success');
    });
    
    // Templates
    $('btn-templates').addEventListener('click', () => showPage('empty'));
    $$('[data-tpl]').forEach(card => card.addEventListener('click', () => loadTemplate(card.dataset.tpl)));
    
    // Export
    $$('[data-export]').forEach(card => card.addEventListener('click', () => doExport(card.dataset.export)));
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CARTOGRAPHIE INTERACTIVE - Event Listeners
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Onglets de vue acteurs
    $$('.view-tab').forEach(tab => {
        tab.addEventListener('click', () => switchActorView(tab.dataset.view));
    });
    
    // Types de liens
    $$('.link-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            $$('.link-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentLinkType = btn.dataset.type;
        });
    });
    
    // Ajouter un lien
    const btnAddLink = $('btn-add-link');
    if (btnAddLink) btnAddLink.addEventListener('click', addLink);
    
    // ContrÃ´les du graphe rÃ©seau
    const btnNetworkFit = $('btn-network-fit');
    if (btnNetworkFit) btnNetworkFit.addEventListener('click', () => {
        if (networkInstance) networkInstance.fit();
    });
    
    const btnNetworkFullscreen = $('btn-network-fullscreen');
    if (btnNetworkFullscreen) btnNetworkFullscreen.addEventListener('click', () => {
        const container = $('network-container');
        if (container) {
            container.classList.toggle('fullscreen');
            if (networkInstance) {
                setTimeout(() => networkInstance.fit(), 100);
            }
        }
    });
    
    const btnNetworkExport = $('btn-network-export');
    if (btnNetworkExport) btnNetworkExport.addEventListener('click', () => {
        if (!networkInstance) return;
        const canvas = document.querySelector('#network-graph canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = `cartographie_acteurs_${P?.meta?.name?.replace(/[^a-z0-9]/gi, '_') || 'projet'}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            toast('Image exportÃ©e', 'success');
        }
    });
    
    // Ã‰chap pour sortir du plein Ã©cran
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const container = $('network-container');
            if (container?.classList.contains('fullscreen')) {
                container.classList.remove('fullscreen');
                if (networkInstance) networkInstance.fit();
            }
        }
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART KANBAN/TIMELINE/GANTT - Event Listeners
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Onglets de vue SMART
    $$('[data-smart-view]').forEach(tab => {
        tab.addEventListener('click', () => switchSmartView(tab.dataset.smartView));
    });
    
    // Initialiser Mermaid
    if (typeof mermaid !== 'undefined') {
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark'
        });
    }
    
    // Import
    const handleImport = (e) => {
        const file = e.target.files?.[0];
        if (file) importJSON(file);
    };
    $('import-file').addEventListener('change', handleImport);
    $('import-home').addEventListener('change', handleImport);
    
    // Drop zone
    const dropZone = $('drop-zone');
    dropZone.addEventListener('click', () => $('import-file').click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) importJSON(file);
    });
    
    // Modals close
    $$('[data-close]').forEach(btn => {
        btn.addEventListener('click', () => closeModal(btn.dataset.close));
    });
    $$('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) overlay.classList.remove('open');
        });
    });
    
    // Search
    $('btn-search').addEventListener('click', () => openModal('modal-search'));
    $('search-input').addEventListener('input', () => {
        // Simple search implementation
        const q = $('search-input').value.toLowerCase().trim();
        if (!q || !P) { $('search-results').innerHTML = ''; return; }
        
        const results = [];
        const search = (obj, path) => {
            if (!obj) return;
            Object.entries(obj).forEach(([k, v]) => {
                if (typeof v === 'string' && v.toLowerCase().includes(q)) {
                    results.push({ path: path + '.' + k, text: v.substring(0, 80) });
                }
            });
        };
        ['domino', 'profil', 'fleur', 'arbre', 'swot', 'tdc', 'pouvoir', 'cibles', 'message', 'evaluation'].forEach(k => search(P[k], k));
        
        if (!results.length) {
            $('search-results').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:var(--space-4);">Aucun rÃ©sultat</p>';
        } else {
            $('search-results').innerHTML = results.slice(0, 8).map(r => `
                <div style="padding:var(--space-3);border-bottom:1px solid var(--border-subtle);cursor:pointer;" data-goto="${r.path.split('.')[0]}">
                    <strong style="color:var(--mint-300);">${r.path}</strong><br>
                    <span style="color:var(--text-muted);font-size:0.85rem;">${esc(r.text)}...</span>
                </div>
            `).join('');
            $('search-results').querySelectorAll('[data-goto]').forEach(el => {
                el.addEventListener('click', () => {
                    showPage(el.dataset.goto);
                    closeModal('modal-search');
                });
            });
        }
    });
    
    // Help system
    $$('.hint-trigger, .help-icon').forEach(el => {
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            showHelp(el.dataset.help, el);
        });
    });
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.help-tooltip') && !e.target.closest('.hint-trigger') && !e.target.closest('.help-icon')) {
            hideHelp();
        }
    });
    
    // Shortcuts
    $('btn-shortcuts').addEventListener('click', () => openModal('modal-shortcuts'));
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            openModal('modal-search');
            $('search-input').focus();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            if (P) { scheduleSave(); toast('SauvegardÃ©', 'success'); }
        }
        if (e.key === 'Escape') {
            $$('.modal-overlay.open').forEach(m => m.classList.remove('open'));
            hideHelp();
        }
    });
    
    console.log('#B!Mi Plaidoyer Citoyen v4.4 PWA â€” Ready');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA - PROGRESSIVE WEB APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/*
 * NOTE: Le Service Worker nÃ©cessite un hÃ©bergement HTTPS pour fonctionner.
 * En mode fichier local (file://), seules les fonctionnalitÃ©s suivantes sont actives:
 * - Stockage IndexedDB (fonctionne dÃ©jÃ )
 * - Installation PWA (si hÃ©bergÃ©)
 * - IcÃ´nes et manifest
 * 
 * Pour activer le mode hors-ligne complet:
 * 1. HÃ©berger ce fichier sur un serveur HTTPS
 * 2. CrÃ©er un fichier sw.js avec le code ci-dessous
 * 3. DÃ©commenter l'enregistrement du SW
 */

// Service Worker Code (Ã  sauvegarder dans sw.js si hÃ©bergement serveur)
const SW_CODE_FOR_HOSTING = `
// sw.js - Service Worker pour #B!Mi Plaidoyer Citoyen
const CACHE_NAME = 'bimi-plaidoyer-v4.4';

const PRECACHE = ['./', './index.html'];

const CDN_CACHE = [
    'unpkg.com/docx',
    'unpkg.com/vis-network',
    'unpkg.com/mermaid',
    'fonts.googleapis.com',
    'fonts.gstatic.com'
];

self.addEventListener('install', e => {
    e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(PRECACHE)).then(() => self.skipWaiting()));
});

self.addEventListener('activate', e => {
    e.waitUntil(caches.keys().then(keys => 
        Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))
    ).then(() => self.clients.claim()));
});

self.addEventListener('fetch', e => {
    if (e.request.method !== 'GET') return;
    e.respondWith(
        caches.match(e.request).then(cached => {
            const fetched = fetch(e.request).then(resp => {
                if (resp.ok) {
                    const clone = resp.clone();
                    caches.open(CACHE_NAME).then(c => c.put(e.request, clone));
                }
                return resp;
            }).catch(() => cached || new Response('Offline', {status: 503}));
            return cached || fetched;
        })
    );
});
`;

// VÃ©rifier si on est sur un serveur web (pas file://)
const isHosted = window.location.protocol.startsWith('http');

// Register Service Worker (uniquement si hÃ©bergÃ© sur serveur)
async function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) {
        console.log('[PWA] Service Worker non supportÃ©');
        return;
    }
    
    if (!isHosted) {
        console.log('[PWA] Mode fichier local - Service Worker dÃ©sactivÃ©');
        console.log('[PWA] Pour le mode hors-ligne complet, hÃ©bergez ce fichier sur un serveur HTTPS');
        return;
    }
    
    try {
        // Essayer d'enregistrer sw.js s'il existe
        const registration = await navigator.serviceWorker.register('./sw.js', { scope: './' });
        console.log('[PWA] Service Worker enregistrÃ©:', registration.scope);
        
        registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    showUpdateNotification();
                }
            });
        });
    } catch (error) {
        // SW non trouvÃ© - normal si pas de fichier sw.js
        console.log('[PWA] Service Worker non disponible (sw.js absent ou erreur)');
        console.log('[PWA] CrÃ©ez un fichier sw.js pour activer le mode hors-ligne');
    }
}

// Show update notification
function showUpdateNotification() {
    if (confirm('Une nouvelle version est disponible. Recharger ?')) {
        window.location.reload();
    }
}

// PWA Install Prompt
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    showInstallButton();
    console.log('[PWA] Installation disponible');
});

function showInstallButton() {
    const header = document.querySelector('.header-actions');
    if (header && !document.getElementById('btn-install-pwa')) {
        const btn = document.createElement('button');
        btn.id = 'btn-install-pwa';
        btn.className = 'btn btn-secondary';
        btn.innerHTML = 'ğŸ“² Installer';
        btn.title = 'Installer l\'application sur votre appareil';
        btn.style.cssText = 'font-size:0.8rem;padding:6px 12px;';
        btn.onclick = installPWA;
        header.insertBefore(btn, header.firstChild);
    }
}

async function installPWA() {
    if (!deferredPrompt) {
        toast('L\'application est dÃ©jÃ  installÃ©e ou l\'installation n\'est pas disponible en mode fichier local', 'info');
        return;
    }
    
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
        toast('Application installÃ©e ! ğŸ‰', 'success');
        const btn = document.getElementById('btn-install-pwa');
        if (btn) btn.remove();
    }
    
    deferredPrompt = null;
}

// Check if app is installed
window.addEventListener('appinstalled', () => {
    deferredPrompt = null;
    const btn = document.getElementById('btn-install-pwa');
    if (btn) btn.remove();
    console.log('[PWA] Application installÃ©e avec succÃ¨s');
});

// Online/Offline status
window.addEventListener('online', () => {
    toast('Connexion rÃ©tablie', 'success');
    document.body.classList.remove('offline');
});

window.addEventListener('offline', () => {
    toast('Mode hors-ligne â€” Les donnÃ©es sont sauvegardÃ©es localement', 'warning');
    document.body.classList.add('offline');
});

// Initialize PWA on load
window.addEventListener('load', () => {
    // Tenter d'enregistrer le SW si on est sur un serveur
    if (isHosted) {
        registerServiceWorker();
    }
    
    // Check if running as installed PWA
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('[PWA] Mode application standalone');
        document.body.classList.add('pwa-standalone');
    }
    
    // Offline indicator
    if (!navigator.onLine) {
        document.body.classList.add('offline');
    }
    
    // Log storage info
    if (navigator.storage && navigator.storage.estimate) {
        navigator.storage.estimate().then(({ usage, quota }) => {
            console.log(`[PWA] Stockage: ${(usage / 1024 / 1024).toFixed(2)} MB / ${(quota / 1024 / 1024).toFixed(2)} MB`);
        });
    }
});

// Start
document.addEventListener('DOMContentLoaded', init);
</script>

</body></html>
